/* FILE: /app/vendor/jszip.min.js
   RControl Factory — VENDOR: JSZip LOADER (v1.0 SAFE)
   Objetivo:
   - Disponibilizar window.JSZip para o zip_vault.js
   - SEM colar a lib gigante aqui no chat (iPhone-safe)
   - 1º tenta cache local (localStorage)
   - 2º tenta baixar de CDN (uma vez), salvar no cache local e avaliar
   - 3º se falhar, loga erro claro

   OBS:
   - Precisa de internet na PRIMEIRA vez pra baixar do CDN.
   - Depois disso roda offline porque fica cacheado em localStorage.
*/
(function () {
  "use strict";

  if (window.JSZip) return;
  if (window.__RCF_JSZIP_LOADER__) return;
  window.__RCF_JSZIP_LOADER__ = true;

  const LS_KEY = "rcf:vendor:jszip:min";
  const LS_META = "rcf:vendor:jszip:meta";

  function log(level, msg) {
    try { window.RCF_LOGGER?.push?.(level, msg); } catch {}
    try { console.log("[RCF_JSZIP]", level, msg); } catch {}
  }

  function safeEval(code) {
    // eslint-disable-next-line no-new-func
    const fn = new Function(code);
    fn();
    return !!window.JSZip;
  }

  function fromLocalCache() {
    try {
      const code = localStorage.getItem(LS_KEY) || "";
      if (!code || code.length < 5000) return false;

      const ok = safeEval(code);
      if (ok) {
        const meta = localStorage.getItem(LS_META) || "";
        log("OK", "JSZip carregado do cache local ✅ " + (meta ? "(" + meta + ")" : ""));
        return true;
      }
      return false;
    } catch (e) {
      log("WARN", "Cache local falhou: " + (e?.message || e));
      return false;
    }
  }

  async function fetchText(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  }

  async function fromCDN() {
    // Pin de versão (estável)
    const CDN_LIST = [
      "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js",
      "https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"
    ];

    for (const url of CDN_LIST) {
      try {
        log("INFO", "Baixando JSZip… " + url);
        const code = await fetchText(url);

        if (!code || code.length < 5000) throw new Error("Conteúdo inválido (curto demais)");

        // valida antes de salvar
        const ok = safeEval(code);
        if (!ok) throw new Error("Eval não expôs window.JSZip");

        try {
          localStorage.setItem(LS_KEY, code);
          localStorage.setItem(LS_META, "cachedFrom=" + url + " at=" + new Date().toISOString());
        } catch (e) {
          log("WARN", "Não consegui salvar no localStorage (mas JSZip já está carregado): " + (e?.message || e));
        }

        log("OK", "JSZip baixado e carregado ✅");
        return true;
      } catch (e) {
        log("WARN", "Falhou CDN: " + url + " :: " + (e?.message || e));
      }
    }

    return false;
  }

  async function boot() {
    try {
      if (fromLocalCache()) return;

      const ok = await fromCDN();
      if (ok) return;

      log("ERR", "JSZip NÃO disponível. Conecte na internet 1x pra cachear, ou cole a lib localmente.");
    } catch (e) {
      log("ERR", "JSZip loader fatal: " + (e?.message || e));
    }
  }

  // inicia sem travar o boot
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => { boot(); }, { once: true });
  } else {
    boot();
  }
})();
