<!-- FILE: app/index.html
     RCF — SAFE BOOT (auto-boot silencioso) v1.4
     ✅ Entra direto na Factory (sem flash)
     ✅ SAFE BOOT só aparece em emergência
     ✅ Watchdog 2500ms
-->

<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RCF</title>
  <meta name="theme-color" content="#0b1020" />
  <base href="./" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
  <meta name="rcf-index" content="SAFE_BOOT_AUTO_2026_02_24_v1_4" />

  <style>
    body{background:#0b1020;color:#eaf0ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .rcf_safe{max-width:920px;margin:0 auto;padding:14px}
    .rcf_card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;margin:12px 0}
    .rcf_btn{border:0;border-radius:999px;padding:10px 12px;font-weight:800;margin:6px 8px 0 0}
    .r{background:#ff4d4d;color:#111}
    .g{background:#35d0b5;color:#111}
    .d{background:rgba(255,255,255,.12);color:#eaf0ff;border:1px solid rgba(255,255,255,.18)}
    pre{white-space:pre-wrap;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);min-height:140px}
  </style>
</head>

<body>
  <noscript>Ative o JavaScript para usar o app.</noscript>

  <div id="app">
    <!-- COMEÇA OCULTO -->
    <div class="rcf_safe" id="rcfSafeBootUI" style="display:none">
      <h2>RCF • SAFE BOOT</h2>

      <div class="rcf_card">
        <button class="rcf_btn r" id="u">Unregister SW</button>
        <button class="rcf_btn r" id="c">Clear Caches</button>
        <button class="rcf_btn d" id="k">Show SW status</button>
        <button class="rcf_btn g" id="boot">Boot normal agora</button>
      </div>

      <div class="rcf_card">
        <div><b>Log</b></div>
        <pre id="log">starting…</pre>
      </div>
    </div>
  </div>

<script>
(function(){

  const L  = document.getElementById("log");
  const UI = document.getElementById("rcfSafeBootUI");
  const ts = ()=> new Date().toISOString();
  const log = (...a)=>{ try{ L.textContent += "\n" + a.join(" "); }catch{} };

  let uiReady = false;
  let bootFinished = false;

  const params = new URLSearchParams(location.search || "");
  const forceSafe = (params.get("safe") === "1");

  function showSafe(reason){
    if (!UI) return;
    UI.style.display = "block";
    log("SAFE MODE:", reason);
  }

  async function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s = document.createElement("script");
      s.src = src + "?cb=" + Date.now();
      s.async = false;
      s.onload = ()=> resolve(src);
      s.onerror = ()=> reject(new Error("load failed: " + src));
      document.head.appendChild(s);
    });
  }

  async function bootNormal(){

    if (window.__RCF_SAFE_BOOTING__) return;
    window.__RCF_SAFE_BOOTING__ = true;

    log("[" + ts() + "] bootNormal…");

    const modules = [
      "./js/core/logger.js",
      "./js/core/stability_guard.js",
      "./js/core/storage.js",
      "./js/core/github_sync.js",
      "./js/core/vfs_overrides.js",
      "./js/core/vfs_shim.js",
      "./js/core/mother_selfupdate.js",
      "./js/core/errors.js",
      "./js/core/ui_safety.js",
      "./js/core/ui_compact_outputs.js",
      "./js/core/ui_bindings.js",
      "./js/core/diagnostics.js",
      "./js/core/preview_runner.js",
      "./js/core/injector.js",
      "./js/engine/template_registry.js",
      "./js/engine/module_registry.js",
      "./js/engine/builder.js",
      "./js/engine/engine.js",
      "./js/core/pages_links.js",
      "./js/admin.github.js",
      "./app.js",
      "./js/core/zip_vault.js",
      "./js/core/agent_zip_bridge.js"
    ];

    let fails = 0;

    for (const src of modules){
      try{
        await loadScript(src);
      }catch(e){
        fails++;
        log("failed:", src);
      }
    }

    bootFinished = true;

    if (fails > 0){
      showSafe("boot errors (" + fails + ")");
    }
  }

  // UI READY EVENT
  window.addEventListener("RCF:UI_READY", ()=>{
    uiReady = true;
    if (UI) UI.style.display = "none";
  });

  // WATCHDOG 2500ms
  setTimeout(()=>{
    if (!uiReady && !forceSafe){
      showSafe("UI_READY timeout");
    }
  }, 2500);

  // FORCE SAFE
  if (forceSafe){
    showSafe("?safe=1 forced");
  }else{
    setTimeout(()=> bootNormal(), 80);
  }

})();
</script>

</body>
</html>
