<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RCF</title>
  <meta name="theme-color" content="#0b1020" />
  <base href="./" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
  <meta name="rcf-index" content="SAFE_BOOT_AUTO_2026_02_23b" />
  <style>
    body{background:#0b1020;color:#eaf0ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .rcf_safe{max-width:920px;margin:0 auto;padding:14px}
    .rcf_card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;margin:12px 0}
    .rcf_btn{border:0;border-radius:999px;padding:10px 12px;font-weight:800;margin:6px 8px 0 0}
    .r{background:#ff4d4d;color:#111}
    .g{background:#35d0b5;color:#111}
    .d{background:rgba(255,255,255,.12);color:#eaf0ff;border:1px solid rgba(255,255,255,.18)}
    pre{
      white-space:pre-wrap;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);
      min-height:160px;max-height:42vh;overflow:auto;-webkit-overflow-scrolling:touch
    }
    code{background:rgba(255,255,255,.10);padding:2px 6px;border-radius:8px}
    .muted{opacity:.88}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-weight:800}
  </style>
</head>

<body>
  <noscript>Ative o JavaScript para usar o app.</noscript>

  <div id="app">
    <div class="rcf_safe" id="rcfSafeRoot">
      <h2>RCF â€¢ SAFE BOOT (AUTO)</h2>

      <div class="rcf_card">
        <div><b>Objetivo:</b> sair da tela preta e recuperar o controle.</div>
        <div class="muted" style="margin-top:6px">
          Agora o SAFE BOOT tenta <b>dar boot normal automaticamente</b>.
          <br/>
          Pra ficar aqui manual: abra <code>/app/?safe=1</code>.
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill" id="pMode">mode: â€¦</span>
          <span class="pill" id="pUI">ui: â€¦</span>
        </div>

        <button class="rcf_btn r" id="u">Unregister SW</button>
        <button class="rcf_btn r" id="c">Clear Caches</button>
        <button class="rcf_btn d" id="k">Show SW status</button>
        <button class="rcf_btn g" id="boot">Boot normal agora</button>
      </div>

      <div class="rcf_card">
        <div><b>Log</b></div>
        <pre id="log">startingâ€¦</pre>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const L = document.getElementById("log");
    const safeRoot = document.getElementById("rcfSafeRoot");
    const pMode = document.getElementById("pMode");
    const pUI = document.getElementById("pUI");

    const log = (...a)=>{ try{ L.textContent += "\n" + a.join(" "); }catch{} };
    const ts = ()=> new Date().toISOString();

    const qs = new URLSearchParams(location.search || "");
    const SAFE_LOCK = (qs.get("safe") === "1");

    function setPill(el, txt){ try{ el.textContent = txt; }catch{} }

    function hideSafe(reason){
      try {
        setPill(pUI, "ui: READY âœ…");
        log("[" + ts() + "] SAFE overlay hide âœ… reason=" + reason);
      } catch {}

      // remove de verdade pra nÃ£o bloquear touch/scroll
      try { safeRoot.style.pointerEvents = "none"; } catch {}
      try { safeRoot.style.display = "none"; } catch {}
      try { safeRoot.remove(); } catch {}
    }

    log("[" + ts() + "] SAFE_BOOT_AUTO loaded âœ… base=" + document.baseURI);
    setPill(pMode, SAFE_LOCK ? "mode: SAFE (lock)" : "mode: AUTO");
    setPill(pUI, "ui: waitingâ€¦");

    // ðŸ”¥ PRINCIPAL: evento real da Factory (app.js / ui bus)
    // quando disparar, some na hora
    try {
      window.addEventListener("RCF:UI_READY", function(){
        hideSafe("event RCF:UI_READY");
      }, { once: true });
    } catch {}

    async function unreg(){
      try{
        if(!("serviceWorker" in navigator)){ log("no SW support"); return; }
        const regs = await navigator.serviceWorker.getRegistrations();
        let ok=0;
        for(const r of regs){ try{ if(await r.unregister()) ok++; }catch(e){} }
        log("unregister ok=" + ok + " regs=" + regs.length);
      }catch(e){ log("unregister err", (e && e.message) ? e.message : String(e)); }
    }

    async function clearCaches(){
      try{
        if(!("caches" in window)){ log("no caches API"); return; }
        const keys = await caches.keys();
        let del=0;
        for(const k of keys){ try{ if(await caches.delete(k)) del++; }catch(e){} }
        log("caches deleted=" + del + " keys=" + keys.length);
      }catch(e){ log("caches err", (e && e.message) ? e.message : String(e)); }
    }

    async function swStatus(){
      try{
        const has = ("serviceWorker" in navigator);
        log("sw supported=" + has);
        if(!has) return;
        log("controller=" + (!!navigator.serviceWorker.controller));
        const regs = await navigator.serviceWorker.getRegistrations();
        log("regs=" + regs.length);
        for (const r of regs) {
          try{ log(" - scope=" + (r.scope||"") ); }catch{}
        }
      }catch(e){ log("status err", (e && e.message) ? e.message : String(e)); }
    }

    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = src + (src.includes("?") ? "&" : "?") + "cb=" + Date.now();
        s.async = false;
        s.onload = ()=> resolve(src);
        s.onerror = ()=> reject(new Error("load failed: " + src));
        document.head.appendChild(s);
      });
    }

    async function bootNormal(){
      log("[" + ts() + "] bootNormalâ€¦");
      const modules = [
        "./js/core/logger.js",
        "./js/core/stability_guard.js",
        "./js/core/storage.js",
        "./js/core/github_sync.js",
        "./js/core/vfs_overrides.js",
        "./js/core/vfs_shim.js",
        "./js/core/mother_selfupdate.js",
        "./js/core/errors.js",
        "./js/core/ui_safety.js",
        "./js/core/ui_compact_outputs.js",
        "./js/core/ui_bindings.js",
        "./js/core/diagnostics.js",
        "./js/core/preview_runner.js",
        "./js/core/injector.js",
        "./js/engine/template_registry.js",
        "./js/engine/module_registry.js",
        "./js/engine/builder.js",
        "./js/engine/engine.js",
        "./js/core/pages_links.js",
        "./js/admin.github.js",
        "./app.js",
        "./js/core/zip_vault.js",
        "./js/core/agent_zip_bridge.js",
        "./js/core/doctor_scan.js"
      ];

      for (const src of modules) {
        try { await loadScript(src); log("loaded âœ…", src); }
        catch(e){ log("failed âŒ", src, "::", (e && e.message) ? e.message : String(e)); }
      }

      log("[" + ts() + "] bootNormal finished.");
      try { window.__RCF_SAFE_BOOT_DONE__ = true; } catch {}
    }

    // fallback: polling (caso o evento nÃ£o dispare por algum motivo)
    function watchUI(){
      const start = Date.now();
      const timer = setInterval(()=>{
        const uiReady = !!window.__RCF_UI_READY__;
        setPill(pUI, uiReady ? "ui: READY âœ…" : "ui: loadingâ€¦");

        if (uiReady) {
          clearInterval(timer);
          hideSafe("__RCF_UI_READY__");
          return;
        }

        if (Date.now() - start > 12000) {
          clearInterval(timer);
          setPill(pUI, "ui: timeout (safe stays)");
          log("[" + ts() + "] UI not ready after 12s â€” keeping SAFE visible.");
        }
      }, 250);
    }

    document.getElementById("u").onclick = unreg;
    document.getElementById("c").onclick = clearCaches;
    document.getElementById("k").onclick = swStatus;
    document.getElementById("boot").onclick = ()=>{ bootNormal(); watchUI(); };

    swStatus();

    if (!SAFE_LOCK) {
      setTimeout(()=>{
        bootNormal();
        watchUI();
      }, 150);
    } else {
      log("[" + ts() + "] SAFE LOCK ativo (?safe=1). Auto-boot desativado.");
    }
  })();
  </script>
</body>
</html>
