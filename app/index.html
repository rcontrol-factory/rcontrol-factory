<!-- FILE: /app/index.html
     RControl Factory — RESCUE MODE (não carrega app.js)
     Objetivo: destravar iOS/SW/cache e te dar botões de recuperação.
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RCF • RESCUE</title>
  <base href="./" />
  <meta name="theme-color" content="#0b1020" />
  <style>
    body{margin:0;background:#070b12;color:#fff;font-family:system-ui}
    .wrap{max-width:860px;margin:0 auto;padding:18px}
    .card{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;background:rgba(255,255,255,.04)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(20,28,44,.92);color:#fff;font-weight:800}
    .btn.ok{background:#2dd4bf;color:#022;border:0}
    .btn.danger{background:#ef4444;border:0}
    pre{white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:12px;max-height:55vh;overflow:auto}
    .hint{opacity:.85}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-size:18px;font-weight:900">RCF • RESCUE MODE</div>
          <div class="hint">Se o app travou em “carregando app.js…”, use isso pra limpar SW/cache e voltar.</div>
        </div>
        <div style="font-size:12px;opacity:.8" id="ver">vRESCUE</div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn danger" id="btnUnreg">Unregister SW</button>
        <button class="btn danger" id="btnCaches">Clear Caches</button>
        <button class="btn danger" id="btnOverrides">Clear Overrides</button>
        <button class="btn" id="btnBump">Bump Cache Bust</button>
        <button class="btn ok" id="btnReload">Reload</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnShowKeys">Show localStorage keys</button>
        <button class="btn danger" id="btnSoftReset">Soft Reset (não apaga apps)</button>
      </div>

      <div style="margin-top:12px" class="hint">
        Depois de limpar: clique <b>Reload</b>.  
        Quando voltar, a gente recoloca o index padrão e corrige o app.js sem perder nada.
      </div>

      <pre id="out">Pronto.</pre>
    </div>
  </div>

  <script>
    (function(){
      const out = document.getElementById("out");
      const log = (...a) => { try { out.textContent += "\n" + a.join(" "); } catch {} try { console.log("[RCF/RESCUE]", ...a); } catch {} };

      function bump(){
        try {
          const k = "rcf:cache_bust";
          const v = String(Date.now());
          localStorage.setItem(k, v);
          log("OK bump:", k, "=", v);
        } catch(e){ log("ERR bump:", e.message||e); }
      }

      async function unreg(){
        try{
          if(!("serviceWorker" in navigator)){ log("SW: unsupported"); return; }
          const regs = await navigator.serviceWorker.getRegistrations();
          let n=0;
          for(const r of regs){ try{ if(await r.unregister()) n++; }catch{} }
          log("SW unregistered:", n);
        }catch(e){ log("ERR sw:", e.message||e); }
      }

      async function clearCaches(){
        try{
          if(!("caches" in window)){ log("Caches: unsupported"); return; }
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
          log("Caches deleted:", keys.length, keys.join(", "));
        }catch(e){ log("ERR caches:", e.message||e); }
      }

      function clearOverrides(){
        try{
          // suas chaves típicas
          const keys = [
            "rcf:RCF_OVERRIDES_MAP",
            "RCF_OVERRIDES_MAP",
            "rcf:mother_bundle",
            "RCF_MOTHER_BUNDLE"
          ];
          for(const k of keys){
            try{ localStorage.removeItem(k); }catch{}
          }
          // se existir o VFS de overrides no runtime, tenta limpar também
          try{
            const V = window.RCF_OVERRIDES_VFS;
            if(V && typeof V.listFiles === "function" && typeof V.deleteFile === "function"){
              V.listFiles().then(list => {
                (list||[]).slice(0, 1200).forEach(p => { try{ V.deleteFile(p); }catch{} });
              }).catch(()=>{});
            }
          }catch{}
          log("Overrides cleared (keys removed).");
        }catch(e){ log("ERR overrides:", e.message||e); }
      }

      function showKeys(){
        try{
          const ks=[];
          for(let i=0;i<localStorage.length;i++){
            const k = localStorage.key(i);
            if(!k) continue;
            if(k.startsWith("rcf:") || k.includes("RCF")) ks.push(k);
          }
          ks.sort();
          log("Keys:", ks.length);
          log(ks.join("\n"));
        }catch(e){ log("ERR keys:", e.message||e); }
      }

      function softReset(){
        try{
          // NÃO apaga apps: rcf:apps
          // reseta só view/active/pending e logs (opcional)
          const keep = new Set(["rcf:apps"]);
          const del=[];
          for(let i=0;i<localStorage.length;i++){
            const k = localStorage.key(i);
            if(!k) continue;
            if(!k.startsWith("rcf:")) continue;
            if(keep.has(k)) continue;
            if(k === "rcf:apps") continue;
            // remove coisas que travam boot
            if(
              k === "rcf:active" ||
              k === "rcf:pending" ||
              k === "rcf:logs" ||
              k === "rcf:cfg" ||
              k === "rcf:RCF_FILE_INDEX" ||
              k === "rcf:RCF_TARGET_MAP" ||
              k === "rcf:ghcfg"
            ){
              del.push(k);
            }
          }
          del.forEach(k => { try{ localStorage.removeItem(k); }catch{} });
          log("Soft reset removed:", del.length, del.join(", "));
        }catch(e){ log("ERR reset:", e.message||e); }
      }

      document.getElementById("btnUnreg").onclick = () => unreg();
      document.getElementById("btnCaches").onclick = () => clearCaches();
      document.getElementById("btnOverrides").onclick = () => clearOverrides();
      document.getElementById("btnBump").onclick = () => bump();
      document.getElementById("btnReload").onclick = () => location.reload();

      document.getElementById("btnShowKeys").onclick = () => showKeys();
      document.getElementById("btnSoftReset").onclick = () => softReset();

      log("RESCUE ready. base=", document.baseURI);
      bump();
    })();
  </script>
</body>
</html>
