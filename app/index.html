<!-- FILE: /app/index.html
     RControl Factory — index.html (PADRÃO HOTFIX: APPJS TIMEOUT + CACHE-BUST)
     - Mantém base "./"
     - Mantém Guard __RCF_INDEX_BOOTED__
     - Adiciona loadScript com timeout
     - Força cache-bust SOMENTE no app.js (resolve travas de SW/cache no iOS)
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RCF</title>
  <meta name="theme-color" content="#0b1020" />

  <base href="./" />

  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />

  <meta name="rcf-index" content="vPADRAO-HOTFIX-APPJS-TIMEOUT-BUST" />
</head>

<body>
  <noscript>Ative o JavaScript para usar o app.</noscript>

  <div id="app">
    <div style="padding:14px;font-family:system-ui">Carregando…</div>
  </div>

  <script>
    (function () {
      if (window.__RCF_INDEX_BOOTED__) return;
      window.__RCF_INDEX_BOOTED__ = true;

      function log(){ try { console.log.apply(console, ["[RCF/index]"].concat([].slice.call(arguments))); } catch(e){} }

      function loadScript(src, opts){
        opts = opts || {};
        const timeoutMs = Number.isFinite(opts.timeoutMs) ? opts.timeoutMs : 12000;

        return new Promise((resolve, reject) => {
          let done = false;
          let tmr = null;

          function finish(ok, payload){
            if (done) return;
            done = true;
            if (tmr) { try { clearTimeout(tmr); } catch {} tmr = null; }
            ok ? resolve(payload) : reject(payload);
          }

          try {
            const s = document.createElement("script");
            s.async = false;
            s.src = src;

            s.onload = () => finish(true, src);
            s.onerror = () => finish(false, new Error("load failed: " + src));

            tmr = setTimeout(() => {
              try { s.remove(); } catch {}
              finish(false, new Error("TIMEOUT loading: " + src + " ("+timeoutMs+"ms)"));
            }, timeoutMs);

            document.head.appendChild(s);
          } catch (e) {
            finish(false, e);
          }
        });
      }

      // cache-bust bem simples (só pra quebrar enrosco de SW/cache)
      function bustKey(){
        try {
          const k = localStorage.getItem("rcf:cache_bust");
          if (k) return k;
          const n = String(Date.now());
          localStorage.setItem("rcf:cache_bust", n);
          return n;
        } catch {
          return String(Date.now());
        }
      }

      async function boot(){
        log("BOOT: starting… base=", document.baseURI);

        const modules = [
          "./js/core/logger.js",
          "./js/core/stability_guard.js",
          "./js/core/storage.js",

          "./js/core/vendor_loader.js",
          "./js/core/vendor_health.js",

          "./js/core/github_sync.js",
          "./js/core/vfs_overrides.js",
          "./js/core/vfs_shim.js",
          "./js/core/mother_selfupdate.js",
          "./js/core/errors.js",
          "./js/core/risk.js",
          "./js/core/snapshot.js",
          "./js/core/selfheal.js",
          "./js/core/ui_safety.js",
          "./js/core/ui_compact_outputs.js",
          "./js/core/ui_bindings.js",
          "./js/core/diagnostics.js",
          "./js/core/publish_queue.js",
          "./js/core/preview_runner.js",
          "./js/core/policy.js",
          "./js/core/settings_cleanup.js",
          "./js/core/injector.js",

          "./js/engine/template_registry.js",
          "./js/engine/module_registry.js",
          "./js/engine/builder.js",
          "./js/engine/engine.js",

          "./js/core/pages_links.js",
          "./js/admin.github.js"
        ];

        // 1) CORE + ENGINE
        for (const src of modules) {
          try {
            await loadScript(src, { timeoutMs: 12000 });
            try { window.RCF_LOGGER?.push?.("BOOT", "module loaded ✅ " + src); } catch {}
            log("module loaded ✅", src);
          } catch (e) {
            try { window.RCF_LOGGER?.push?.("WARN", "module missing/failed ❌ " + src + " :: " + (e.message||e)); } catch {}
            log("module missing/failed ❌", src, (e.message||e));
          }
        }

        // 2) app.js (com cache-bust + timeout maior)
        try {
          const appSrc = "./app.js?v=" + encodeURIComponent(bustKey());
          log("Agora carregando app.js…", appSrc);

          await loadScript(appSrc, { timeoutMs: 20000 });

          try { window.RCF_LOGGER?.push?.("BOOT", "app.js loaded ✅ " + appSrc); } catch {}
          log("app.js loaded ✅");
        } catch (e) {
          try { window.RCF_LOGGER?.push?.("ERR", "app.js missing/failed ❌ :: " + (e.message||e)); } catch {}
          log("app.js missing/failed ❌", (e.message||e));
        }

        // 3) ZIP/UI modules (depois do app.js)
        const afterApp = [
          "./js/core/zip_vault.js",
          "./js/core/agent_zip_bridge.js"
        ];

        for (const src of afterApp) {
          try {
            await loadScript(src, { timeoutMs: 12000 });
            try { window.RCF_LOGGER?.push?.("BOOT", "module loaded ✅ " + src); } catch {}
            log("module loaded ✅", src);
          } catch (e) {
            try { window.RCF_LOGGER?.push?.("WARN", "module missing/failed ❌ " + src + " :: " + (e.message||e)); } catch {}
            log("module missing/failed ❌", src, (e.message||e));
          }
        }

        // SW register (guard)
        try {
          if (!window.__RCF_SW_REGISTERED__ && "serviceWorker" in navigator) {
            window.__RCF_SW_REGISTERED__ = true;
            navigator.serviceWorker.register("./sw.js", { scope: "./" })
              .then(() => {
                try { window.RCF_LOGGER?.push?.("BOOT", "sw register: ok (scope ./)"); } catch {}
                log("sw register ok");
              })
              .catch((e) => {
                try { window.RCF_LOGGER?.push?.("WARN", "sw register: fail/ignored :: " + (e?.message||e)); } catch {}
                log("sw register fail/ignored:", (e?.message||e));
              });
          }
        } catch {}
      }

      boot();
    })();
  </script>
</body>
</html>
