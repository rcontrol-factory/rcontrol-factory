<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RControl Factory</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- ✅ importante: base relativo pra funcionar em /app/ -->
  <base href="./" />

  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <noscript>Ative o JavaScript para usar o app.</noscript>

  <div id="app">
    <div style="padding:14px;font-family:system-ui">Carregando…</div>
  </div>

  <!-- RCF_BOOT_PANEL_START -->
  <!-- ✅ BootPanel (não bloqueia clique global) -->
  <div id="rcfBootPanel" style="
    position:fixed; left:12px; right:12px; bottom:12px;
    z-index:999999; padding:12px; border-radius:14px;
    background:rgba(0,0,0,.55); color:#d7fbe2;
    border:1px solid rgba(255,255,255,.10);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;
    font-size:12px; line-height:1.35;
    max-height:34vh; overflow:hidden;
    pointer-events:none;
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  ">

    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; pointer-events:auto;">
      <div style="font-weight:900; letter-spacing:.2px;">RCF BOOT</div>

      <div id="rcfBootMeta" style="opacity:.85; font-weight:700;">(min)</div>

      <button id="rcfBootExpandBtn" style="
        margin-left:auto; padding:6px 10px; border-radius:999px;
        border:1px solid rgba(255,255,255,.15);
        background:rgba(255,255,255,.08); color:#fff;
        pointer-events:auto;">Expand</button>

      <button id="rcfBootCopyBtn" style="
        padding:6px 10px; border-radius:999px;
        border:1px solid rgba(255,255,255,.15);
        background:rgba(255,255,255,.08); color:#fff;
        pointer-events:auto;">Copy</button>

      <button id="rcfReloadBtn" style="
        padding:6px 10px; border-radius:999px;
        border:1px solid rgba(255,255,255,.15);
        background:rgba(255,255,255,.08); color:#fff;
        pointer-events:auto;">Reload</button>

      <button id="rcfHideBtn" style="
        padding:6px 10px; border-radius:999px;
        border:1px solid rgba(255,255,255,.15);
        background:rgba(255,255,255,.08); color:#fff;
        pointer-events:auto;">Hide</button>
    </div>

    <pre id="rcfBootLog" style="
      margin:0;
      white-space:pre-wrap;
      overflow:auto;
      max-height:26vh;
      padding-right:4px;
      pointer-events:auto;
      -webkit-overflow-scrolling:touch;
    ">boot: init…</pre>
  </div>
  <!-- RCF_BOOT_PANEL_END -->

  <!-- RCF_BOOT_SCRIPT_START -->
  <script>
    (function () {
      const panel = document.getElementById("rcfBootPanel");
      const out = document.getElementById("rcfBootLog");
      const meta = document.getElementById("rcfBootMeta");

      // --------- config anti “tela gigante” ----------
      const BOOT_MAX_LINES = 90;     // quantas linhas ficam visíveis no painel
      const BOOT_MAX_CHARS = 14000;  // limite extra (seguro) em chars
      let bootLines = ["boot: panel ready"];
      let isExpanded = false;

      function updateMeta() {
        try {
          meta.textContent = isExpanded ? "(exp)" : "(min)";
        } catch {}
      }

      function renderBoot() {
        try {
          // trim por linhas
          if (bootLines.length > BOOT_MAX_LINES) {
            bootLines = bootLines.slice(bootLines.length - BOOT_MAX_LINES);
            bootLines[0] = "… (tail) … " + bootLines[0];
          }

          let txt = bootLines.join("\n");
          // trim por chars (último recurso)
          if (txt.length > BOOT_MAX_CHARS) {
            txt = "… (tail chars) …\n" + txt.slice(txt.length - BOOT_MAX_CHARS);
          }

          out.textContent = txt;
          if (isExpanded) out.scrollTop = out.scrollHeight;
        } catch {}
      }

      function bootLog(line){
        try {
          bootLines.push(String(line || ""));
          renderBoot();
        } catch {}
      }

      function setExpanded(on) {
        isExpanded = !!on;
        try {
          if (!panel) return;

          // min = “fit” (não ocupa tela)
          if (!isExpanded) {
            panel.style.maxHeight = "70px";
            panel.style.overflow = "hidden";
            out.style.maxHeight = "0px";
            out.style.paddingTop = "0px";
            out.style.opacity = "0";
          } else {
            panel.style.maxHeight = "34vh";
            panel.style.overflow = "hidden";
            out.style.maxHeight = "26vh";
            out.style.opacity = "1";
          }
        } catch {}
        updateMeta();
      }

      // botões
      try {
        document.getElementById("rcfReloadBtn").onclick = () => location.reload();
        document.getElementById("rcfHideBtn").onclick = () => { if (panel) panel.style.display = "none"; };

        document.getElementById("rcfBootExpandBtn").onclick = () => {
          setExpanded(!isExpanded);
          document.getElementById("rcfBootExpandBtn").textContent = isExpanded ? "Minimize" : "Expand";
          if (isExpanded) { try { out.scrollTop = out.scrollHeight; } catch {} }
        };

        document.getElementById("rcfBootCopyBtn").onclick = async () => {
          try {
            const txt = String(out.textContent || "");
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(txt);
              bootLog("BOOT: copied ✅");
            } else {
              bootLog("BOOT: clipboard indisponível (copie manual)");
            }
          } catch {
            bootLog("BOOT: copy falhou (iOS bloqueou)");
          }
        };
      } catch {}

      // start minimizado (pra não ficar horrível)
      setExpanded(false);
      renderBoot();

      function loadScript(src){
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.async = false;
          s.onload = () => resolve(src);
          s.onerror = () => reject(new Error("load failed: " + src));
          document.head.appendChild(s);
        });
      }

      async function boot(){
        bootLog("BOOT: index boot: starting…");
        bootLog("BOOT: base href = " + document.baseURI);

        // ordem: logger -> stability_guard -> storage -> github/vfs/mae -> core extras -> admin -> app.js
        const modules = [
          "./js/core/logger.js",
          "./js/core/stability_guard.js",
          "./js/core/storage.js",
          "./js/core/github_sync.js",
          "./js/core/vfs_overrides.js",
          "./js/core/vfs_shim.js",
          "./js/core/mother_selfupdate.js",

          // core extras (agora já carregando tudo que você mostrou nos logs)
          "./js/core/errors.js",
          "./js/core/risk.js",
          "./js/core/snapshot.js",
          "./js/core/selfheal.js",
          "./js/core/ui_safety.js",
          "./js/core/ui_compact_outputs.js",
          "./js/core/ui_bindings.js",
          "./js/core/diagnostics.js",
          "./js/core/publish_queue.js",
          "./js/core/preview_runner.js",
          "./js/core/policy.js",
          "./js/core/settings_cleanup.js",
          "./js/core/injector.js",

          "./js/admin.github.js"
        ];

        for (const src of modules) {
          try {
            await loadScript(src);
            try { window.RCF_LOGGER?.push?.("BOOT", "module loaded ✅ " + src); } catch {}
            bootLog("BOOT: module loaded ✅ " + src);
          } catch (e) {
            const m = (e && e.message) ? e.message : String(e);
            try { window.RCF_LOGGER?.push?.("WARN", "module missing/failed ❌ " + src + " :: " + m); } catch {}
            bootLog("WARN: module missing/failed ❌ " + src + " :: " + m);
          }
        }

        // sanity log (não quebra se não existir)
        try {
          const ok = {
            RCF_ERRORS: !!window.RCF_ERRORS,
            RCF_RISK: !!window.RCF_RISK,
            RCF_SNAPSHOT: !!window.RCF_SNAPSHOT,
            RCF_SELFHEAL: !!window.RCF_SELFHEAL,
            RCF_UI_SAFETY: !!window.RCF_UI_SAFETY
          };
          try { window.RCF_LOGGER?.push?.("INFO", "CORE READY CHECK => " + JSON.stringify(ok)); } catch {}
          bootLog("INFO: CORE READY CHECK => " + JSON.stringify(ok));
        } catch {}

        try {
          await loadScript("./app.js");
          try { window.RCF_LOGGER?.push?.("BOOT", "app.js loaded ✅ ./app.js"); } catch {}
          bootLog("BOOT: app.js loaded ✅ ./app.js");
        } catch (e) {
          const m = (e && e.message) ? e.message : String(e);
          try { window.RCF_LOGGER?.push?.("ERR", "app.js missing/failed ❌ ./app.js :: " + m); } catch {}
          bootLog("ERR: app.js missing/failed ❌ ./app.js :: " + m);
        }

        try {
          if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./sw.js", { scope: "./" })
              .then(() => {
                try { window.RCF_LOGGER?.push?.("BOOT", "sw register: ok (scope ./)"); } catch {}
                bootLog("BOOT: sw register: ok (scope ./)");
              })
              .catch((e) => {
                const m = (e && e.message) ? e.message : String(e);
                try { window.RCF_LOGGER?.push?.("WARN", "sw register: fail/ignored :: " + m); } catch {}
                bootLog("WARN: sw register: fail/ignored :: " + m);
              });
          }
        } catch {}
      }

      boot();
    })();
  </script>
  <!-- RCF_BOOT_SCRIPT_END -->

</body>
</html>
