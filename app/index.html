<!-- FILE: /app/index.html
     RControl Factory — index.html (vCLEAN-1+ENGINE + VENDOR ZIP + PAGES LINKS + EXTRAS3 + SWVER)
     PATCH (2026-02-22 hotfix):
     - ✅ FIX REGRESSÃO: ZIP/UI modules carregam DEPOIS do app.js, então precisamos reinjetar UI depois do load
       -> POST-ZIP REINJECT (chama mountUI/mount/inject/init)
     - ✅ MAE ALIAS: tenta mapear window.RCF_MAE / window.RCF_MOTHER caso o módulo exporte com outro nome
     - mantém DEGRAU 3 (auto extra-modules SAFE + 1 reload)
     - mantém ZIP modules carregando DEPOIS do app.js (evita botão sumir)
     - adiciona/garante "./js/core/pages_links.js"
     - mantém base "./" e guards anti-boot duplicado
     - ✅ SW VERSIONED REGISTER (iOS cache breaker): ./sw.js?v=BUILD
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RCF</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- PADRÃO: base relativo (Pages/subpath safe) -->
  <base href="./" />

  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />

  <meta name="rcf-index" content="vCLEAN-1+ENGINE+VENDORZIP+PAGESLINKS+EXTRAS3+SWVER+POSTZIPREINJECT" />
</head>

<body>
  <noscript>Ative o JavaScript para usar o app.</noscript>

  <div id="app">
    <div style="padding:14px;font-family:system-ui">Carregando…</div>
  </div>

  <script>
    (function () {
      // ✅ Guard: evita carregar tudo 2x em edge cases
      if (window.__RCF_INDEX_BOOTED__) return;
      window.__RCF_INDEX_BOOTED__ = true;

      // ✅ BUILD do SW (troque quando quiser forçar “quebra-cache”)
      const RCF_SW_BUILD = "RCF_SW_BUILD_2026_02_22_02";

      function log(){ try { console.log.apply(console, ["[RCF/index]"].concat([].slice.call(arguments))); } catch(e){} }

      function loadScript(src){
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.async = false;
          s.onload = () => resolve(src);
          s.onerror = () => reject(new Error("load failed: " + src));
          document.head.appendChild(s);
        });
      }

      // =========================================================
      // DEGRAU 3 — AUTO EXTRA MODULES (SAFE + 1 reload)
      // =========================================================
      function ensureExtraModules(){
        const KEY = "rcf:boot:extra_modules";
        const GUARD = "rcf:extra_modules_installed:v1";
        const MUST = [
          "./js/core/agent_tools_panel.js",
          "./js/core/agent_scanmap.js"
        ];

        // evita loop de reload
        try {
          if (sessionStorage.getItem(GUARD) === "1") return { changed:false, already:true };
        } catch {}

        let cur = [];
        try {
          const raw = localStorage.getItem(KEY);
          const j = raw ? JSON.parse(raw) : [];
          cur = Array.isArray(j) ? j : [];
        } catch {
          cur = [];
        }

        const norm = (p) => String(p || "").trim();
        const set = new Set(cur.map(norm).filter(Boolean));

        let changed = false;
        for (const p of MUST) {
          const x = norm(p);
          if (!set.has(x)) { set.add(x); changed = true; }
        }

        const list = Array.from(set).sort((a,b)=>a.localeCompare(b));

        if (changed) {
          try { localStorage.setItem(KEY, JSON.stringify(list)); } catch {}
          try { sessionStorage.setItem(GUARD, "1"); } catch {}
          return { changed:true, list };
        }

        try { sessionStorage.setItem(GUARD, "1"); } catch {}
        return { changed:false, list };
      }

      // =========================================================
      // POST-ZIP REINJECT (corrige "UI_READY fired reinject_called=0")
      // =========================================================
      function postZipReinject(){
        const tries = [
          ["RCF_ZIP_VAULT", "mountUI"],
          ["RCF_ZIP_VAULT", "mount"],
          ["RCF_ZIP_VAULT", "injectUI"],
          ["RCF_ZIP_VAULT", "inject"],
          ["RCF_ZIP_VAULT", "init"],
          ["RCF_AGENT_ZIP_BRIDGE", "mountUI"],
          ["RCF_AGENT_ZIP_BRIDGE", "mount"],
          ["RCF_AGENT_ZIP_BRIDGE", "init"]
        ];

        let called = 0;
        for (const [objName, fnName] of tries) {
          try {
            const obj = window[objName];
            const fn = obj && obj[fnName];
            if (typeof fn === "function") {
              fn.call(obj, { ui: window.RCF_UI });
              called++;
            }
          } catch {}
        }

        try { window.RCF_LOGGER?.push?.("INFO", `POST-ZIP reinject ✅ called=${called}`); } catch {}
        log("POST-ZIP reinject", "called=", called);

        // também sinaliza evento de "late ready" (se algum módulo escutar)
        try {
          window.dispatchEvent(new CustomEvent("RCF:UI_READY", { detail: { ts: Date.now(), late: true } }));
        } catch {}
      }

      // =========================================================
      // MAE alias detector (caso o módulo exporte com outro nome)
      // =========================================================
      function ensureMaeAlias(){
        try {
          if (window.RCF_MAE || window.RCF_MOTHER) return true;

          const candidates = [
            window.RCF_MOTHER_SELFUPDATE,
            window.MOTHER_SELFUPDATE,
            window.MAE,
            window.MOTHER
          ].filter(Boolean);

          const hit = candidates[0] || null;
          if (hit) {
            window.RCF_MAE = hit;
            window.RCF_MOTHER = hit;
            try { window.RCF_LOGGER?.push?.("OK", "MAE alias OK ✅"); } catch {}
            log("MAE alias OK");
            return true;
          }

          log("MAE alias: nenhum candidato encontrado");
          return false;
        } catch {
          return false;
        }
      }

      async function boot(){
        log("BOOT: starting… base=", document.baseURI);

        // ✅ roda antes de qualquer coisa que dependa do boot extra
        try {
          const r = ensureExtraModules();
          if (r && r.changed) {
            log("DEGRAU3: extra_modules atualizado -> reload 1x", r.list || []);
            try { location.reload(); return; } catch {}
          } else {
            log("DEGRAU3: extra_modules ok");
          }
        } catch (e) {
          log("DEGRAU3: falhou (ignorado)", (e && e.message) ? e.message : e);
        }

        // =========================================================
        // 1) CORE + ENGINE (antes do app.js)
        // =========================================================
        const modules = [
          "./js/core/logger.js",
          "./js/core/stability_guard.js",
          "./js/core/storage.js",

          /* ✅ VENDOR */
          "./js/core/vendor_loader.js",
          "./js/core/vendor_health.js",

          "./js/core/github_sync.js",
          "./js/core/vfs_overrides.js",
          "./js/core/vfs_shim.js",
          "./js/core/mother_selfupdate.js",
          "./js/core/errors.js",
          "./js/core/risk.js",
          "./js/core/snapshot.js",
          "./js/core/selfheal.js",
          "./js/core/ui_safety.js",
          "./js/core/ui_compact_outputs.js",
          "./js/core/ui_bindings.js",
          "./js/core/diagnostics.js",
          "./js/core/publish_queue.js",
          "./js/core/preview_runner.js",
          "./js/core/policy.js",
          "./js/core/settings_cleanup.js",
          "./js/core/injector.js",

          /* ✅ ENGINE */
          "./js/engine/template_registry.js",
          "./js/engine/module_registry.js",
          "./js/engine/builder.js",
          "./js/engine/engine.js",

          /* ✅ PWA Links / Pages Hook */
          "./js/core/pages_links.js",

          "./js/admin.github.js"
        ];

        for (const src of modules) {
          try {
            await loadScript(src);
            try { window.RCF_LOGGER?.push?.("BOOT", "module loaded ✅ " + src); } catch {}
            log("module loaded ✅", src);
          } catch (e) {
            try { window.RCF_LOGGER?.push?.("WARN", "module missing/failed ❌ " + src + " :: " + (e.message||e)); } catch {}
            log("module missing/failed ❌", src, (e.message||e));
          }
        }

        // ✅ depois de carregar a mãe, tenta alias
        try { ensureMaeAlias(); } catch {}

        // =========================================================
        // 2) app.js (cria UI/slots)
        // =========================================================
        try {
          await loadScript("./app.js");
          try { window.RCF_LOGGER?.push?.("BOOT", "app.js loaded ✅ ./app.js"); } catch {}
          log("app.js loaded ✅");
        } catch (e) {
          try { window.RCF_LOGGER?.push?.("ERR", "app.js missing/failed ❌ ./app.js :: " + (e.message||e)); } catch {}
          log("app.js missing/failed ❌", (e.message||e));
        }

        // =========================================================
        // 3) ZIP/UI modules (depois do app.js)
        // =========================================================
        const afterApp = [
          "./js/core/zip_vault.js",
          "./js/core/agent_zip_bridge.js"
        ];

        for (const src of afterApp) {
          try {
            await loadScript(src);
            try { window.RCF_LOGGER?.push?.("BOOT", "module loaded ✅ " + src); } catch {}
            log("module loaded ✅", src);
          } catch (e) {
            try { window.RCF_LOGGER?.push?.("WARN", "module missing/failed ❌ " + src + " :: " + (e.message||e)); } catch {}
            log("module missing/failed ❌", src, (e.message||e));
          }
        }

        // ✅ HOTFIX: reinjetar UI depois do ZIP carregar
        try { postZipReinject(); } catch {}

        // =========================================================
        // 4) SW register (versionado) — quebra-cache iOS
        // =========================================================
        try {
          if (!window.__RCF_SW_REGISTERED__ && "serviceWorker" in navigator) {
            window.__RCF_SW_REGISTERED__ = true;

            const swUrl = "./sw.js?v=" + encodeURIComponent(RCF_SW_BUILD);

            navigator.serviceWorker.register(swUrl, { scope: "./" })
              .then((reg) => {
                try { window.RCF_LOGGER?.push?.("BOOT", "sw register: ok ✅ " + swUrl); } catch {}
                log("sw register ok", swUrl);
                try { reg.update?.(); } catch {}
              })
              .catch((e) => {
                try { window.RCF_LOGGER?.push?.("WARN", "sw register: fail/ignored :: " + (e?.message||e)); } catch {}
                log("sw register fail/ignored:", (e?.message||e));
              });
          }
        } catch {}
      }

      boot();
    })();
  </script>
</body>
</html>
