<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RControl Factory</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- ✅ importante: base relativo pra funcionar em /app/ -->
  <base href="./" />

  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <noscript>Ative o JavaScript para usar o app.</noscript>

  <div id="app">
    <div style="padding:14px;font-family:system-ui">Carregando…</div>
  </div>

  <!-- RCF_BOOT_PANEL_START -->
  <!-- ✅ BootPanel (sempre visível) -->
  <div id="rcfBootPanel" style="
    position:fixed; left:12px; right:12px; bottom:12px;
    z-index:999999; padding:12px; border-radius:14px;
    background:rgba(0,0,0,.55); color:#d7fbe2;
    border:1px solid rgba(255,255,255,.10);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;
    font-size:12px; line-height:1.35;
    max-height:36vh; overflow:auto;">
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
      <div style="font-weight:800;">RCF BOOT</div>
      <button id="rcfReloadBtn" style="
        margin-left:auto; padding:6px 10px; border-radius:999px;
        border:1px solid rgba(255,255,255,.15);
        background:rgba(255,255,255,.08); color:#fff;">Reload</button>
      <button id="rcfHideBtn" style="
        padding:6px 10px; border-radius:999px;
        border:1px solid rgba(255,255,255,.15);
        background:rgba(255,255,255,.08); color:#fff;">Hide</button>
    </div>
    <pre id="rcfBootLog" style="margin:0; white-space:pre-wrap;">boot: init…</pre>
  </div>

  <!-- RCF_BOOT_SCRIPT_START -->
  <script>
    (function () {
      const out = document.getElementById("rcfBootLog");
      function p(line){
        try {
          out.textContent += "\n" + line;
          out.scrollTop = out.scrollHeight;
        } catch {}
      }

      // botões
      try {
        document.getElementById("rcfReloadBtn").onclick = () => location.reload();
        document.getElementById("rcfHideBtn").onclick = () => {
          const pan = document.getElementById("rcfBootPanel");
          if (pan) pan.style.display = "none";
        };
      } catch {}

      // logger global (não sobrescreve se logger.js já criar)
      window.RCF_LOGGER = window.RCF_LOGGER || {
        push(level, msg){
          const line = "[" + level + "] " + msg;
          p(line);
          try { console.log(line); } catch {}
        }
      };

      // pega erros que travam em “Carregando…”
      window.addEventListener("error", (e) => {
        const m = (e && (e.message || e.error?.message)) || "Erro desconhecido";
        const src = e && e.filename ? (" @ " + e.filename + ":" + (e.lineno||0) + ":" + (e.colno||0)) : "";
        window.RCF_LOGGER.push("ERR", "GLOBAL_ERROR: " + m + src);
        try { if (e && e.error && e.error.stack) window.RCF_LOGGER.push("ERR", "STACK: " + e.error.stack); } catch {}
      });

      window.addEventListener("unhandledrejection", (e) => {
        const r = e ? e.reason : null;
        const m = (r && r.message) ? r.message : String(r || "Promise rejection");
        window.RCF_LOGGER.push("ERR", "UNHANDLED_REJECTION: " + m);
        try { if (r && r.stack) window.RCF_LOGGER.push("ERR", "STACK: " + r.stack); } catch {}
      });

      function loadScript(src){
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.async = false;
          s.onload = () => resolve(src);
          s.onerror = () => reject(new Error("load failed: " + src));
          document.head.appendChild(s);
        });
      }

      async function boot(){
        window.RCF_LOGGER.push("BOOT", "index boot: starting…");
        window.RCF_LOGGER.push("BOOT", "base href = " + document.baseURI);

        // ✅ ordem mínima (antes do app.js)
        // ✅ vfs_shim entra DEPOIS do vfs_overrides (porque ele “ponteia”)
        const modules = [
          "./js/core/logger.js",
          "./js/core/storage.js",
          "./js/core/github_sync.js",
          "./js/core/vfs_overrides.js",
          "./js/core/vfs_shim.js",
          "./js/core/mother_selfupdate.js",
          "./js/admin.github.js"
        ];

        for (const src of modules) {
          try {
            await loadScript(src);
            window.RCF_LOGGER.push("BOOT", "module loaded ✅ " + src);
          } catch (e) {
            window.RCF_LOGGER.push("WARN", "module missing/failed ❌ " + src + " :: " + (e.message||e));
          }
        }

        // app principal
        try {
          await loadScript("./app.js");
          window.RCF_LOGGER.push("BOOT", "app.js loaded ✅ ./app.js");
        } catch (e) {
          window.RCF_LOGGER.push("ERR", "app.js missing/failed ❌ ./app.js :: " + (e.message||e));
        }

        // ✅ SW (scope ./) — PADRÃO /app/
        try {
          if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./sw.js", { scope: "./" })
              .then(() => window.RCF_LOGGER.push("BOOT", "sw register: ok (scope ./)"))
              .catch((e) => window.RCF_LOGGER.push("WARN", "sw register: fail/ignored :: " + (e?.message||e)));
          }
        } catch {}
      }

      boot();
    })();
  </script>
  <!-- RCF_BOOT_SCRIPT_END -->
  <!-- RCF_BOOT_PANEL_END -->

</body>
</html>
