<!-- FILE: app/index.html
     RControl Factory — /app/index.html — vCLEAN-1+ENGINE (SAFE INDEX + watchdog + safe=1)
     - Anti-duplo-load (__RCF_INDEX_BOOTED__)
     - Watchdog: mostra qual script travou
     - Modo safe: ?safe=1  (carrega só o mínimo pra isolar módulo quebrado)
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>RControl Factory</title>

  <style>
    /* tela de boot / watchdog */
    :root{--bg:#070b12;--fg:#fff;--muted:rgba(255,255,255,.75);--card:rgba(255,255,255,.05);--bd:rgba(255,255,255,.14)}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #bootScreen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .card{max-width:860px;width:100%;border:1px solid var(--bd);border-radius:16px;background:var(--card);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-weight:900;font-size:18px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--bd);background:rgba(0,0,0,.25)}
    .mono{white-space:pre-wrap;word-break:break-word;margin-top:10px;padding:12px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid var(--bd);max-height:45vh;overflow:auto}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:800}
    .ok{background:#2dd4bf;color:#022}
    .danger{background:#ef4444;color:#fff}
    .ghost{background:rgba(255,255,255,.08);color:#fff;border:1px solid var(--bd)}
    a{color:#7dd3fc}
  </style>

  <script>
    // ==============================
    // INDEX BOOT GUARD + WATCHDOG
    // ==============================
    (function(){
      if (window.__RCF_INDEX_BOOTED__) return;
      window.__RCF_INDEX_BOOTED__ = true;

      const qs = new URLSearchParams(location.search);
      window.__RCF_SAFE_MODE__ = (qs.get("safe") === "1");

      const stamp = () => new Date().toLocaleString();
      const log = (m) => {
        try {
          window.__RCF_BOOT_LOG__ = window.__RCF_BOOT_LOG__ || [];
          window.__RCF_BOOT_LOG__.push("[" + stamp() + "] " + m);
          const el = document.getElementById("bootLog");
          if (el) el.textContent = window.__RCF_BOOT_LOG__.join("\n");
          const st = document.getElementById("bootStatus");
          if (st) st.textContent = m;
        } catch {}
      };

      window.__RCF_BOOT_LOG_PUSH__ = log;
      window.addEventListener("error", (ev) => {
        try { log("ERR: " + (ev.message || "window.error") + (ev.filename ? (" @ " + ev.filename + ":" + (ev.lineno||0)) : "")); } catch {}
      });
      window.addEventListener("unhandledrejection", (ev) => {
        try { log("UNHANDLED: " + (ev.reason && (ev.reason.message || ev.reason)) ); } catch {}
      });

      // Watchdog: se em 10s o app não sinalizar boot, mantém essa tela com log
      setTimeout(() => {
        try {
          const booted = (window.__RCF_BOOTED__ === true) || (window.__RCF_UI_READY__ === true);
          if (!booted) {
            log("WATCHDOG: ainda não bootou (10s). Último script=" + (window.__RCF_LAST_SCRIPT__ || "(nenhum)"));
            const hint = document.getElementById("bootHint");
            if (hint) hint.textContent =
              "Dica: abra com ?safe=1 pra carregar só o mínimo e isolar módulo quebrado.";
          } else {
            // se bootou, some com tela
            const bs = document.getElementById("bootScreen");
            if (bs) bs.style.display = "none";
          }
        } catch {}
      }, 10000);

      // helper pra carregar scripts em ordem com log
      window.__RCF_LOAD_SCRIPT__ = function(src){
        return new Promise((resolve, reject) => {
          try {
            window.__RCF_LAST_SCRIPT__ = src;
            log("loading: " + src);
            const s = document.createElement("script");
            s.src = src;
            s.defer = true;
            s.onload = () => { log("loaded: " + src); resolve(true); };
            s.onerror = () => { log("FAIL: " + src); reject(new Error("load fail " + src)); };
            document.head.appendChild(s);
          } catch (e) { reject(e); }
        });
      };

      log("index init OK — safe=" + (window.__RCF_SAFE_MODE__ ? "1" : "0"));
    })();
  </script>
</head>

<body>
  <!-- app root -->
  <div id="app"></div>

  <!-- boot / watchdog screen -->
  <div id="bootScreen">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="title">RCF • Boot</div>
        <div class="row">
          <div class="pill" id="bootMode">mode: <span id="bootModeVal"></span></div>
          <div class="pill">status: <span id="bootStatus">iniciando…</span></div>
        </div>
      </div>

      <div style="margin-top:10px;color:var(--muted)">
        Se travar em “carregando…”, este log mostra exatamente qual script quebrou.
      </div>

      <div class="mono" id="bootLog">Pronto.</div>

      <div id="bootHint" style="margin-top:10px;color:var(--muted)"></div>

      <div class="row" style="margin-top:12px">
        <button class="btn ok" type="button" onclick="location.href=location.origin+location.pathname+'?safe=1'">Abrir SAFE (?safe=1)</button>
        <button class="btn ghost" type="button" onclick="location.reload()">Reload</button>
        <button class="btn danger" type="button" onclick="localStorage.removeItem('rcf:logs'); alert('logs locais limpos');">Limpar logs locais</button>
      </div>

      <div style="margin-top:10px;color:var(--muted);font-size:12px">
        Base: <a href="https://rcontrol-factory.pages.dev/" target="_blank" rel="noreferrer">rcontrol-factory.pages.dev</a>
      </div>
    </div>
  </div>

  <script>
    // mostra modo na UI
    try {
      document.getElementById("bootModeVal").textContent = (window.__RCF_SAFE_MODE__ ? "SAFE" : "NORMAL");
    } catch {}
  </script>

  <script>
    // ==============================
    // LOADER EM ORDEM (sem duplicar app.js)
    // ==============================
    (async function(){
      const load = window.__RCF_LOAD_SCRIPT__;
      const log = window.__RCF_BOOT_LOG_PUSH__ || function(){};

      // ✅ ajuste aqui se você usa cache bust via localStorage
      const bust = (() => {
        try {
          const v = localStorage.getItem("rcf:cache_bust");
          return v ? ("?v=" + encodeURIComponent(v)) : "";
        } catch { return ""; }
      })();

      try {
        // 1) Core / compat (carregue só o que EXISTE no seu deploy)
        //    Se um desses paths não existir, o log vai mostrar.
        //    No SAFE MODE, pula módulos extras.
        const safe = (window.__RCF_SAFE_MODE__ === true);

        // Ajuste os caminhos conforme seu projeto (mantive padrão do seu setup /app/js/core e /app/js/engine)
        // Core base (mínimo)
        await load("./js/core/diagnostics.js" + bust).catch(() => log("warn: diagnostics.js não carregou (ok)"));
        await load("./js/core/ui_bindings.js" + bust).catch(() => log("warn: ui_bindings.js não carregou (ok)"));

        // Engine (se existir)
        if (!safe) {
          await load("./js/engine/engine.js" + bust).catch(() => log("warn: engine.js não carregou (ok)"));
        } else {
          log("SAFE MODE: pulando engine/admin módulos");
        }

        // Admin/GitHub/Sync (só no normal)
        if (!safe) {
          await load("./js/admin.github.js" + bust).catch(() => log("warn: admin.github.js não carregou (ok)"));
          await load("./js/core/github_sync.js" + bust).catch(() => log("warn: github_sync.js não carregou (ok)"));
        }

        // 2) APP PRINCIPAL (sempre por último)
        //    Se você tem /app/app.js como principal, é esse.
        await load("./app.js" + bust);

        log("DONE: scripts carregados");
      } catch (e) {
        log("FATAL LOADER: " + (e && (e.message || e)));
      }
    })();
  </script>
</body>
</html>
