<!-- FILE: /app/index.html
     RCF — RECOVERY INDEX (SW/CACHE CLEANER) — 2026-02-22
     Objetivo: sempre carregar (zero deps) e permitir limpar Service Worker / caches / storage.
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RCF • Recovery</title>

  <!-- tenta reduzir cache do HTML (nem sempre garante, mas ajuda) -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{color-scheme:dark;}
    body{margin:0;background:#0b1020;color:#eaf0ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .wrap{padding:18px;max-width:820px;margin:0 auto;}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;margin:14px 0;}
    h1{margin:6px 0 2px;font-size:22px}
    p{margin:10px 0;opacity:.9;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:0;border-radius:999px;padding:12px 14px;font-weight:700;
      background:#ff4d4d;color:#111;cursor:pointer
    }
    button.alt{background:#35d0b5}
    button.dark{background:rgba(255,255,255,.10);color:#eaf0ff;border:1px solid rgba(255,255,255,.14)}
    code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    pre{white-space:pre-wrap;background:rgba(0,0,0,.35);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08)}
    .small{font-size:12px;opacity:.75}
    .ok{color:#7CFFA7}
    .warn{color:#FFD36A}
    .err{color:#FF7A7A}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>RCF • RECOVERY MODE</h1>
    <p>Se ficou tela preta, é <b>SW/cache preso</b>. Use os botões abaixo, depois clique <b>Reload</b>.</p>

    <div class="card">
      <div class="row">
        <button id="btnUnreg">Unregister SW</button>
        <button id="btnCaches">Clear Caches</button>
        <button id="btnStorage" class="dark">Clear Storage</button>
        <button id="btnHard" class="alt">Reload (cache-bust)</button>
      </div>
      <p class="small">Dica iPhone: se o normal estiver preso, abra em <b>Aba Privada</b> e rode isso 1x.</p>
    </div>

    <div class="card">
      <p class="small">Status:</p>
      <pre id="log">Starting…</pre>
    </div>

    <div class="card">
      <p class="small">
        Depois de limpar: volte pro app normal. (Quando estabilizar, a gente volta seu index padrão.)
      </p>
      <div class="row">
        <button id="btnGoApp" class="dark">Ir para Factory (./)</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const logEl = $("log");
      function log(msg, cls){
        const line = msg + "\\n";
        logEl.textContent += line;
      }
      function ts(){ return new Date().toISOString(); }

      function bustUrl(base){
        const u = new URL(base, location.href);
        u.searchParams.set("cb", String(Date.now()));
        return u.toString();
      }

      async function unregisterSW(){
        log("\\n[" + ts() + "] Unregister SW…");
        if (!("serviceWorker" in navigator)) {
          log("  (no serviceWorker support)");
          return { ok:true, count:0 };
        }
        try{
          const regs = await navigator.serviceWorker.getRegistrations();
          let n = 0;
          for (const r of regs) {
            try{
              const ok = await r.unregister();
              if (ok) n++;
            }catch(e){}
          }
          log("  ok: unregistered=" + n);
          return { ok:true, count:n };
        }catch(e){
          log("  ERR: " + (e && e.message ? e.message : e));
          return { ok:false, err:String(e) };
        }
      }

      async function clearCaches(){
        log("\\n[" + ts() + "] Clear caches…");
        if (!("caches" in window)) {
          log("  (no caches API)");
          return { ok:true, count:0 };
        }
        try{
          const keys = await caches.keys();
          let n = 0;
          for (const k of keys){
            try{
              const ok = await caches.delete(k);
              if (ok) n++;
            }catch(e){}
          }
          log("  ok: deleted=" + n + " (" + keys.length + " keys)");
          return { ok:true, count:n };
        }catch(e){
          log("  ERR: " + (e && e.message ? e.message : e));
          return { ok:false, err:String(e) };
        }
      }

      function clearStorage(){
        log("\\n[" + ts() + "] Clear storage…");
        let a=0,b=0;
        try{ a = localStorage.length; localStorage.clear(); }catch(e){}
        try{ b = sessionStorage.length; sessionStorage.clear(); }catch(e){}
        log("  ok: localStorage cleared ("+a+") / sessionStorage cleared ("+b+")");
        return { ok:true, local:a, session:b };
      }

      async function fullClean(){
        await unregisterSW();
        await clearCaches();
      }

      function reloadHard(){
        const target = bustUrl("./");
        log("\\n[" + ts() + "] Reload -> " + target);
        try{ location.href = target; }catch(e){ location.reload(); }
      }

      // bind
      $("btnUnreg").onclick = unregisterSW;
      $("btnCaches").onclick = clearCaches;
      $("btnStorage").onclick = clearStorage;
      $("btnHard").onclick = async ()=>{ await fullClean(); reloadHard(); };
      $("btnGoApp").onclick = ()=>{ location.href = bustUrl("./"); };

      // auto status
      log("[" + ts() + "] RECOVERY ready. href=" + location.href);
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.getRegistrations()
          .then(r=>log("SW regs=" + r.length))
          .catch(()=>log("SW regs=?"));
      } else {
        log("SW unsupported");
      }
    })();
  </script>
</body>
</html>
