<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RCF</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- PADRÃO: base relativo (Pages/subpath safe) -->
  <base href="./" />

  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />

  <!-- (Opcional) ajuda a ver que o index novo entrou -->
  <meta name="rcf-index" content="vCLEAN-1+ENGINE" />
</head>

<body>
  <noscript>Ative o JavaScript para usar o app.</noscript>

  <div id="app">
    <div style="padding:14px;font-family:system-ui">Carregando…</div>
  </div>

  <!-- =========================================================
    BOOT LOADER (CLEAN)
    - NÃO cria UI/overlay (isso fica no app.js)
    - NÃO captura logs (logger.js oficial manda pro Storage/UI)
    - Evita SW register duplicado
    - ✅ Evita BOOT duplicado do index (iOS/SW edge cases)
  ========================================================== -->
  <script>
    (function () {
      // ✅ Guard: evita carregar tudo 2x em edge cases
      if (window.__RCF_INDEX_BOOTED__) return;
      window.__RCF_INDEX_BOOTED__ = true;

      function log(){ try { console.log.apply(console, ["[RCF/index]"].concat([].slice.call(arguments))); } catch(e){} }

      function loadScript(src){
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.async = false;
          s.onload = () => resolve(src);
          s.onerror = () => reject(new Error("load failed: " + src));
          document.head.appendChild(s);
        });
      }

      async function boot(){
        log("BOOT: starting… base=", document.baseURI);

        const modules = [
          "./js/core/logger.js",
          "./js/core/stability_guard.js",
          "./js/core/storage.js",
          "./js/core/github_sync.js",
          "./js/core/vfs_overrides.js",
          "./js/core/vfs_shim.js",
          "./js/core/mother_selfupdate.js",
          "./js/core/errors.js",
          "./js/core/risk.js",
          "./js/core/snapshot.js",
          "./js/core/selfheal.js",
          "./js/core/ui_safety.js",
          "./js/core/ui_compact_outputs.js",
          "./js/core/ui_bindings.js",
          "./js/core/diagnostics.js",
          "./js/core/publish_queue.js",
          "./js/core/preview_runner.js",
          "./js/core/policy.js",
          "./js/core/settings_cleanup.js",
          "./js/core/injector.js",

          /* ✅ ENGINE (NOVO) */
          "./js/engine/template_registry.js",
          "./js/engine/module_registry.js",
          "./js/engine/builder.js",
          "./js/engine/engine.js",

          "./js/admin.github.js"
        ];

        for (const src of modules) {
          try {
            await loadScript(src);
            try { window.RCF_LOGGER?.push?.("BOOT", "module loaded ✅ " + src); } catch {}
            log("module loaded ✅", src);
          } catch (e) {
            try { window.RCF_LOGGER?.push?.("WARN", "module missing/failed ❌ " + src + " :: " + (e.message||e)); } catch {}
            log("module missing/failed ❌", src, (e.message||e));
          }
        }

        try {
          await loadScript("./app.js");
          try { window.RCF_LOGGER?.push?.("BOOT", "app.js loaded ✅ ./app.js"); } catch {}
          log("app.js loaded ✅");
        } catch (e) {
          try { window.RCF_LOGGER?.push?.("ERR", "app.js missing/failed ❌ ./app.js :: " + (e.message||e)); } catch {}
          log("app.js missing/failed ❌", (e.message||e));
        }

        // SW register (guard contra duplicidade)
        try {
          if (!window.__RCF_SW_REGISTERED__ && "serviceWorker" in navigator) {
            window.__RCF_SW_REGISTERED__ = true;
            navigator.serviceWorker.register("./sw.js", { scope: "./" })
              .then(() => {
                try { window.RCF_LOGGER?.push?.("BOOT", "sw register: ok (scope ./)"); } catch {}
                log("sw register ok");
              })
              .catch((e) => {
                try { window.RCF_LOGGER?.push?.("WARN", "sw register: fail/ignored :: " + (e?.message||e)); } catch {}
                log("sw register fail/ignored:", (e?.message||e));
              });
          }
        } catch {}
      }

      boot();
    })();
  </script>
</body>
</html>
