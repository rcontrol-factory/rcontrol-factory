<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RControl Factory</title>
  <meta name="theme-color" content="#0b1020" />

  <!-- ✅ importante: base relativo pra funcionar em /app/ -->
  <base href="./" />

  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />

  <style>
    /* ============================
       RCF BOOT PANEL (MINIMIZÁVEL)
       ============================ */
    #rcfBootWidget {
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index: 999999;
      pointer-events: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    /* botão quadrado (min) */
    #rcfBootMinBtn {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: #d7fbe2;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    #rcfBootMinBtn .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,.18);
      margin-right: 8px;
    }
    #rcfBootMinBtn .txt {
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
    }

    /* painel expandido */
    #rcfBootPanel {
      margin-top: 10px;
      width: min(520px, calc(100vw - 24px));
      max-height: 36vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;

      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: #d7fbe2;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    #rcfBootPanel.hidden { display: none; }

    #rcfBootHeader {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    #rcfBootTitle {
      font-weight: 900;
      font-size: 12px;
      opacity: .95;
    }

    .rcfBootBtn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.08);
      color: #fff;
      pointer-events: auto;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      font-weight: 700;
      font-size: 12px;
    }

    #rcfBootLog {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <noscript>Ative o JavaScript para usar o app.</noscript>

  <div id="app">
    <div style="padding:14px;font-family:system-ui">Carregando…</div>
  </div>

  <!-- ============================
       RCF BOOT WIDGET (MIN)
       ============================ -->
  <div id="rcfBootWidget">
    <!-- botão quadradinho (sempre visível) -->
    <div id="rcfBootMinBtn" role="button" aria-label="RCF Boot Panel">
      <span class="dot"></span>
      <span class="txt">RCF</span>
    </div>

    <!-- painel expandido -->
    <div id="rcfBootPanel" class="hidden">
      <div id="rcfBootHeader">
        <div id="rcfBootTitle">RCF BOOT</div>

        <button id="rcfExpandBtn" class="rcfBootBtn" style="margin-left:auto">Min</button>
        <button id="rcfCopyBtn" class="rcfBootBtn">Copy</button>
        <button id="rcfReloadBtn" class="rcfBootBtn">Reload</button>
        <button id="rcfHideBtn" class="rcfBootBtn">Hide</button>
      </div>

      <pre id="rcfBootLog">boot: init…</pre>
    </div>
  </div>

  <!-- ============================
       RCF BOOT SCRIPT
       ============================ -->
  <script>
    (function () {
      const LS_MIN = "rcf:bootpanel:min";

      const panel = document.getElementById("rcfBootPanel");
      const out = document.getElementById("rcfBootLog");

      const btnMinIcon = document.getElementById("rcfBootMinBtn");
      const btnExpand  = document.getElementById("rcfExpandBtn");
      const btnCopy    = document.getElementById("rcfCopyBtn");
      const btnReload  = document.getElementById("rcfReloadBtn");
      const btnHide    = document.getElementById("rcfHideBtn");

      function isMinSaved() {
        try { return localStorage.getItem(LS_MIN) !== "0"; } catch { return true; }
      }
      function saveMinState(min) {
        try { localStorage.setItem(LS_MIN, min ? "1" : "0"); } catch {}
      }

      function showPanel() {
        panel.classList.remove("hidden");
        if (btnExpand) btnExpand.textContent = "Min";
        saveMinState(false);
      }
      function hidePanel() {
        panel.classList.add("hidden");
        saveMinState(true);
      }
      function togglePanel() {
        if (panel.classList.contains("hidden")) showPanel();
        else hidePanel();
      }

      function bootLog(line){
        try {
          out.textContent += "\n" + line;
          out.scrollTop = out.scrollHeight;
        } catch {}
      }

      // estado inicial: MIN por padrão (pra não atrapalhar Safari)
      if (isMinSaved()) hidePanel(); else showPanel();

      // taps (iOS-safe)
      function bindTap(el, fn) {
        if (!el) return;
        let last = 0;
        const guard = (e) => {
          const now = Date.now();
          if (now - last < 350) { try { e.preventDefault(); e.stopPropagation(); } catch {} return; }
          last = now;
          try { e.preventDefault(); e.stopPropagation(); } catch {}
          try { fn(e); } catch {}
        };
        el.addEventListener("touchend", guard, { passive:false, capture:true });
        el.addEventListener("click", guard, { passive:false, capture:true });
      }

      bindTap(btnMinIcon, togglePanel);
      bindTap(btnExpand,  togglePanel);

      bindTap(btnReload, () => location.reload());

      bindTap(btnHide, () => {
        // Hide = some de vez nesta sessão (mas o botão quadrado fica)
        hidePanel();
      });

      bindTap(btnCopy, async () => {
        const text = String(out.textContent || "");
        try {
          await navigator.clipboard.writeText(text);
          bootLog("BOOT: copied ✅");
        } catch {
          bootLog("BOOT: copy blocked (iOS) — selecione e copie manual");
        }
      });

      // BootPanel logger (não substitui RCF_LOGGER real)
      bootLog("boot: widget ready (minimizable)");

      function loadScript(src){
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.async = false;
          s.onload = () => resolve(src);
          s.onerror = () => reject(new Error("load failed: " + src));
          document.head.appendChild(s);
        });
      }

      async function boot(){
        bootLog("BOOT: index boot: starting…");
        bootLog("BOOT: base href = " + document.baseURI);

        const modules = [
          "./js/core/logger.js",
          "./js/core/stability_guard.js",
          "./js/core/storage.js",
          "./js/core/github_sync.js",
          "./js/core/vfs_overrides.js",
          "./js/core/vfs_shim.js",
          "./js/core/mother_selfupdate.js",

          "./js/core/errors.js",
          "./js/core/risk.js",
          "./js/core/snapshot.js",
          "./js/core/selfheal.js",
          "./js/core/ui_safety.js",
          "./js/core/ui_compact_outputs.js",
          "./js/core/ui_bindings.js",
          "./js/core/diagnostics.js",
          "./js/core/publish_queue.js",
          "./js/core/preview_runner.js",
          "./js/core/policy.js",
          "./js/core/settings_cleanup.js",
          "./js/core/injector.js",

          "./js/admin.github.js"
        ];

        for (const src of modules) {
          try {
            await loadScript(src);
            try { window.RCF_LOGGER?.push?.("BOOT", "module loaded ✅ " + src); } catch {}
            bootLog("BOOT: module loaded ✅ " + src);
          } catch (e) {
            try { window.RCF_LOGGER?.push?.("WARN", "module missing/failed ❌ " + src + " :: " + (e.message||e)); } catch {}
            bootLog("WARN: module missing/failed ❌ " + src + " :: " + (e.message||e));
          }
        }

        try {
          await loadScript("./app.js");
          try { window.RCF_LOGGER?.push?.("BOOT", "app.js loaded ✅ ./app.js"); } catch {}
          bootLog("BOOT: app.js loaded ✅ ./app.js");
        } catch (e) {
          try { window.RCF_LOGGER?.push?.("ERR", "app.js missing/failed ❌ ./app.js :: " + (e.message||e)); } catch {}
          bootLog("ERR: app.js missing/failed ❌ ./app.js :: " + (e.message||e));
        }

        try {
          if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./sw.js", { scope: "./" })
              .then(() => {
                try { window.RCF_LOGGER?.push?.("BOOT", "sw register: ok (scope ./)"); } catch {}
                bootLog("BOOT: sw register: ok (scope ./)");
              })
              .catch((e) => {
                try { window.RCF_LOGGER?.push?.("WARN", "sw register: fail/ignored :: " + (e?.message||e)); } catch {}
                bootLog("WARN: sw register: fail/ignored :: " + (e?.message||e));
              });
          }
        } catch {}
      }

      boot();
    })();
  </script>
</body>
</html>
