<!-- FILE: app/index.html
     RControl Factory — /app/index.html — vSAFE-AUTOBOOT 2026-02-23
     ✅ Boot normal automático (entra direto na Factory)
     ✅ SAFE BOOT só em emergência (fallback automático se boot falhar)
     ✅ Botão "SAFE" no canto (abre/fecha painel)
     ✅ Param ?safe=1 força modo SAFE (não faz boot automático)
     ✅ Sem separadores "=====" fora de comentário
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RCF</title>
  <meta name="theme-color" content="#0b1020" />
  <base href="./" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
  <meta name="rcf-index" content="SAFE_AUTOBOOT_2026_02_23" />
  <style>
    /* fallback visual (se styles.css falhar) */
    :root{color-scheme:dark}
    body{background:#0b1020;color:#eaf0ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}
    .rcf_loading{padding:14px;max-width:920px;margin:0 auto}
    .rcf_pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.14);font-weight:800}
    .rcf_safe_wrap{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);display:none;z-index:999999}
    .rcf_safe{max-width:920px;margin:0 auto;padding:14px}
    .rcf_card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;margin:12px 0}
    .rcf_btn{border:0;border-radius:999px;padding:10px 12px;font-weight:800;margin:6px 8px 0 0}
    .r{background:#ff4d4d;color:#111}
    .g{background:#35d0b5;color:#111}
    .d{background:rgba(255,255,255,.12);color:#eaf0ff;border:1px solid rgba(255,255,255,.18)}
    pre{white-space:pre-wrap;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);min-height:160px;max-height:50vh;overflow:auto}
    code{background:rgba(255,255,255,.10);padding:2px 6px;border-radius:8px}

    /* botão SAFE flutuante */
    .rcf_safe_fab{
      position:fixed;right:10px;bottom:10px;z-index:999998;
      border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);color:#eaf0ff;font-weight:900;
      padding:10px 12px;
    }
  </style>
</head>

<body>
  <noscript>Ative o JavaScript para usar o app.</noscript>

  <!-- conteúdo normal -->
  <div id="app">
    <div class="rcf_loading">
      <div class="rcf_pill">RCF • carregando…</div>
      <div style="opacity:.85;margin-top:10px">
        Se der erro no boot, o modo SAFE abre sozinho.
      </div>
    </div>
  </div>

  <!-- botão SAFE (manual) -->
  <button class="rcf_safe_fab" id="rcfSafeFab" type="button">SAFE</button>

  <!-- painel SAFE (overlay) -->
  <div class="rcf_safe_wrap" id="rcfSafeWrap" aria-hidden="true">
    <div class="rcf_safe">
      <h2 style="margin:6px 0 0">RCF • SAFE BOOT</h2>

      <div class="rcf_card">
        <div><b>Objetivo:</b> recuperar controle (SW/cache/logs) se algo travar.</div>
        <div style="opacity:.9;margin-top:6px">
          Dica: abrir <code>/app/?safe=1</code> força ficar só no SAFE (não tenta boot).
        </div>

        <button class="rcf_btn r" id="u" type="button">Unregister SW</button>
        <button class="rcf_btn r" id="c" type="button">Clear Caches</button>
        <button class="rcf_btn d" id="k" type="button">Show SW status</button>
        <button class="rcf_btn g" id="boot" type="button">Tentar boot normal</button>
        <button class="rcf_btn d" id="closeSafe" type="button">Fechar</button>
      </div>

      <div class="rcf_card">
        <div><b>Log</b></div>
        <pre id="log">starting…</pre>
      </div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    // =========================================================
    // BOOT LOCK (evita double init por reload/duplo script)
    // =========================================================
    if (window.__RCF_INDEX_BOOTED__) return;
    window.__RCF_INDEX_BOOTED__ = true;

    const $ = (id)=> document.getElementById(id);
    const L = $("log");
    const ts = ()=> new Date().toISOString();
    const log = (...a)=>{ try{ L.textContent += "\n" + a.join(" "); }catch{} };

    const params = new URLSearchParams(location.search || "");
    const forceSafe = params.get("safe") === "1" || location.hash === "#safe";

    function showSafe(){
      const wrap = $("rcfSafeWrap");
      try{ wrap.style.display = "block"; wrap.setAttribute("aria-hidden","false"); }catch{}
    }
    function hideSafe(){
      const wrap = $("rcfSafeWrap");
      try{ wrap.style.display = "none"; wrap.setAttribute("aria-hidden","true"); }catch{}
    }

    // FAB toggle
    $("rcfSafeFab").onclick = ()=> {
      const wrap = $("rcfSafeWrap");
      const open = (wrap && wrap.style.display === "block");
      if (open) hideSafe(); else { showSafe(); swStatus(); }
    };
    $("closeSafe").onclick = hideSafe;

    log("[" + ts() + "] index loaded ✅ base=" + document.baseURI + " safe=" + forceSafe);

    async function unreg(){
      try{
        if(!("serviceWorker" in navigator)){ log("no SW support"); return; }
        const regs = await navigator.serviceWorker.getRegistrations();
        let ok=0;
        for(const r of regs){ try{ if(await r.unregister()) ok++; }catch(e){} }
        log("unregister ok=" + ok + " regs=" + regs.length);
      }catch(e){ log("unregister err", (e && e.message) ? e.message : String(e)); }
    }

    async function clearCaches(){
      try{
        if(!("caches" in window)){ log("no caches API"); return; }
        const keys = await caches.keys();
        let del=0;
        for(const k of keys){ try{ if(await caches.delete(k)) del++; }catch(e){} }
        log("caches deleted=" + del + " keys=" + keys.length);
      }catch(e){ log("caches err", (e && e.message) ? e.message : String(e)); }
    }

    async function swStatus(){
      try{
        const has = ("serviceWorker" in navigator);
        log("sw supported=" + has);
        if(!has) return;
        log("controller=" + (!!navigator.serviceWorker.controller));
        const regs = await navigator.serviceWorker.getRegistrations();
        log("regs=" + regs.length);
        for (const r of regs) {
          try{ log(" - scope=" + (r.scope||"") ); }catch{}
        }
      }catch(e){ log("status err", (e && e.message) ? e.message : String(e)); }
    }

    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = src + (src.includes("?") ? "&" : "?") + "cb=" + Date.now();
        s.async = false;
        s.onload = ()=> resolve(src);
        s.onerror = ()=> reject(new Error("load failed: " + src));
        document.head.appendChild(s);
      });
    }

    async function bootNormal(){
      log("[" + ts() + "] bootNormal…");

      const modules = [
        "./js/core/logger.js",
        "./js/core/stability_guard.js",
        "./js/core/storage.js",
        "./js/core/github_sync.js",
        "./js/core/vfs_overrides.js",
        "./js/core/vfs_shim.js",
        "./js/core/mother_selfupdate.js",
        "./js/core/errors.js",
        "./js/core/ui_safety.js",
        "./js/core/ui_compact_outputs.js",
        "./js/core/ui_bindings.js",
        "./js/core/doctor_scan.js",
        "./js/core/diagnostics.js",
        "./js/core/preview_runner.js",
        "./js/core/injector.js",
        "./js/engine/template_registry.js",
        "./js/engine/module_registry.js",
        "./js/engine/builder.js",
        "./js/engine/engine.js",
        "./js/core/pages_links.js",
        "./js/admin.github.js",
        "./app.js",
        "./js/core/zip_vault.js",
        "./js/core/agent_zip_bridge.js"
      ];

      let failed = 0;

      for (const src of modules) {
        try { await loadScript(src); log("loaded ✅", src); }
        catch(e){
          failed++;
          log("failed ❌", src, "::", (e && e.message) ? e.message : String(e));
          // se falhou algo essencial, já abre SAFE
          showSafe();
        }
      }

      log("[" + ts() + "] bootNormal finished. failed=" + failed);

      // fallback extra: se app não “assumir” em X segundos, abre SAFE
      try{
        setTimeout(()=>{
          try{
            // se não existe algum sinal de app (RCF) depois de um tempo, abre safe
            const hasRCF = !!(window.RCF || window.__RCF_BOOTED__ || window.__RCF_UI_READY__);
            if(!hasRCF){
              log("fallback: no RCF signal -> SAFE");
              showSafe();
            }
          }catch{}
        }, 2500);
      }catch{}
    }

    $("u").onclick = unreg;
    $("c").onclick = clearCaches;
    $("k").onclick = swStatus;
    $("boot").onclick = bootNormal;

    // =========================================================
    // START
    // =========================================================
    if (forceSafe){
      showSafe();
      swStatus();
      log("SAFE only mode (no autoboot).");
    } else {
      // entra direto na Factory (autoboot)
      try { hideSafe(); } catch {}
      bootNormal().catch((e)=>{
        log("bootNormal fatal", (e && e.message) ? e.message : String(e));
        showSafe();
      });
    }
  })();
  </script>
</body>
</html>
