<!-- FILE: /app/index.html
     RCF — INDEX DIAG (BOOT SCREEN) — vDIAG-1
     Objetivo: mostrar na tela qual módulo travou/errou, sem console.
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RCF</title>
  <meta name="theme-color" content="#0b1020" />
  <base href="./" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
  <meta name="rcf-index" content="vDIAG-1" />
  <style>
    /* fallback caso styles.css não carregue */
    body{background:#0b1020;color:#e8ecff;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;}
    .diag{padding:14px;white-space:pre-wrap;line-height:1.25;font-size:12px;}
    .ok{color:#8ff0a4}
    .warn{color:#ffd37a}
    .err{color:#ff7b7b}
    .mut{opacity:.85}
  </style>
</head>

<body>
  <div id="app">
    <div class="diag" id="diag">RCF BOOT DIAG…\n</div>
  </div>

  <script>
    (function () {
      if (window.__RCF_INDEX_BOOTED__) return;
      window.__RCF_INDEX_BOOTED__ = true;

      const diagEl = document.getElementById("diag");
      function line(txt, cls){
        try {
          const d = document.createElement("div");
          if (cls) d.className = cls;
          d.textContent = txt;
          diagEl.appendChild(d);
        } catch {}
      }
      function hr(){ line("—".repeat(36), "mut"); }

      function loadScript(src){
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          // quebra cache forte por querystring (não depende de SW)
          const bust = "v=" + Date.now();
          s.src = src + (src.includes("?") ? "&" : "?") + bust;
          s.async = false;
          s.onload = () => resolve(src);
          s.onerror = () => reject(new Error("load failed: " + src));
          document.head.appendChild(s);
        });
      }

      async function boot(){
        line("BOOT: starting… base=" + document.baseURI, "mut");
        hr();

        const modules = [
          "./js/core/logger.js",
          "./js/core/stability_guard.js",
          "./js/core/storage.js",
          "./js/core/vendor_loader.js",
          "./js/core/vendor_health.js",
          "./js/core/github_sync.js",
          "./js/core/vfs_overrides.js",
          "./js/core/vfs_shim.js",
          "./js/core/mother_selfupdate.js",
          "./js/core/errors.js",
          "./js/core/risk.js",
          "./js/core/snapshot.js",
          "./js/core/selfheal.js",
          "./js/core/ui_safety.js",
          "./js/core/ui_compact_outputs.js",
          "./js/core/ui_bindings.js",
          "./js/core/diagnostics.js",
          "./js/core/publish_queue.js",
          "./js/core/preview_runner.js",
          "./js/core/policy.js",
          "./js/core/settings_cleanup.js",
          "./js/core/injector.js",

          "./js/engine/template_registry.js",
          "./js/engine/module_registry.js",
          "./js/engine/builder.js",
          "./js/engine/engine.js",

          "./js/core/pages_links.js",
          "./js/admin.github.js"
        ];

        for (const src of modules) {
          try {
            await loadScript(src);
            line("✅ " + src, "ok");
          } catch (e) {
            line("❌ " + src, "err");
            line("ERR: " + (e && (e.message || e)) , "err");
            hr();
            line("PAROU AQUI. Esse arquivo travou o boot.", "err");
            return;
          }
        }

        hr();
        line("Agora carregando app.js…", "mut");

        try {
          await loadScript("./app.js");
          line("✅ ./app.js", "ok");
        } catch (e) {
          line("❌ ./app.js", "err");
          line("ERR: " + (e && (e.message || e)) , "err");
          line("Se app.js falhar, a UI nunca monta e fica em Carregando.", "warn");
          return;
        }

        hr();
        line("Boot DIAG completou. Se ainda travar, o erro é runtime dentro do app.js ou de algum módulo.", "mut");

        // tenta registrar SW (opcional)
        try {
          if ("serviceWorker" in navigator) {
            line("SW: registrando…", "mut");
            navigator.serviceWorker.register("./sw.js", { scope: "./" })
              .then(() => line("SW: ok", "ok"))
              .catch((e) => line("SW: fail/ignored: " + (e?.message||e), "warn"));
          }
        } catch {}
      }

      boot();
    })();
  </script>
</body>
</html>
