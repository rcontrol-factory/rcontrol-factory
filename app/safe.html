<!-- FILE: app/safe.html
     RCF — SAFE BOOT (separado) v1.3
     ✅ Página de emergência: SW/Caches/Status/Log
     ✅ "Boot normal agora" carrega módulos (somente aqui)
     ✅ Some sozinho quando a UI sobe (RCF:UI_READY)
-->

<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RCF • SAFE BOOT</title>
  <meta name="theme-color" content="#0b1020" />
  <base href="./" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
  <meta name="rcf-index" content="SAFE_BOOT_SEPARATE_2026_02_24_v1_3" />
  <style>
    body{background:#0b1020;color:#eaf0ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .rcf_safe{max-width:920px;margin:0 auto;padding:14px}
    .rcf_card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;margin:12px 0}
    .rcf_btn{border:0;border-radius:999px;padding:10px 12px;font-weight:800;margin:6px 8px 0 0}
    .r{background:#ff4d4d;color:#111}
    .g{background:#35d0b5;color:#111}
    .d{background:rgba(255,255,255,.12);color:#eaf0ff;border:1px solid rgba(255,255,255,.18)}
    pre{white-space:pre-wrap;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);min-height:160px}
    code{background:rgba(255,255,255,.10);padding:2px 6px;border-radius:8px}
    .rcf_hint{opacity:.85;margin-top:8px;font-size:13px;line-height:1.35}
    .row{display:flex;flex-wrap:wrap;align-items:center;gap:8px}
    .sep{height:1px;background:rgba(255,255,255,.12);margin:12px 0}
    .mini{opacity:.85;font-size:12px}
  </style>
</head>

<body>
  <noscript>Ative o JavaScript para usar o app.</noscript>

  <div id="app">
    <div class="rcf_safe" id="rcfSafeBootUI">
      <h2>RCF • SAFE BOOT</h2>

      <div class="rcf_card">
        <div><b>Objetivo:</b> sair de tela preta / recuperar controle do SW + Cache.</div>
        <div style="opacity:.9;margin-top:6px">
          Use esta página só quando precisar. Para voltar ao normal: abra <code>index.html</code> (ou remova <code>?safe=1</code>).
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="rcf_btn r" id="u">Unregister SW</button>
          <button class="rcf_btn r" id="c">Clear Caches</button>
          <button class="rcf_btn d" id="k">Show SW status</button>
          <button class="rcf_btn d" id="home">Abrir Factory (normal)</button>
          <button class="rcf_btn g" id="boot">Boot normal agora (via SAFE)</button>
        </div>

        <div class="rcf_hint" id="hint">
          • Esta tela é separada do index normal.<br/>
          • Se o boot via SAFE falhar, o log aqui mostra qual módulo quebrou.
        </div>

        <div class="mini" id="meta"></div>
      </div>

      <div class="rcf_card">
        <div><b>Log</b></div>
        <pre id="log">starting…</pre>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const L = document.getElementById("log");
    const UI = document.getElementById("rcfSafeBootUI");
    const META = document.getElementById("meta");
    const log = (...a)=>{ try{ L.textContent += "\n" + a.join(" "); }catch{} };

    const ts = ()=> new Date().toISOString();
    log("[" + ts() + "] SAFE_BOOT loaded ✅ base=" + document.baseURI);
    try{
      META.textContent = "href=" + location.href + " | ua=" + (navigator.userAgent || "");
    }catch{}

    // parâmetros
    let params;
    try{ params = new URLSearchParams(location.search || ""); }catch{ params = null; }
    const forceSafe = !!(params && params.get("safe") === "1");
    if (forceSafe) log("INFO: safe=1 ✅");

    async function unreg(){
      try{
        if(!("serviceWorker" in navigator)){ log("no SW support"); return; }
        const regs = await navigator.serviceWorker.getRegistrations();
        let ok=0;
        for(const r of regs){ try{ if(await r.unregister()) ok++; }catch(e){} }
        log("unregister ok=" + ok + " regs=" + regs.length);
      }catch(e){ log("unregister err", (e && e.message) ? e.message : String(e)); }
    }

    async function clearCaches(){
      try{
        if(!("caches" in window)){ log("no caches API"); return; }
        const keys = await caches.keys();
        let del=0;
        for(const k of keys){ try{ if(await caches.delete(k)) del++; }catch(e){} }
        log("caches deleted=" + del + " keys=" + keys.length);
      }catch(e){ log("caches err", (e && e.message) ? e.message : String(e)); }
    }

    async function swStatus(){
      try{
        const has = ("serviceWorker" in navigator);
        log("sw supported=" + has);
        if(!has) return;
        log("controller=" + (!!navigator.serviceWorker.controller));
        const regs = await navigator.serviceWorker.getRegistrations();
        log("regs=" + regs.length);
        for (const r of regs) {
          try{ log(" - scope=" + (r.scope||"") ); }catch{}
        }
      }catch(e){ log("status err", (e && e.message) ? e.message : String(e)); }
    }

    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        // cache-buster só aqui no SAFE (não mexe no index normal)
        s.src = src + (src.includes("?") ? "&" : "?") + "cb=" + Date.now();
        s.async = false;
        s.onload = ()=> resolve(src);
        s.onerror = ()=> reject(new Error("load failed: " + src));
        document.head.appendChild(s);
      });
    }

    async function bootNormal(){
      if (window.__RCF_SAFE_BOOTING__) { log("INFO: boot already running"); return; }
      window.__RCF_SAFE_BOOTING__ = true;

      log("[" + ts() + "] bootNormal…");

      const modules = [
        "./js/core/logger.js",
        "./js/core/stability_guard.js",
        "./js/core/storage.js",
        "./js/core/github_sync.js",
        "./js/core/vfs_overrides.js",
        "./js/core/vfs_shim.js",
        "./js/core/mother_selfupdate.js",
        "./js/core/errors.js",
        "./js/core/ui_safety.js",
        "./js/core/ui_compact_outputs.js",
        "./js/core/ui_bindings.js",
        "./js/core/diagnostics.js",
        "./js/core/preview_runner.js",
        "./js/core/injector.js",
        "./js/engine/template_registry.js",
        "./js/engine/module_registry.js",
        "./js/engine/builder.js",
        "./js/engine/engine.js",
        "./js/core/pages_links.js",
        "./js/admin.github.js",
        "./app.js",
        "./js/core/zip_vault.js",
        "./js/core/agent_zip_bridge.js"
      ];

      let fails = 0;
      for (const src of modules) {
        try { await loadScript(src); log("loaded ✅", src); }
        catch(e){
          fails++;
          log("failed ❌", src, "::", (e && e.message) ? e.message : String(e));
        }
      }

      log("[" + ts() + "] bootNormal finished. fails=" + fails);
    }

    // some o SAFE BOOT quando o app avisar que montou UI
    try{
      window.addEventListener("RCF:UI_READY", ()=>{
        try{
          log("INFO: UI_READY recebido ✅ (escondendo SAFE BOOT)");
          if (UI) UI.style.display = "none";
        }catch{}
      });
    }catch{}

    // botões
    document.getElementById("u").onclick = unreg;
    document.getElementById("c").onclick = clearCaches;
    document.getElementById("k").onclick = swStatus;
    document.getElementById("boot").onclick = bootNormal;

    document.getElementById("home").onclick = function(){
      try{
        // vai pro index normal (remove safe=1)
        const u = new URL(location.href);
        u.searchParams.delete("safe");
        // se veio com safe=1, volta para index.html
        const target = "./index.html" + (u.search ? u.search : "");
        location.href = target;
      }catch(e){
        location.href = "./index.html";
      }
    };

    // status inicial
    swStatus();
  })();
  </script>
</body>
</html>
