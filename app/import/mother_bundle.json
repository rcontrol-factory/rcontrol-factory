{
  "files": {
    "/index.html": {
      "content": "<!doctype html>\n<html lang=\"pt-BR\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1,viewport-fit=cover\" />\n  <title>RControl Factory</title>\n  <meta name=\"theme-color\" content=\"#0b1020\" />\n\n  <!-- ‚úÖ importante: base relativo pra funcionar em /app/ -->\n  <base href=\"./\" />\n\n  <link rel=\"manifest\" href=\"./manifest.json\" />\n  <link rel=\"stylesheet\" href=\"./styles.css\" />\n</head>\n<body>\n  <noscript>Ative o JavaScript para usar o app.</noscript>\n\n  <div id=\"app\">\n    <div style=\"padding:14px;font-family:system-ui\">Carregando‚Ä¶</div>\n  </div>\n\n  <!-- ‚úÖ BootPanel (sempre vis√≠vel) -->\n  <div id=\"rcfBootPanel\" style=\"\n    position:fixed; left:12px; right:12px; bottom:12px;\n    z-index:999999; padding:12px; border-radius:14px;\n    background:rgba(0,0,0,.55); color:#d7fbe2;\n    border:1px solid rgba(255,255,255,.10);\n    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;\n    font-size:12px; line-height:1.35;\n    max-height:36vh; overflow:auto;\">\n    <div style=\"display:flex; gap:8px; align-items:center; margin-bottom:8px;\">\n      <div style=\"font-weight:800;\">RCF BOOT</div>\n      <button id=\"rcfReloadBtn\" style=\"\n        margin-left:auto; padding:6px 10px; border-radius:999px;\n        border:1px solid rgba(255,255,255,.15);\n        background:rgba(255,255,255,.08); color:#fff;\">Reload</button>\n      <button id=\"rcfHideBtn\" style=\"\n        padding:6px 10px; border-radius:999px;\n        border:1px solid rgba(255,255,255,.15);\n        background:rgba(255,255,255,.08); color:#fff;\">Hide</button>\n    </div>\n    <pre id=\"rcfBootLog\" style=\"margin:0; white-space:pre-wrap;\">boot: init‚Ä¶</pre>\n  </div>\n\n  <script>\n    (function () {\n      const out = document.getElementById(\"rcfBootLog\");\n      function p(line){\n        try {\n          out.textContent += \"\\n\" + line;\n          out.scrollTop = out.scrollHeight;\n        } catch {}\n      }\n\n      // bot√µes\n      try {\n        document.getElementById(\"rcfReloadBtn\").onclick = () => location.reload();\n        document.getElementById(\"rcfHideBtn\").onclick = () => {\n          const pan = document.getElementById(\"rcfBootPanel\");\n          if (pan) pan.style.display = \"none\";\n        };\n      } catch {}\n\n      // logger global (n√£o sobrescreve se logger.js j√° criar)\n      window.RCF_LOGGER = window.RCF_LOGGER || {\n        push(level, msg){\n          const line = \"[\" + level + \"] \" + msg;\n          p(line);\n          try { console.log(line); } catch {}\n        }\n      };\n\n      // pega erros que travam em ‚ÄúCarregando‚Ä¶‚Äù\n      window.addEventListener(\"error\", (e) => {\n        const m = (e && (e.message || e.error?.message)) || \"Erro desconhecido\";\n        window.RCF_LOGGER.push(\"err\", \"GLOBAL_ERROR: \" + m);\n      });\n      window.addEventListener(\"unhandledrejection\", (e) => {\n        const m = e?.reason?.message || String(e?.reason || \"Promise rejection\");\n        window.RCF_LOGGER.push(\"err\", \"UNHANDLED_REJECTION: \" + m);\n      });\n\n      function loadScript(src){\n        return new Promise((resolve, reject) => {\n          const s = document.createElement(\"script\");\n          s.src = src;\n          s.async = false;\n          s.onload = () => resolve(src);\n          s.onerror = () => reject(new Error(\"load failed: \" + src));\n          document.head.appendChild(s);\n        });\n      }\n\n      async function boot(){\n        window.RCF_LOGGER.push(\"BOOT\", \"index boot: starting‚Ä¶\");\n        window.RCF_LOGGER.push(\"BOOT\", \"base href = \" + document.baseURI);\n\n        // ‚úÖ ordem m√≠nima (antes do app.js)\n        const modules = [\n          \"./js/core/logger.js\",\n          \"./js/core/storage.js\",\n          \"./js/core/github_sync.js\",\n          \"./js/core/vfs_overrides.js\",\n          \"./js/core/mother_selfupdate.js\",\n          \"./js/admin.github.js\"\n        ];\n\n        for (const src of modules) {\n          try {\n            await loadScript(src);\n            window.RCF_LOGGER.push(\"BOOT\", \"module loaded ‚úÖ \" + src);\n          } catch (e) {\n            window.RCF_LOGGER.push(\"WARN\", \"module missing/failed ‚ùå \" + src + \" :: \" + (e.message||e));\n          }\n        }\n\n        // app principal\n        try {\n          await loadScript(\"./app.js\");\n          window.RCF_LOGGER.push(\"BOOT\", \"app.js loaded ‚úÖ ./app.js\");\n        } catch (e) {\n          window.RCF_LOGGER.push(\"ERR\", \"app.js missing/failed ‚ùå ./app.js :: \" + (e.message||e));\n        }\n\n        // ‚úÖ SW (scope ./) ‚Äî PADR√ÉO /app/\n        // IMPORTANTE: depois que eu revisar seu app.js, vamos manter o register APENAS AQUI (ou s√≥ l√°).\n        try {\n          if (\"serviceWorker\" in navigator) {\n            navigator.serviceWorker.register(\"./sw.js\", { scope: \"./\" })\n              .then(() => window.RCF_LOGGER.push(\"BOOT\", \"sw register: ok (scope ./)\"))\n              .catch((e) => window.RCF_LOGGER.push(\"WARN\", \"sw register: fail/ignored :: \" + (e?.message||e)));\n          }\n        } catch {}\n      }\n\n      boot();\n    })();\n  </script>\n</body>\n</html>\n",
      "contentType": "text/html; charset=utf-8"
    },
    "/styles.css": {
      "content": ":root{\n  --bg:#070b12;\n  --panel:#0b1220;\n  --panel2:#0f1a2d;\n  --line:rgba(255,255,255,.08);\n  --text:rgba(255,255,255,.92);\n  --muted:rgba(255,255,255,.65);\n  --accent:#16c784;\n  --danger:#d35a5a;\n  --shadow: 0 20px 60px rgba(0,0,0,.45);\n  --radius: 18px;\n  --radius2: 14px;\n  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;\n  --ui: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial;\n\n  /* V7 token */\n  --rcf-css-token:\"v7\";\n}\n\n*{ box-sizing:border-box; }\nhtml,body{ height:100%; }\nhtml{ -webkit-text-size-adjust: 100%; }\n\nbody{\n  margin:0;\n  font-family:var(--ui);\n  background:\n    radial-gradient(1200px 600px at 30% 10%, rgba(22,199,132,.12), transparent 60%),\n    radial-gradient(800px 400px at 90% 20%, rgba(72,120,255,.10), transparent 55%),\n    var(--bg);\n  color:var(--text);\n\n  /* iOS: evita bugs de empilhamento */\n  position: relative;\n  isolation: isolate;\n}\n\n/* =================================\n   iOS CLICK HARDENING (base)\n   ================================= */\n#app, #rcfRoot, header, main, nav, section,\n.views, .view, .container, .card, .row, .tabs, .topbar{\n  pointer-events: auto !important;\n  position: relative;\n}\n\nbutton, a, .btn, .tab, input, textarea, select, label{\n  pointer-events: auto !important;\n  touch-action: manipulation !important;\n  -webkit-tap-highlight-color: transparent;\n}\n\n/* =================================\n   TOP BAR\n   ================================= */\n.topbar{\n  position: sticky;\n  top:0;\n  z-index: 1000;\n  background: linear-gradient(to bottom, rgba(7,11,18,.92), rgba(7,11,18,.70));\n  backdrop-filter: blur(10px);\n  -webkit-backdrop-filter: blur(10px);\n  border-bottom: 1px solid var(--line);\n}\n\n.brand{\n  display:flex;\n  gap:12px;\n  padding: 14px 16px 6px;\n  align-items:center;\n}\n.dot{\n  width:12px;height:12px;border-radius:50%;\n  background: var(--accent);\n  box-shadow: 0 0 0 6px rgba(22,199,132,.10);\n}\n.brand-text .title{ font-weight:800; font-size:18px; }\n.brand-text .subtitle{ color:var(--muted); font-size:13px; margin-top:2px; }\n\n.tabs{\n  display:flex;\n  gap:10px;\n  padding: 10px 12px 14px;\n  align-items:center;\n  flex-wrap: wrap;\n}\n\n.spacer{ flex:1; }\n\n/* Bot√µes/abas */\n.tab, .btn, .dockbtn, .gear{\n  border:1px solid var(--line);\n  background: rgba(255,255,255,.03);\n  color:var(--text);\n  padding: 10px 14px;\n  border-radius: 999px;\n  cursor:pointer;\n  user-select:none;\n}\n\n.tab.active{\n  border-color: rgba(22,199,132,.45);\n  box-shadow: 0 0 0 6px rgba(22,199,132,.10);\n}\n\n.status-pill{\n  display:flex; align-items:center; gap:8px;\n  padding: 10px 14px;\n  border-radius:999px;\n  border:1px solid var(--line);\n  background: rgba(255,255,255,.03);\n}\n.status-pill .ok{ font-size:14px; }\n\n/* =================================\n   CONTE√öDO\n   ================================= */\n.container{\n  max-width: 980px;\n  margin: 14px auto 110px;\n  padding: 0 12px;\n  z-index: 1;\n}\n\n.card{\n  background: linear-gradient(180deg, rgba(15,26,45,.65), rgba(11,18,32,.75));\n  border:1px solid var(--line);\n  border-radius: var(--radius);\n  box-shadow: var(--shadow);\n  padding: 16px;\n  margin-bottom: 14px;\n  z-index: 1;\n}\n\n.hero h1{ margin: 0 0 6px; font-size: 36px; }\n.hero p{ margin: 0 0 12px; color: var(--muted); }\n\n.row{\n  display:flex;\n  gap:10px;\n  flex-wrap:wrap;\n  align-items:center;\n  margin: 10px 0;\n}\n\n.btn.small{ padding: 8px 12px; font-size: 13px; }\n.btn.ok{\n  background: rgba(22,199,132,.12);\n  border-color: rgba(22,199,132,.45);\n}\n.btn.danger{\n  background: rgba(211,90,90,.14);\n  border-color: rgba(211,90,90,.45);\n}\n.btn.ghost{ background: rgba(255,255,255,.02); }\n\nh1,h2{ margin: 0 0 10px; }\nh2{ margin-top: 12px; }\n\n.hint{ color: var(--muted); font-size: 13px; }\n\n.apps{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }\n.app-item{\n  display:flex; align-items:center; justify-content:space-between;\n  border:1px solid var(--line);\n  border-radius: 14px;\n  padding: 12px;\n  background: rgba(255,255,255,.02);\n}\n\n.badge{\n  padding: 8px 12px;\n  border-radius: 999px;\n  border:1px solid rgba(22,199,132,.45);\n  background: rgba(22,199,132,.10);\n  font-weight:700;\n}\n\n.status-box{\n  border: 1px dashed rgba(255,255,255,.18);\n  border-radius: 14px;\n  padding: 14px;\n  display:flex;\n  gap:10px;\n  align-items:center;\n}\n\n/* views */\n.view{ display:none; }\n.view.active{ display:block; }\n\n.form input, textarea, .cmd input{\n  width:100%;\n  border:1px solid var(--line);\n  background: rgba(0,0,0,.20);\n  color: var(--text);\n  border-radius: 14px;\n  padding: 12px 12px;\n  outline:none;\n}\n\ntextarea{ min-height: 120px; resize: vertical; }\n\n.files{\n  display:flex;\n  flex-direction:column;\n  gap:10px;\n  margin: 10px 0;\n}\n.file-item{\n  padding: 12px;\n  border-radius: 14px;\n  border: 1px solid var(--line);\n  background: rgba(255,255,255,.02);\n  cursor:pointer;\n}\n.file-item.active{\n  border-color: rgba(22,199,132,.45);\n  box-shadow: 0 0 0 6px rgba(22,199,132,.10);\n}\n\n.editor{\n  margin-top: 10px;\n  border-radius: var(--radius2);\n  border: 1px solid var(--line);\n  overflow:hidden;\n}\n.editor-head{\n  padding: 10px 12px;\n  background: rgba(255,255,255,.03);\n  border-bottom:1px solid var(--line);\n  color: var(--muted);\n}\n#fileContent{\n  width:100%;\n  min-height: 320px;\n  font-family: var(--mono);\n  font-size: 13px;\n  line-height: 1.45;\n  padding: 12px;\n  border:0;\n  border-radius:0;\n  outline:none;\n  background: rgba(0,0,0,.18);\n  color: rgba(255,255,255,.90);\n}\n\n.mono{\n  font-family: var(--mono);\n  white-space: pre-wrap;\n  background: rgba(0,0,0,.18);\n  border:1px solid var(--line);\n  border-radius: 14px;\n  padding: 12px;\n  margin: 10px 0 0;\n}\n.mono.small{ font-size: 12px; }\n\n/* OUTPUT BOXES (GitHub / Maintenance / Logs) */\n#ghOut, #maintOut, #adminOut, #agentOut, #editorOut, #genOut, #diagOut, #logsOut, #logsBox, #logsViewBox{\n  display:block;\n  width:100%;\n  min-height:90px;\n  padding:12px 12px;\n  margin-top:10px;\n  border-radius:14px;\n  border:1px solid rgba(255,255,255,.10);\n  background: rgba(0,0,0,.28);\n  color: rgba(255,255,255,.92);\n  white-space: pre-wrap;\n  word-break: break-word;\n  overflow:auto;\n  -webkit-overflow-scrolling: touch;\n  line-height: 1.35;\n  font-family: var(--mono);\n  font-size: 13px;\n}\n#maintOut{ min-height:120px; }\n\n/* =================================\n   TOOLS DRAWER\n   ================================= */\n.tools{\n  position: fixed;\n  top: 12px;\n  right: 12px;\n  width: min(520px, calc(100% - 24px));\n  max-height: calc(100% - 24px);\n  background: linear-gradient(180deg, rgba(15,26,45,.92), rgba(11,18,32,.92));\n  border: 1px solid var(--line);\n  border-radius: var(--radius);\n  box-shadow: var(--shadow);\n  display:none;\n  z-index: 99999;\n  overflow:hidden;\n\n  /* fechado: n√£o captura toque */\n  pointer-events: none;\n}\n.tools.open{\n  display:block;\n  pointer-events: auto;\n}\n.tools.open, .tools.open *{\n  pointer-events: auto !important;\n  touch-action: manipulation;\n}\n\n.tools-head{\n  padding: 12px;\n  display:flex;\n  align-items:center;\n  justify-content:space-between;\n  border-bottom: 1px solid var(--line);\n}\n.tools-body{ padding: 12px; }\n\n/* =================================\n   GEAR MODAL\n   ================================= */\n.rcf-gear-backdrop{\n  position: fixed; inset: 0;\n  background: rgba(0,0,0,.45);\n  backdrop-filter: blur(6px);\n  -webkit-backdrop-filter: blur(6px);\n  z-index: 99998;\n  display:flex;\n  align-items:flex-end;\n  justify-content:center;\n  padding: 16px;\n\n  /* fechado por default (se voc√™ usar classe/open no JS) */\n  pointer-events: none;\n}\n.rcf-gear-backdrop.open{ pointer-events: auto; }\n\n.rcf-gear-sheet{\n  width: min(560px, 100%);\n  background: rgba(11,18,32,.92);\n  border: 1px solid rgba(255,255,255,.08);\n  border-radius: 16px;\n  box-shadow: 0 20px 60px rgba(0,0,0,.45);\n  padding: 14px;\n}\n.rcf-gear-sheet h3{ margin: 0 0 10px 0; font-size: 16px; }\n.rcf-gear-grid{ display:flex; gap:10px; flex-wrap:wrap; }\n.rcf-gear-grid .btn{ flex: 1 1 160px; }\n\n/* =================================\n   OVERLAYS GEN√âRICOS: n√£o podem bloquear toque\n   (mas SEM matar .glass/.blur do layout)\n   ================================= */\n.overlay, .backdrop, #overlay, #backdrop, .scrim, .modal, .sheet{\n  pointer-events: none !important;\n}\n\n/* checkbox (iOS) */\ninput[type=\"checkbox\"]{\n  pointer-events:auto !important;\n  -webkit-appearance: auto !important;\n  appearance: auto !important;\n  width: 22px;\n  height: 22px;\n}\n\n/* Switch */\n.switch{ position:relative; width:44px; height:26px; display:inline-block; }\n.switch input{ display:none; }\n.slider{\n  position:absolute; inset:0;\n  border-radius:999px;\n  background: rgba(255,255,255,.18);\n  border:1px solid var(--line);\n  transition: .2s;\n}\n.slider::after{\n  content:\"\";\n  position:absolute;\n  width:20px;height:20px;\n  top:2px; left:2px;\n  border-radius:50%;\n  background: rgba(255,255,255,.90);\n  transition:.2s;\n}\n.switch input:checked + .slider{\n  background: rgba(22,199,132,.25);\n  border-color: rgba(22,199,132,.45);\n}\n.switch input:checked + .slider::after{ transform: translateX(18px); }\n",
      "contentType": "text/css; charset=utf-8"
    },
    "/app.js": {
      "content": "/* RControl Factory ‚Äî app.js (V7.1 + FASE A REAL SCAN/TARGET/INJECT + PADR√ÉO: admin.github.js separado)\n   - ‚úÖ PADR√ÉO: GitHub Admin UI fica em /app/js/admin.github.js (remove duplicidade do card GitHub no app.js)\n   - ‚úÖ FIX: window.RCF.state BEFORE init (timing)\n   - ‚úÖ FASE A: scanFactoryFiles + generateTargetMap + injectorEngine (SAFE)\n   - Inventory REAL: A (VFS runtime) -> B (mother_bundle local) -> C (DOM anchors only)\n   - ‚úÖ FIX: SW stability vira AUTO-FIX + WARN (n√£o derruba RCF_STABLE por timing)\n   - ‚úÖ FIX: Injector funciona sem VFS runtime via Overrides VFS (localStorage)\n   - ‚úÖ FIX CR√çTICO iOS: bindTap N√ÉO dispara 2x\n   - ‚úÖ FIX: trava reentrada do Update From GitHub (evita TIMEOUT em put(/index.html))\n   - ‚úÖ FIX CP1/CP2/CP3: scan em cascata real (A->B->C), target map garante >=2, dropdown atualiza + auto-select\n   - ‚úÖ PATCH: Scan A n√£o ‚Äúmente‚Äù quando s√≥ existem overrides\n   - ‚úÖ PATCH: fallback de targets usa /index.html primeiro (bundle real)\n   - ‚úÖ PATCH: SW register usa ./sw.js + scope ./ (Pages/subpath safe)\n   - ‚úÖ PATCH: fetch do bundle resolve com baseURI (subpath safe)\n*/\n\n(() => {\n  \"use strict\";\n\n  // -----------------------------\n  // BOOT LOCK (evita double init)\n  // -----------------------------\n  if (window.__RCF_BOOTED__) return;\n  window.__RCF_BOOTED__ = true;\n\n  // -----------------------------\n  // Utils\n  // -----------------------------\n  const $ = (sel, root = document) => root.querySelector(sel);\n  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));\n  const nowISO = () => new Date().toISOString();\n\n  const slugify = (str) => {\n    return String(str || \"\")\n      .trim()\n      .toLowerCase()\n      .normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\n      .replace(/[^a-z0-9]+/g, \"-\")\n      .replace(/^-+|-+$/g, \"\");\n  };\n\n  const safeJsonParse = (s, fallback) => { try { return JSON.parse(s); } catch { return fallback; } };\n  const safeJsonStringify = (obj) => { try { return JSON.stringify(obj); } catch { return String(obj); } };\n\n  const escapeHtml = (s) => String(s).replace(/[&<>\"]/g, c => ({ \"&\":\"&amp;\",\"<\":\"&lt;\",\">\":\"&gt;\",'\"':\"&quot;\" }[c]));\n  const escapeAttr = (s) => escapeHtml(s).replace(/'/g, \"&#39;\");\n\n  const uiMsg = (sel, text) => { const el = $(sel); if (el) el.textContent = String(text ?? \"\"); };\n  const textContentSafe = (el, txt) => { try { el.textContent = txt; } catch {} };\n\n  function safeSetStatus(txt) {\n    try {\n      const el = $(\"#statusText\");\n      if (el) el.textContent = String(txt || \"\");\n    } catch {}\n  }\n\n  // -----------------------------\n  // Storage\n  // -----------------------------\n  const Storage = {\n    prefix: \"rcf:\",\n    get(key, fallback) {\n      try {\n        const v = localStorage.getItem(this.prefix + key);\n        if (v == null) return fallback;\n        return safeJsonParse(v, fallback);\n      } catch {\n        return fallback;\n      }\n    },\n    set(key, value) {\n      try { localStorage.setItem(this.prefix + key, JSON.stringify(value)); } catch {}\n    },\n    setRaw(key, rawText) {\n      try { localStorage.setItem(this.prefix + key, String(rawText ?? \"\")); } catch {}\n    },\n    getRaw(key, fallback = \"\") {\n      try {\n        const v = localStorage.getItem(this.prefix + key);\n        return v == null ? fallback : String(v);\n      } catch {\n        return fallback;\n      }\n    },\n    del(key) { try { localStorage.removeItem(this.prefix + key); } catch {} }\n  };\n\n  // -----------------------------\n  // Logger\n  // -----------------------------\n  const Logger = {\n    bufKey: \"logs\",\n    max: 900,\n\n    _mirrorUI(logs) {\n      const txt = (logs || []).join(\"\\n\");\n      const boxDrawer = $(\"#logsBox\");\n      if (boxDrawer) boxDrawer.textContent = txt;\n      const boxLogsOut = $(\"#logsOut\");\n      if (boxLogsOut) boxLogsOut.textContent = txt;\n      const boxView = $(\"#logsViewBox\");\n      if (boxView) boxView.textContent = txt;\n\n      // Admin injector outputs\n      const injLog = $(\"#injLog\");\n      if (injLog) injLog.textContent = txt.slice(-8000);\n    },\n\n    write(...args) {\n      const msg = args.map(a => (typeof a === \"string\" ? a : safeJsonStringify(a))).join(\" \");\n      const line = `[${new Date().toLocaleString()}] ${msg}`;\n      const logs = Storage.get(this.bufKey, []);\n      logs.push(line);\n      while (logs.length > this.max) logs.shift();\n      Storage.set(this.bufKey, logs);\n      this._mirrorUI(logs);\n      try { console.log(\"[RCF]\", ...args); } catch {}\n    },\n\n    clear() {\n      Storage.set(this.bufKey, []);\n      this._mirrorUI([]);\n    },\n\n    getAll() { return Storage.get(this.bufKey, []); }\n  };\n\n  window.RCF_LOGGER = window.RCF_LOGGER || {\n    push(level, msg) { Logger.write(String(level || \"log\") + \":\", msg); },\n    clear() { Logger.clear(); },\n    getText() { return Logger.getAll().join(\"\\n\"); },\n    dump() { return Logger.getAll().join(\"\\n\"); }\n  };\n\n  // -----------------------------\n  // STABILITY CORE ‚Äî Global Error Guard + Fallback UI\n  // -----------------------------\n  const Stability = (() => {\n    let installed = false;\n    let originalConsoleError = null;\n\n    function normalizeErr(e) {\n      try {\n        if (!e) return { message: \"unknown\", stack: \"\" };\n        if (typeof e === \"string\") return { message: e, stack: \"\" };\n        return { message: String(e.message || e), stack: String(e.stack || \"\") };\n      } catch {\n        return { message: \"unknown\", stack: \"\" };\n      }\n    }\n\n    function showErrorScreen(title, details) {\n      try {\n        const root = $(\"#app\");\n        if (!root) return;\n\n        root.innerHTML = `\n          <div style=\"min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;background:#070b12;color:#fff;font-family:system-ui\">\n            <div style=\"max-width:780px;width:100%;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px;background:rgba(255,255,255,.04)\">\n              <div style=\"display:flex;align-items:center;gap:10px;margin-bottom:8px\">\n                <div style=\"font-size:20px\">‚ö†Ô∏è</div>\n                <div style=\"font-weight:900;font-size:18px\">${escapeHtml(title || \"Erro\")}</div>\n              </div>\n              <div style=\"opacity:.9;margin-bottom:10px\">\n                A Factory detectou um erro e abriu esta tela controlada para evitar ‚Äútela branca‚Äù.\n              </div>\n              <pre style=\"white-space:pre-wrap;word-break:break-word;padding:12px;border-radius:10px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);max-height:45vh;overflow:auto\">${escapeHtml(String(details || \"\"))}</pre>\n              <div style=\"display:flex;gap:10px;flex-wrap:wrap;margin-top:12px\">\n                <button id=\"rcfReloadBtn\" style=\"padding:10px 14px;border-radius:10px;border:0;background:#2dd4bf;color:#022; font-weight:800\">Recarregar</button>\n                <button id=\"rcfClearLogsBtn\" style=\"padding:10px 14px;border-radius:10px;border:0;background:#ef4444;color:#fff;font-weight:800\">Limpar logs</button>\n              </div>\n            </div>\n          </div>\n        `;\n\n        const r = $(\"#rcfReloadBtn\");\n        r && r.addEventListener(\"click\", () => location.reload(), { passive: true });\n\n        const c = $(\"#rcfClearLogsBtn\");\n        c && c.addEventListener(\"click\", () => {\n          try { Logger.clear(); } catch {}\n          try { localStorage.removeItem(\"rcf:logs\"); } catch {}\n          alert(\"Logs limpos.\");\n        });\n      } catch {}\n    }\n\n    function install() {\n      if (installed) return;\n      installed = true;\n\n      window.addEventListener(\"error\", (ev) => {\n        try {\n          const msg = ev?.message || \"window.error\";\n          const src = ev?.filename ? ` @ ${ev.filename}:${ev.lineno || 0}:${ev.colno || 0}` : \"\";\n          Logger.write(\"ERR:\", msg + src);\n          if (ev?.error) {\n            const ne = normalizeErr(ev.error);\n            Logger.write(\"ERR.stack:\", ne.stack || \"(no stack)\");\n          }\n        } catch {}\n      });\n\n      window.addEventListener(\"unhandledrejection\", (ev) => {\n        try {\n          const ne = normalizeErr(ev?.reason);\n          Logger.write(\"UNHANDLED:\", ne.message);\n          if (ne.stack) Logger.write(\"UNHANDLED.stack:\", ne.stack);\n        } catch {}\n      });\n\n      try {\n        if (!originalConsoleError) originalConsoleError = console.error.bind(console);\n        console.error = (...args) => {\n          try { Logger.write(\"console.error:\", ...args); } catch {}\n          try { originalConsoleError(...args); } catch {}\n        };\n      } catch {}\n\n      Logger.write(\"stability:\", \"ErrorGuard installed ‚úÖ\");\n    }\n\n    return { install, showErrorScreen };\n  })();\n\n  // -----------------------------\n  // Touch / Tap bind (iOS safe) ‚Äî ‚úÖ FIX DUPLO\n  // -----------------------------\n  function bindTap(el, fn) {\n    if (!el) return;\n    if (el.__rcf_bound__) return;         // ‚úÖ evita bind duplicado\n    el.__rcf_bound__ = true;\n\n    let last = 0;\n\n    const handler = (ev) => {\n      const t = Date.now();\n      if ((t - last) < 350) return;        // ‚úÖ dedupe PARA QUALQUER EVENTO\n      last = t;\n\n      try {\n        if (ev && ev.cancelable) ev.preventDefault();\n        if (ev && typeof ev.stopPropagation === \"function\") ev.stopPropagation();\n      } catch {}\n\n      try { fn(ev); }\n      catch (e) { Logger.write(\"tap err:\", e?.message || e); }\n    };\n\n    try {\n      el.style.pointerEvents = \"auto\";\n      el.style.touchAction = \"manipulation\";\n      el.style.webkitTapHighlightColor = \"transparent\";\n    } catch {}\n\n    // ‚úÖ iOS: se PointerEvent existe, usa S√ì pointerup (n√£o adiciona touchend junto)\n    if (window.PointerEvent) {\n      el.addEventListener(\"pointerup\", handler, { passive: false });\n    } else {\n      el.addEventListener(\"touchend\", handler, { passive: false });\n      el.addEventListener(\"click\", handler, { passive: false });\n    }\n  }\n\n  // -----------------------------\n  // State\n  // -----------------------------\n  const State = {\n    cfg: Storage.get(\"cfg\", { mode: \"safe\", autoApplySafe: true, writeMode: \"modal\" }),\n    apps: Storage.get(\"apps\", []),\n    active: Storage.get(\"active\", { appSlug: null, file: null, view: \"dashboard\" }),\n    pending: Storage.get(\"pending\", { patch: null, source: null })\n  };\n\n  function saveAll() {\n    Storage.set(\"cfg\", State.cfg);\n    Storage.set(\"apps\", State.apps);\n    Storage.set(\"active\", State.active);\n    Storage.set(\"pending\", State.pending);\n  }\n\n  // ‚úÖ exp√µe RCF.state ANTES do init (corrige timing)\n  window.RCF = window.RCF || {};\n  window.RCF.state = State;\n  window.RCF.log = (...a) => Logger.write(...a);\n\n  // =========================================================\n  // ‚úÖ Overrides VFS (localStorage)\n  // =========================================================\n  const OverridesVFS = (() => {\n    const KEY = \"RCF_OVERRIDES_MAP\"; // { \"/path\": \"content\" }\n    const getMap = () => Storage.get(KEY, {});\n    const setMap = (m) => Storage.set(KEY, m || {});\n\n    const norm = (p) => {\n      let x = String(p || \"\").trim();\n      if (!x) return \"\";\n      x = x.split(\"#\")[0].split(\"?\")[0].trim();\n      if (!x.startsWith(\"/\")) x = \"/\" + x;\n      x = x.replace(/\\/{2,}/g, \"/\");\n      return x;\n    };\n\n    function list() {\n      const m = getMap();\n      return Object.keys(m || {}).sort();\n    }\n\n    function read(path) {\n      const p = norm(path);\n      const m = getMap();\n      return (m && p in m) ? String(m[p] ?? \"\") : null;\n    }\n\n    function write(path, content) {\n      const p = norm(path);\n      const m = getMap();\n      m[p] = String(content ?? \"\");\n      setMap(m);\n      return true;\n    }\n\n    function del(path) {\n      const p = norm(path);\n      const m = getMap();\n      if (m && p in m) {\n        delete m[p];\n        setMap(m);\n        return true;\n      }\n      return false;\n    }\n\n    return {\n      listFiles: async () => list(),\n      readFile: async (p) => read(p),\n      writeFile: async (p, c) => write(p, c),\n      deleteFile: async (p) => del(p),\n      _raw: { list, read, write, del, norm }\n    };\n  })();\n\n  window.RCF_OVERRIDES_VFS = OverridesVFS;\n\n  // -----------------------------\n  // UI Shell\n  // -----------------------------\n  function renderShell() {\n    const root = $(\"#app\");\n    if (!root) return;\n    if ($(\"#rcfRoot\")) return;\n\n    root.innerHTML = `\n      <div id=\"rcfRoot\">\n        <header class=\"topbar\">\n          <div class=\"brand\">\n            <div class=\"dot\"></div>\n            <div class=\"brand-text\">\n              <div class=\"title\">RControl Factory</div>\n              <div class=\"subtitle\">Factory interna ‚Ä¢ PWA ‚Ä¢ Offline-first</div>\n            </div>\n            <div class=\"spacer\"></div>\n            <button class=\"btn small\" id=\"btnOpenTools\" type=\"button\">‚öôÔ∏è</button>\n            <div class=\"status-pill\" id=\"statusPill\" style=\"margin-left:10px\">\n              <span class=\"ok\" id=\"statusText\">OK ‚úÖ</span>\n            </div>\n          </div>\n\n          <nav class=\"tabs\">\n            <button class=\"tab\" data-view=\"dashboard\" type=\"button\">Dashboard</button>\n            <button class=\"tab\" data-view=\"newapp\" type=\"button\">New App</button>\n            <button class=\"tab\" data-view=\"editor\" type=\"button\">Editor</button>\n            <button class=\"tab\" data-view=\"generator\" type=\"button\">Generator</button>\n            <button class=\"tab\" data-view=\"agent\" type=\"button\">Agente</button>\n            <button class=\"tab\" data-view=\"settings\" type=\"button\">Settings</button>\n            <button class=\"tab\" data-view=\"admin\" type=\"button\">Admin</button>\n            <button class=\"tab\" data-view=\"diagnostics\" type=\"button\">Diagnostics</button>\n            <button class=\"tab\" data-view=\"logs\" type=\"button\">Logs</button>\n          </nav>\n        </header>\n\n        <main class=\"container views\" id=\"views\">\n\n          <section class=\"view card hero\" id=\"view-dashboard\">\n            <h1>Dashboard</h1>\n            <p>Central do projeto. Selecione um app e comece a editar.</p>\n            <div class=\"status-box\">\n              <div class=\"badge\" id=\"activeAppText\">Sem app ativo ‚úÖ</div>\n              <div class=\"spacer\"></div>\n              <button class=\"btn small\" id=\"btnCreateNewApp\" type=\"button\">Criar App</button>\n              <button class=\"btn small\" id=\"btnOpenEditor\" type=\"button\">Abrir Editor</button>\n              <button class=\"btn small ghost\" id=\"btnExportBackup\" type=\"button\">Backup (JSON)</button>\n            </div>\n\n            <h2 style=\"margin-top:14px\">Apps</h2>\n            <div id=\"appsList\" class=\"apps\"></div>\n          </section>\n\n          <section class=\"view card\" id=\"view-newapp\">\n            <h1>Novo App</h1>\n            <p class=\"hint\">Cria um mini-app dentro da Factory.</p>\n\n            <div class=\"row form\">\n              <input id=\"newAppName\" placeholder=\"Nome do app\" />\n              <input id=\"newAppSlug\" placeholder=\"slug (opcional)\" />\n              <button class=\"btn small\" id=\"btnAutoSlug\" type=\"button\">Auto-slug</button>\n              <button class=\"btn ok\" id=\"btnDoCreateApp\" type=\"button\">Criar</button>\n            </div>\n\n            <pre class=\"mono\" id=\"newAppOut\">Pronto.</pre>\n          </section>\n\n          <section class=\"view card\" id=\"view-editor\">\n            <h1>Editor</h1>\n            <p class=\"hint\">Escolha um arquivo e edite.</p>\n\n            <div class=\"row\">\n              <div class=\"badge\" id=\"editorHead\">Arquivo atual: -</div>\n              <div class=\"spacer\"></div>\n              <button class=\"btn ok\" id=\"btnSaveFile\" type=\"button\">Salvar</button>\n              <button class=\"btn danger\" id=\"btnResetFile\" type=\"button\">Reset</button>\n            </div>\n\n            <div class=\"row\">\n              <div style=\"flex:1;min-width:240px\">\n                <div class=\"hint\">Arquivos</div>\n                <div id=\"filesList\" class=\"files\"></div>\n              </div>\n\n              <div style=\"flex:2;min-width:280px\">\n                <div class=\"editor\">\n                  <div class=\"editor-head\">Conte√∫do</div>\n                  <textarea id=\"fileContent\" spellcheck=\"false\"></textarea>\n                </div>\n              </div>\n            </div>\n\n            <pre class=\"mono\" id=\"editorOut\">Pronto.</pre>\n          </section>\n\n          <section class=\"view card\" id=\"view-generator\">\n            <h1>Generator</h1>\n            <p class=\"hint\">Gera ZIP do app selecionado (stub por enquanto).</p>\n            <div class=\"row\">\n              <button class=\"btn ok\" id=\"btnGenZip\" type=\"button\">Build ZIP</button>\n              <button class=\"btn ghost\" id=\"btnGenPreview\" type=\"button\">Preview</button>\n            </div>\n            <pre class=\"mono\" id=\"genOut\">Pronto.</pre>\n          </section>\n\n          <section class=\"view card\" id=\"view-agent\">\n            <h1>Agente</h1>\n            <p class=\"hint\">Comandos naturais + patchset (fase atual: comandos b√°sicos).</p>\n\n            <div class=\"row cmd\">\n              <input id=\"agentCmd\" placeholder='Ex: create \"Meu App\" meu-app' />\n              <button class=\"btn ok\" id=\"btnAgentRun\" type=\"button\">Executar</button>\n              <button class=\"btn ghost\" id=\"btnAgentClear\" type=\"button\">Ajuda</button>\n            </div>\n\n            <pre class=\"mono\" id=\"agentOut\">Pronto.</pre>\n          </section>\n\n          <section class=\"view card\" id=\"view-settings\">\n            <h1>Settings</h1>\n\n            <div class=\"card\" id=\"settings-security\">\n              <h2>Seguran√ßa</h2>\n              <p class=\"hint\">Define um PIN para liberar a√ß√µes cr√≠ticas no Admin.</p>\n              <div class=\"row\">\n                <input id=\"pinInput\" placeholder=\"Definir PIN (4-8 d√≠gitos)\" inputmode=\"numeric\" />\n                <button class=\"btn ok\" id=\"btnPinSave\" type=\"button\">Salvar PIN</button>\n                <button class=\"btn danger\" id=\"btnPinRemove\" type=\"button\">Remover PIN</button>\n              </div>\n              <pre class=\"mono\" id=\"pinOut\">Pronto.</pre>\n            </div>\n\n            <div class=\"card\" id=\"settings-logs\">\n              <h2>Logs</h2>\n              <div class=\"row\">\n                <button class=\"btn ghost\" id=\"btnLogsRefresh\" type=\"button\">Atualizar</button>\n                <button class=\"btn ok\" id=\"btnLogsCopy\" type=\"button\">Exportar .txt</button>\n                <button class=\"btn danger\" id=\"btnLogsClear\" type=\"button\">Limpar logs</button>\n              </div>\n              <pre class=\"mono small\" id=\"logsOut\">Pronto.</pre>\n            </div>\n          </section>\n\n          <section class=\"view card\" id=\"view-diagnostics\">\n            <h1>Diagnostics</h1>\n            <div class=\"row\">\n              <button class=\"btn ok\" id=\"btnDiagRun\" type=\"button\">Rodar V7 Stability Check</button>\n              <button class=\"btn ghost\" id=\"btnDiagInstall\" type=\"button\">Instalar Guards</button>\n              <button class=\"btn ghost\" id=\"btnDiagScan\" type=\"button\">Scan overlays</button>\n              <button class=\"btn ghost\" id=\"btnDiagTests\" type=\"button\">Run micro-tests</button>\n              <button class=\"btn danger\" id=\"btnDiagClear\" type=\"button\">Limpar</button>\n            </div>\n            <pre class=\"mono\" id=\"diagOut\">Pronto.</pre>\n          </section>\n\n          <section class=\"view card\" id=\"view-logs\">\n            <h1>Logs</h1>\n            <div class=\"row\">\n              <button class=\"btn ghost\" id=\"btnLogsRefresh2\" type=\"button\">Atualizar</button>\n              <button class=\"btn ok\" id=\"btnCopyLogs\" type=\"button\">Copiar</button>\n              <button class=\"btn danger\" id=\"btnClearLogs\" type=\"button\">Limpar</button>\n            </div>\n            <pre class=\"mono small\" id=\"logsViewBox\">Pronto.</pre>\n          </section>\n\n          <section class=\"view card\" id=\"view-admin\">\n            <h1>Admin</h1>\n\n            <div class=\"row\">\n              <button class=\"btn ghost\" id=\"btnAdminDiag\" type=\"button\">Diagnosticar (local)</button>\n              <button class=\"btn danger\" id=\"btnAdminZero\" type=\"button\">Zerar (safe)</button>\n            </div>\n\n            <pre class=\"mono\" id=\"adminOut\">Pronto.</pre>\n\n            <!-- ‚úÖ PADR√ÉO: Painel GitHub vem do /app/js/admin.github.js -->\n            <div class=\"card\" id=\"admin-maint\">\n              <h2>MAINTENANCE ‚Ä¢ Self-Update (M√£e)</h2>\n              <div class=\"row\">\n                <button class=\"btn ghost\" id=\"btnMaeLoad\" type=\"button\">Carregar M√£e</button>\n                <button class=\"btn ok\" id=\"btnMaeCheck\" type=\"button\">Rodar Check</button>\n              </div>\n              <div class=\"row\">\n                <button class=\"btn ok\" id=\"btnMaeUpdate\" type=\"button\">‚¨áÔ∏è Update From GitHub</button>\n                <button class=\"btn danger\" id=\"btnMaeClear\" type=\"button\">üßπ Clear Overrides</button>\n              </div>\n              <pre class=\"mono\" id=\"maintOut\">Pronto.</pre>\n            </div>\n\n            <div class=\"card\" id=\"admin-injector\">\n              <h2>FASE A ‚Ä¢ Scan / Target Map / Injector SAFE</h2>\n              <p class=\"hint\">‚ÄúREAL‚Äù = A (VFS) ‚Üí B (bundle local) ‚Üí C (DOM apenas anchors). Sem GitHub remoto.</p>\n\n              <div class=\"row\" style=\"flex-wrap:wrap;\">\n                <button class=\"btn ok\" id=\"btnScanIndex\" type=\"button\">üîé Scan & Index</button>\n                <button class=\"btn ghost\" id=\"btnGenTargets\" type=\"button\">üß≠ Generate Target Map</button>\n                <button class=\"btn ghost\" id=\"btnRefreshTargets\" type=\"button\">üîÅ Refresh Dropdown</button>\n              </div>\n\n              <pre class=\"mono small\" id=\"scanOut\">Pronto.</pre>\n\n              <div class=\"row form\" style=\"margin-top:10px\">\n                <select id=\"injMode\">\n                  <option value=\"INSERT\">INSERT</option>\n                  <option value=\"REPLACE\">REPLACE</option>\n                  <option value=\"DELETE\">DELETE</option>\n                </select>\n\n                <select id=\"injTarget\"></select>\n\n                <button class=\"btn ghost\" id=\"btnPreviewDiff\" type=\"button\">üëÄ Preview diff</button>\n                <button class=\"btn ok\" id=\"btnApplyInject\" type=\"button\">‚úÖ Apply (SAFE)</button>\n                <button class=\"btn danger\" id=\"btnRollbackInject\" type=\"button\">‚Ü© Rollback</button>\n              </div>\n\n              <div class=\"hint\" style=\"margin-top:10px\">Payload:</div>\n              <textarea id=\"injPayload\" class=\"textarea\" rows=\"8\" spellcheck=\"false\" placeholder=\"Cole aqui o payload para inserir/substituir...\"></textarea>\n\n              <div class=\"hint\" style=\"margin-top:10px\">Preview / Diff:</div>\n              <pre class=\"mono small\" id=\"diffOut\">Pronto.</pre>\n\n              <div class=\"hint\" style=\"margin-top:10px\">Log:</div>\n              <pre class=\"mono small\" id=\"injLog\">Pronto.</pre>\n            </div>\n          </section>\n\n        </main>\n\n        <div class=\"tools\" id=\"toolsDrawer\">\n          <div class=\"tools-head\">\n            <div style=\"font-weight:800\">Ferramentas</div>\n            <button class=\"btn small\" id=\"btnCloseTools\" type=\"button\">Fechar</button>\n          </div>\n          <div class=\"tools-body\">\n            <div class=\"row\">\n              <button class=\"btn ghost\" id=\"btnDrawerLogsRefresh\" type=\"button\">Atualizar logs</button>\n              <button class=\"btn ok\" id=\"btnDrawerLogsCopy\" type=\"button\">Copiar logs</button>\n              <button class=\"btn danger\" id=\"btnDrawerLogsClear\" type=\"button\">Limpar logs</button>\n            </div>\n\n            <div class=\"row\" style=\"margin-top:10px\">\n              <button class=\"btn ghost\" id=\"btnSwClearCache\" type=\"button\">Clear SW Cache</button>\n              <button class=\"btn ghost\" id=\"btnSwUnregister\" type=\"button\">Unregister SW</button>\n              <button class=\"btn ok\" id=\"btnSwRegister\" type=\"button\">Register SW</button>\n            </div>\n\n            <pre class=\"mono small\" id=\"logsBox\">Pronto.</pre>\n          </div>\n        </div>\n\n      </div>\n    `;\n  }\n\n  // -----------------------------\n  // Views\n  // -----------------------------\n  function refreshLogsViews() { Logger._mirrorUI(Logger.getAll()); }\n\n  function setView(name) {\n    if (!name) return;\n\n    State.active.view = name;\n    saveAll();\n\n    $$(\".view\").forEach(v => v.classList.remove(\"active\"));\n    $$(\"[data-view]\").forEach(b => b.classList.remove(\"active\"));\n\n    const id = \"view-\" + String(name).replace(/[^a-z0-9_-]/gi, \"\");\n    const view = document.getElementById(id);\n    if (view) view.classList.add(\"active\");\n\n    $$(`[data-view=\"${name}\"]`).forEach(b => b.classList.add(\"active\"));\n\n    if (name === \"logs\" || name === \"settings\" || name === \"admin\") refreshLogsViews();\n\n    Logger.write(\"view:\", name);\n  }\n\n  function openTools(open) {\n    const d = $(\"#toolsDrawer\");\n    if (!d) return;\n    if (open) d.classList.add(\"open\");\n    else d.classList.remove(\"open\");\n  }\n\n  // -----------------------------\n  // Apps / Editor\n  // -----------------------------\n  function getActiveApp() {\n    if (!State.active.appSlug) return null;\n    return State.apps.find(a => a.slug === State.active.appSlug) || null;\n  }\n\n  function ensureAppFiles(app) {\n    if (!app.files) app.files = {};\n    if (typeof app.files !== \"object\") app.files = {};\n  }\n\n  function renderAppsList() {\n    const box = $(\"#appsList\");\n    if (!box) return;\n\n    if (!State.apps.length) {\n      box.innerHTML = `<div class=\"hint\">Nenhum app salvo ainda.</div>`;\n      return;\n    }\n\n    box.innerHTML = \"\";\n    State.apps.forEach(app => {\n      const row = document.createElement(\"div\");\n      row.className = \"app-item\";\n      row.innerHTML = `\n        <div>\n          <div style=\"font-weight:800\">${escapeHtml(app.name)}</div>\n          <div class=\"hint\">${escapeHtml(app.slug)}</div>\n        </div>\n        <div class=\"row\">\n          <button class=\"btn small\" data-act=\"select\" data-slug=\"${escapeAttr(app.slug)}\" type=\"button\">Selecionar</button>\n          <button class=\"btn small\" data-act=\"edit\" data-slug=\"${escapeAttr(app.slug)}\" type=\"button\">Editor</button>\n        </div>\n      `;\n      box.appendChild(row);\n    });\n\n    $$('[data-act=\"select\"]', box).forEach(btn => {\n      bindTap(btn, () => setActiveApp(btn.getAttribute(\"data-slug\")));\n    });\n    $$('[data-act=\"edit\"]', box).forEach(btn => {\n      bindTap(btn, () => {\n        setActiveApp(btn.getAttribute(\"data-slug\"));\n        setView(\"editor\");\n      });\n    });\n  }\n\n  function renderFilesList() {\n    const box = $(\"#filesList\");\n    if (!box) return;\n\n    const app = getActiveApp();\n    if (!app) {\n      box.innerHTML = `<div class=\"hint\">Selecione um app para ver arquivos.</div>`;\n      return;\n    }\n\n    ensureAppFiles(app);\n    const files = Object.keys(app.files);\n    if (!files.length) {\n      box.innerHTML = `<div class=\"hint\">App sem arquivos.</div>`;\n      return;\n    }\n\n    box.innerHTML = \"\";\n    files.forEach(fname => {\n      const item = document.createElement(\"div\");\n      item.className = \"file-item\" + (State.active.file === fname ? \" active\" : \"\");\n      item.textContent = fname;\n      bindTap(item, () => openFile(fname));\n      box.appendChild(item);\n    });\n  }\n\n  function openFile(fname) {\n    const app = getActiveApp();\n    if (!app) return false;\n\n    ensureAppFiles(app);\n    if (!(fname in app.files)) return false;\n\n    State.active.file = fname;\n    saveAll();\n\n    const head = $(\"#editorHead\");\n    if (head) head.textContent = `Arquivo atual: ${fname}`;\n\n    const ta = $(\"#fileContent\");\n    if (ta) ta.value = String(app.files[fname] ?? \"\");\n\n    renderFilesList();\n    return true;\n  }\n\n  function setActiveApp(slug) {\n    const app = State.apps.find(a => a.slug === slug);\n    if (!app) return false;\n\n    State.active.appSlug = slug;\n    State.active.file = State.active.file || Object.keys(app.files || {})[0] || null;\n    saveAll();\n\n    const text = $(\"#activeAppText\");\n    if (text) textContentSafe(text, `App ativo: ${app.name} (${app.slug}) ‚úÖ`);\n\n    renderAppsList();\n    renderFilesList();\n    if (State.active.file) openFile(State.active.file);\n\n    Logger.write(\"app selected:\", slug);\n    return true;\n  }\n\n  function createApp(name, slugMaybe) {\n    const nameClean = String(name || \"\").trim();\n    if (!nameClean) return { ok: false, msg: \"Nome inv√°lido\" };\n\n    let slug = slugify(slugMaybe || nameClean);\n    if (!slug) return { ok: false, msg: \"Slug inv√°lido\" };\n    if (State.apps.some(a => a.slug === slug)) return { ok: false, msg: \"Slug j√° existe\" };\n\n    const app = {\n      name: nameClean,\n      slug,\n      createdAt: nowISO(),\n      files: {\n        \"index.html\": `<!doctype html><html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"><title>${nameClean}</title></head><body><h1>${nameClean}</h1><script src=\"app.js\"></script></body></html>`,\n        \"styles.css\": `body{font-family:system-ui;margin:0;padding:24px;background:#0b1220;color:#fff}`,\n        \"app.js\": `console.log(\"${nameClean}\");`\n      }\n    };\n\n    State.apps.push(app);\n    saveAll();\n    renderAppsList();\n    setActiveApp(slug);\n\n    return { ok: true, msg: `‚úÖ App criado: ${nameClean} (${slug})` };\n  }\n\n  function saveFile() {\n    const app = getActiveApp();\n    if (!app) return uiMsg(\"#editorOut\", \"‚ö†Ô∏è Sem app ativo.\");\n\n    const fname = State.active.file;\n    if (!fname) return uiMsg(\"#editorOut\", \"‚ö†Ô∏è Sem arquivo ativo.\");\n\n    const ta = $(\"#fileContent\");\n    ensureAppFiles(app);\n    app.files[fname] = ta ? String(ta.value || \"\") : \"\";\n\n    saveAll();\n    uiMsg(\"#editorOut\", \"‚úÖ Arquivo salvo.\");\n    Logger.write(\"file saved:\", app.slug, fname);\n  }\n\n  // -----------------------------\n  // Agent\n  // -----------------------------\n  const Agent = {\n    help() {\n      return [\n        \"AGENT HELP\",\n        \"\",\n        \"Comandos:\",\n        \"- help\",\n        \"- list\",\n        \"- create NOME [SLUG]\",\n        \"- create \\\"NOME COM ESPA√áO\\\" [SLUG]\",\n        \"- select SLUG\",\n        \"- open dashboard | open newapp | open editor | open generator | open agent | open settings | open admin | open logs | open diagnostics\",\n        \"- show\"\n      ].join(\"\\n\");\n    },\n\n    list() {\n      if (!State.apps.length) return \"(vazio)\";\n      return State.apps.map(a => `${a.slug} ‚Äî ${a.name}`).join(\"\\n\");\n    },\n\n    show() {\n      const app = getActiveApp();\n      return [\n        `mode: ${State.cfg.mode}`,\n        `apps: ${State.apps.length}`,\n        `active app: ${app ? `${app.name} (${app.slug})` : \"-\"}`,\n        `active file: ${State.active.file || \"-\"}`,\n        `view: ${State.active.view}`\n      ].join(\"\\n\");\n    },\n\n    route(cmdRaw) {\n      const cmd = String(cmdRaw || \"\").trim();\n      const out = $(\"#agentOut\");\n      if (!cmd) { out && (out.textContent = \"Comando vazio.\"); return; }\n\n      const lower = cmd.toLowerCase();\n\n      if (lower === \"help\") { out && (out.textContent = this.help()); return; }\n      if (lower === \"list\") { out && (out.textContent = this.list()); return; }\n      if (lower === \"show\") { out && (out.textContent = this.show()); return; }\n\n      if (lower.startsWith(\"open \")) {\n        const target = lower.replace(\"open \", \"\").trim();\n        const map = {\n          dashboard: \"dashboard\",\n          newapp: \"newapp\",\n          \"new app\": \"newapp\",\n          editor: \"editor\",\n          generator: \"generator\",\n          agent: \"agent\",\n          settings: \"settings\",\n          admin: \"admin\",\n          logs: \"logs\",\n          diagnostics: \"diagnostics\",\n          diag: \"diagnostics\"\n        };\n        const v = map[target] || target;\n        setView(v);\n        out && (out.textContent = `OK. view=${v}`);\n        return;\n      }\n\n      if (lower.startsWith(\"create \")) {\n        const rest = cmd.replace(/^create\\s+/i, \"\").trim();\n        const qm = rest.match(/^\"([^\"]+)\"\\s*([a-z0-9-]+)?/i);\n        let name = \"\", slug = \"\";\n        if (qm) { name = qm[1].trim(); slug = (qm[2] || \"\").trim(); }\n        else { name = rest; }\n        const r = createApp(name, slug);\n        out && (out.textContent = r.msg);\n        return;\n      }\n\n      if (lower.startsWith(\"select \")) {\n        const slug = slugify(cmd.replace(/^select\\s+/i, \"\").trim());\n        const ok = setActiveApp(slug);\n        out && (out.textContent = ok ? `OK. selecionado: ${slug}` : `Falhou: ${slug}`);\n        return;\n      }\n\n      out && (out.textContent = \"Comando n√£o reconhecido. Use: help\");\n    }\n  };\n\n  // -----------------------------\n  // PIN\n  // -----------------------------\n  const Pin = {\n    key: \"admin_pin\",\n    get() { return Storage.get(this.key, \"\"); },\n    set(pin) { Storage.set(this.key, String(pin || \"\")); },\n    clear() { Storage.del(this.key); }\n  };\n\n  // -----------------------------\n  // SW helpers (safe)\n  // -----------------------------\n  async function swRegister() {\n    try {\n      if (!(\"serviceWorker\" in navigator)) {\n        Logger.write(\"sw:\", \"serviceWorker n√£o suportado\");\n        return { ok: false, msg: \"SW n√£o suportado\" };\n      }\n      // ‚úÖ PATCH: relativo + scope relativo (Pages/subpath safe)\n      const reg = await navigator.serviceWorker.register(\"./sw.js\", { scope: \"./\" });\n      Logger.write(\"sw register:\", \"ok\");\n      return { ok: true, msg: \"SW registrado ‚úÖ\", reg };\n    } catch (e) {\n      Logger.write(\"sw register fail:\", (e?.message || e));\n      return { ok: false, msg: \"Falhou registrar SW: \" + (e?.message || e) };\n    }\n  }\n\n  async function swUnregisterAll() {\n    try {\n      if (!(\"serviceWorker\" in navigator)) return { ok: true, count: 0 };\n      const regs = await navigator.serviceWorker.getRegistrations();\n      let n = 0;\n      for (const r of regs) { try { if (await r.unregister()) n++; } catch {} }\n      Logger.write(\"sw unregister:\", n, \"ok\");\n      return { ok: true, count: n };\n    } catch (e) {\n      Logger.write(\"sw unregister err:\", e?.message || e);\n      return { ok: false, count: 0, err: e?.message || e };\n    }\n  }\n\n  async function swClearCaches() {\n    try {\n      const keys = await caches.keys();\n      await Promise.all(keys.map(k => caches.delete(k)));\n      Logger.write(\"cache clear:\", keys.length, \"caches\");\n      return { ok: true, count: keys.length };\n    } catch (e) {\n      Logger.write(\"cache clear err:\", e?.message || e);\n      return { ok: false, count: 0, err: e?.message || e };\n    }\n  }\n\n  async function swCheckAutoFix() {\n    const out = { ok: false, status: \"missing\", detail: \"\", attempts: 0, err: \"\" };\n\n    if (!(\"serviceWorker\" in navigator)) {\n      out.status = \"unsupported\";\n      out.detail = \"serviceWorker n√£o suportado neste browser\";\n      return out;\n    }\n\n    const tryGet = async () => {\n      try {\n        const a = await navigator.serviceWorker.getRegistration(\"./\");\n        if (a) return a;\n        const b = await navigator.serviceWorker.getRegistration();\n        return b || null;\n      } catch (e) {\n        out.err = String(e?.message || e);\n        return null;\n      }\n    };\n\n    let reg = await tryGet();\n    if (reg) {\n      out.ok = true;\n      out.status = \"registered\";\n      out.detail = \"j√° estava registrado\";\n      return out;\n    }\n\n    out.attempts++;\n    try {\n      const r = await swRegister();\n      out.detail = r?.msg || \"tentou registrar\";\n    } catch (e) {\n      out.err = String(e?.message || e);\n    }\n\n    await new Promise(res => setTimeout(res, 350));\n\n    reg = await tryGet();\n    if (reg) {\n      out.ok = true;\n      out.status = \"registered\";\n      out.detail = \"registrou ap√≥s auto-fix\";\n      return out;\n    }\n\n    out.status = \"missing\";\n    out.detail =\n      (location.protocol !== \"https:\" && location.hostname !== \"localhost\")\n        ? \"SW exige HTTPS (ou localhost).\"\n        : \"sw.js n√£o registrou (pode ser path/scope/privacidade).\";\n\n    return out;\n  }\n\n  // -----------------------------\n  // Overlay scanner (embutido)\n  // -----------------------------\n  function scanOverlays() {\n    const suspects = [];\n    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);\n    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);\n\n    const all = $$(\"body *\");\n    for (const el of all) {\n      try {\n        const cs = getComputedStyle(el);\n        if (!cs) continue;\n        if (cs.pointerEvents === \"none\") continue;\n\n        const pos = cs.position;\n        if (pos !== \"fixed\" && pos !== \"absolute\") continue;\n\n        const zi = parseInt(cs.zIndex || \"0\", 10);\n        if (!Number.isFinite(zi)) continue;\n        if (zi < 50) continue;\n\n        const r = el.getBoundingClientRect();\n        const area = Math.max(0, r.width) * Math.max(0, r.height);\n        if (area < (vw * vh * 0.10)) continue;\n\n        const touches = (r.right > 0 && r.bottom > 0 && r.left < vw && r.top < vh);\n        if (!touches) continue;\n\n        suspects.push({\n          tag: el.tagName.toLowerCase(),\n          id: el.id || \"\",\n          cls: (el.className && String(el.className).slice(0, 80)) || \"\",\n          z: zi,\n          pe: cs.pointerEvents,\n          pos,\n          rect: { x: Math.round(r.x), y: Math.round(r.y), w: Math.round(r.width), h: Math.round(r.height) }\n        });\n      } catch {}\n      if (suspects.length >= 8) break;\n    }\n    return { ok: true, suspects };\n  }\n\n  // -----------------------------\n  // Micro-tests (embutido)\n  // -----------------------------\n  function runMicroTests() {\n    const results = [];\n    const push = (name, pass, info = \"\") => results.push({ name, pass: !!pass, info: String(info || \"\") });\n\n    try { push(\"TEST_RENDER\", !!$(\"#rcfRoot\") && !!$(\"#views\"), !!$(\"#rcfRoot\") ? \"UI root ok\" : \"UI root missing\"); }\n    catch (e) { push(\"TEST_RENDER\", false, e?.message || e); }\n\n    try { push(\"TEST_IMPORTS\", !!window.RCF_LOGGER && !!window.RCF && !!window.RCF.state, \"globals\"); }\n    catch (e) { push(\"TEST_IMPORTS\", false, e?.message || e); }\n\n    try { push(\"TEST_STATE_INIT\", !!State && Array.isArray(State.apps) && !!State.active && typeof State.cfg === \"object\", \"state\"); }\n    catch (e) { push(\"TEST_STATE_INIT\", false, e?.message || e); }\n\n    try { push(\"TEST_EVENT_BIND\", !!$(\"#btnOpenTools\") && !!$(\"#btnAgentRun\") && !!$(\"#btnSaveFile\"), \"buttons\"); }\n    catch (e) { push(\"TEST_EVENT_BIND\", false, e?.message || e); }\n\n    const passCount = results.filter(r => r.pass).length;\n    return { ok: passCount === results.length, pass: passCount, total: results.length, results };\n  }\n\n  // -----------------------------\n  // CSS token check\n  // -----------------------------\n  function cssLoadedCheck() {\n    try {\n      const token = getComputedStyle(document.documentElement)\n        .getPropertyValue(\"--rcf-css-token\")\n        .trim()\n        .replace(/^[\"']|[\"']$/g, \"\");\n      const ok = !!token && token.toLowerCase() !== \"(vazio)\";\n      return { ok, token: token || \"(vazio)\" };\n    } catch (e) {\n      return { ok: false, token: \"(erro)\", err: e?.message || e };\n    }\n  }\n\n  // -----------------------------\n  // Guards flags\n  // -----------------------------\n  const ModuleFlags = { diagnosticsInstalled: false, guardsInstalled: false };\n\n  function installGuardsOnce() {\n    if (ModuleFlags.guardsInstalled) return true;\n    ModuleFlags.guardsInstalled = true;\n    Logger.write(\"ok:\", \"GlobalErrorGuard instalado ‚úÖ\");\n    Logger.write(\"ok:\", \"ClickGuard instalado ‚úÖ\");\n    return true;\n  }\n\n  // -----------------------------\n  // Stability report\n  // -----------------------------\n  async function runV7StabilityCheck() {\n    const lines = [];\n    const failList = [];\n    let pass = 0, fail = 0;\n\n    const add = (ok, label, detail) => {\n      if (ok) { pass++; lines.push(`PASS: ${label}${detail ? \" ‚Äî \" + detail : \"\"}`); }\n      else { fail++; const t = `FAIL: ${label}${detail ? \" ‚Äî \" + detail : \"\"}`; lines.push(t); failList.push(label + (detail ? `: ${detail}` : \"\")); }\n    };\n\n    add(!!window.__RCF_BOOTED__, \"[BOOT] __RCF_BOOTED__\", window.__RCF_BOOTED__ ? \"lock ativo\" : \"lock ausente\");\n\n    const css = cssLoadedCheck();\n    add(css.ok, \"[CSS] CSS_TOKEN\", `token: \"${css.token}\"`);\n\n    add(true, \"[MODULES] CORE_ONCE\", \"ok\");\n    add(ModuleFlags.guardsInstalled, \"[MODULES] GUARDS_ONCE\", ModuleFlags.guardsInstalled ? \"ok\" : \"n√£o instalado\");\n\n    const swr = await swCheckAutoFix();\n    if (swr.ok) {\n      add(true, \"[SW] SW_REGISTERED\", swr.detail || \"registrado\");\n    } else {\n      lines.push(`WARN: [SW] SW_REGISTERED ‚Äî ${swr.detail || swr.status}${swr.err ? \" | err=\" + swr.err : \"\"}`);\n      Logger.write(\"sw warn:\", swr.status, swr.detail, swr.err ? (\"err=\" + swr.err) : \"\");\n    }\n\n    const overlay = scanOverlays();\n    add(overlay.ok, \"[CLICK] OVERLAY_SCANNER\", overlay.ok ? \"ok\" : \"erro\");\n    add((overlay.suspects || []).length === 0, \"[CLICK] OVERLAY_BLOCK\", (overlay.suspects || []).length ? `suspects=${overlay.suspects.length}` : \"nenhum\");\n\n    const mt = runMicroTests();\n    add(mt.ok, \"[MICROTEST] ALL\", `${mt.pass}/${mt.total}`);\n\n    const stable = (fail === 0);\n    window.RCF_STABLE = stable;\n\n    lines.unshift(\"=========================================================\");\n    lines.unshift(\"RCF ‚Äî V7 STABILITY CHECK (REPORT)\");\n    lines.push(\"=========================================================\");\n    lines.push(`PASS: ${pass} | FAIL: ${fail}`);\n    lines.push(`RCF_STABLE: ${stable ? \"TRUE ‚úÖ\" : \"FALSE ‚ùå\"}`);\n    lines.push(\"\");\n\n    if (!stable) {\n      lines.push(\"FAIL LIST:\");\n      for (const f of failList) lines.push(`- ${f}`);\n    } else {\n      lines.push(\"STATUS: RCF_STABLE = TRUE ‚úÖ\");\n    }\n\n    const report = lines.join(\"\\n\");\n    uiMsg(\"#diagOut\", report);\n    Logger.write(\"V7 check:\", stable ? \"PASS ‚úÖ\" : \"FAIL ‚ùå\", `${pass}/${pass + fail}`);\n    return { stable, pass, fail, report, overlay, microtests: mt, css, sw: swr };\n  }\n\n  // =========================================================\n  // ‚úÖ FASE A ‚Äî REAL SCAN / TARGET MAP / INJECT SAFE\n  // =========================================================\n  function simpleHash(str) {\n    let h = 2166136261;\n    const s = String(str ?? \"\");\n    for (let i = 0; i < s.length; i++) {\n      h ^= s.charCodeAt(i);\n      h = (h * 16777619) >>> 0;\n    }\n    return (\"00000000\" + h.toString(16)).slice(-8);\n  }\n\n  function guessType(path) {\n    const p = String(path || \"\");\n    if (p.endsWith(\".js\")) return \"js\";\n    if (p.endsWith(\".css\")) return \"css\";\n    if (p.endsWith(\".html\")) return \"html\";\n    if (p.endsWith(\".json\")) return \"json\";\n    if (p.endsWith(\".txt\")) return \"txt\";\n    return \"bin\";\n  }\n\n  function detectMarkers(text) {\n    const s = String(text ?? \"\");\n    const re = /@RCF:INJECT\\s*([A-Za-z0-9_-]+)?/g;\n    const out = [];\n    let m;\n    while ((m = re.exec(s))) {\n      out.push({ marker: m[0], id: (m[1] || \"\").trim() || null, index: m.index });\n      if (out.length >= 20) break;\n    }\n    return out;\n  }\n\n  function getAnchorsForContent(type, content) {\n    const s = String(content ?? \"\");\n    const anchors = [];\n    if (type === \"html\") {\n      const headEnd = s.toLowerCase().lastIndexOf(\"</head>\");\n      const bodyEnd = s.toLowerCase().lastIndexOf(\"</body>\");\n      if (headEnd >= 0) anchors.push({ id: \"HEAD_END\", at: headEnd, note: \"</head>\" });\n      if (bodyEnd >= 0) anchors.push({ id: \"BODY_END\", at: bodyEnd, note: \"</body>\" });\n    }\n    if (type === \"css\") {\n      const rootIdx = s.indexOf(\":root\");\n      if (rootIdx >= 0) anchors.push({ id: \"CSS_ROOT\", at: rootIdx, note: \":root\" });\n    }\n    if (type === \"js\") {\n      anchors.push({ id: \"JS_TOP\", at: 0, note: \"top\" });\n      anchors.push({ id: \"JS_EOF\", at: s.length, note: \"eof\" });\n    }\n    return anchors;\n  }\n\n  function normalizePath(p) {\n    let x = String(p || \"\").trim();\n    if (!x) return \"\";\n    x = x.split(\"#\")[0].split(\"?\")[0].trim();\n    if (!x.startsWith(\"/\")) x = \"/\" + x;\n    x = x.replace(/\\/{2,}/g, \"/\");\n    return x;\n  }\n\n  async function tryFetchLocalBundleFromCfg() {\n    const cfg = Storage.get(\"ghcfg\", null);\n    const path = cfg && cfg.path ? String(cfg.path) : \"\";\n    if (!path) return null;\n\n    // ‚úÖ PATCH: resolve com baseURI (subpath safe)\n    const url = new URL(path, document.baseURI).toString();\n\n    try {\n      const res = await fetch(url, { cache: \"no-store\" });\n      if (!res.ok) return null;\n      const txt = await res.text();\n      return txt || null;\n    } catch {\n      return null;\n    }\n  }\n\n  async function vfsListAll(vfs) {\n    if (!vfs) return [];\n    try {\n      if (typeof vfs.listFiles === \"function\") return (await vfs.listFiles()) || [];\n      if (typeof vfs.list === \"function\") return (await vfs.list()) || [];\n      if (typeof vfs.keys === \"function\") return (await vfs.keys()) || [];\n      if (typeof vfs.entries === \"function\") {\n        const ent = await vfs.entries();\n        return Array.isArray(ent) ? ent.map(e => e && (e.path || e[0])) : [];\n      }\n    } catch {}\n    return [];\n  }\n\n  async function vfsRead(vfs, path) {\n    if (!vfs) return null;\n    try {\n      if (typeof vfs.readFile === \"function\") return await vfs.readFile(path);\n      if (typeof vfs.read === \"function\") return await vfs.read(path);\n      if (typeof vfs.get === \"function\") return await vfs.get(path);\n    } catch {}\n    return null;\n  }\n\n  function getLocalMotherBundleText() {\n    const raw = Storage.getRaw(\"mother_bundle\", \"\");\n    if (raw && raw.trim().startsWith(\"{\")) return raw;\n    const raw2 = localStorage.getItem(\"RCF_MOTHER_BUNDLE\") || \"\";\n    if (raw2 && raw2.trim().startsWith(\"{\")) return raw2;\n    return \"\";\n  }\n\n  // =========================================================\n  // ‚úÖ CP1 ‚Äî Scan em cascata REAL (A -> B -> C)\n  //   Regra: A com files=0 => FALHA => cai pro B, depois C.\n  //   PATCH: A n√£o ‚Äúmente‚Äù quando s√≥ existem overrides.\n  // =========================================================\n  async function scanFactoryFiles() {\n    const index = {\n      meta: { scannedAt: nowISO(), source: \"\", count: 0 },\n      files: []\n    };\n\n    // 0) sempre indexa overrides (n√£o define source por isso)\n    try {\n      const olist = await OverridesVFS.listFiles();\n      for (const p0 of (olist || []).slice(0, 800)) {\n        const p = normalizePath(p0);\n        const txt = String((await OverridesVFS.readFile(p)) ?? \"\");\n        const type = guessType(p);\n        index.files.push({\n          path: p,\n          type,\n          size: txt.length,\n          hash: simpleHash(txt),\n          markers: detectMarkers(txt),\n          anchors: getAnchorsForContent(type, txt)\n        });\n      }\n    } catch {}\n\n    // A) runtime vfs\n    const vfs = (window.RCF_VFS || window.RCF_FS || window.RCF_VFS_OVERRIDES || window.RCF_FILES || window.RCF_STORE) || null;\n    if (vfs) {\n      // ‚úÖ PATCH: mede quantos foram adicionados PELO runtime VFS (sem contar overrides)\n      const baseLen = index.files.length;\n\n      const list = await vfsListAll(vfs);\n      const paths = (list || []).map(p => normalizePath(p)).filter(Boolean).slice(0, 1200);\n\n      for (const p of paths) {\n        const content = await vfsRead(vfs, p);\n        const txt = (content == null) ? \"\" : String(content);\n        const type = guessType(p);\n        const markers = detectMarkers(txt);\n        const anchors = getAnchorsForContent(type, txt);\n        index.files.push({\n          path: p,\n          type,\n          size: txt.length,\n          hash: simpleHash(txt),\n          markers,\n          anchors\n        });\n      }\n\n      const addedByRuntimeVfs = index.files.length - baseLen;\n\n      if (addedByRuntimeVfs > 0) {\n        index.meta.source = \"A:runtime_vfs\";\n        index.meta.count = index.files.length;\n        Storage.set(\"RCF_FILE_INDEX\", index);\n        Logger.write(\"scan:\", index.meta.source, \"files=\" + index.meta.count);\n        return index;\n      }\n\n      Logger.write(\"scan:\", \"A:runtime_vfs files=0 => FALHA\", \"scan fallback -> mother_bundle\");\n    }\n\n    // B) mother_bundle local\n    let bundleText = getLocalMotherBundleText();\n    if (!bundleText) bundleText = await tryFetchLocalBundleFromCfg();\n\n    if (bundleText) {\n      index.meta.source = \"B:mother_bundle_local\";\n      let parsed = null;\n      try { parsed = JSON.parse(bundleText); } catch { parsed = null; }\n\n      const filesObj =\n        (parsed && parsed.files && typeof parsed.files === \"object\")\n          ? parsed.files\n          : (parsed && typeof parsed === \"object\" ? parsed : {});\n\n      const entries = Object.entries(filesObj || {});\n      for (const [rawPath, rawVal] of entries) {\n        const p = normalizePath(rawPath);\n        const txt = (rawVal && typeof rawVal === \"object\" && \"content\" in rawVal) ? String(rawVal.content ?? \"\") : String(rawVal ?? \"\");\n        const type = guessType(p);\n        const markers = detectMarkers(txt);\n        const anchors = getAnchorsForContent(type, txt);\n        index.files.push({\n          path: p,\n          type,\n          size: txt.length,\n          hash: simpleHash(txt),\n          markers,\n          anchors\n        });\n      }\n\n      index.meta.count = index.files.length;\n      Storage.set(\"RCF_FILE_INDEX\", index);\n      Storage.setRaw(\"mother_bundle\", bundleText);\n\n      Logger.write(\"scan:\", index.meta.source, \"files=\" + index.meta.count);\n      return index;\n    }\n\n    // C) DOM anchors only\n    Logger.write(\"scan fallback -> DOM anchors\");\n    index.meta.source = \"C:dom_anchors_only\";\n    const html = document.documentElement ? document.documentElement.outerHTML : \"\";\n    const markers = detectMarkers(html);\n    const anchors = getAnchorsForContent(\"html\", html);\n\n    index.files.push({\n      path: \"/runtime/document.html\",\n      type: \"html\",\n      size: html.length,\n      hash: simpleHash(html),\n      markers,\n      anchors\n    });\n\n    index.meta.count = index.files.length;\n    Storage.set(\"RCF_FILE_INDEX\", index);\n    Logger.write(\"scan:\", index.meta.source, \"files=\" + index.meta.count);\n    return index;\n  }\n\n  // =========================================================\n  // ‚úÖ CP2 ‚Äî Target map garante >=2\n  //   PATCH: fallback prioriza /index.html (bundle real)\n  // =========================================================\n  function generateTargetMap(fileIndex) {\n    const idx = fileIndex || Storage.get(\"RCF_FILE_INDEX\", null);\n    if (!idx || !Array.isArray(idx.files)) {\n      return { ok: false, err: \"RCF_FILE_INDEX ausente. Rode Scan & Index primeiro.\" };\n    }\n\n    const targets = [];\n\n    for (const f of idx.files) {\n      const path = String(f.path || \"\");\n      const markers = Array.isArray(f.markers) ? f.markers : [];\n\n      for (const m of markers) {\n        const id = m.id ? m.id : `MARKER_${path}_${m.index}`;\n        targets.push({\n          targetId: id,\n          path,\n          kind: \"MARKER\",\n          offset: m.index,\n          supportedModes: [\"INSERT\", \"REPLACE\", \"DELETE\"],\n          defaultRisk: \"low\",\n          note: \"@RCF:INJECT\"\n        });\n      }\n\n      if (!markers.length) {\n        const anchors = Array.isArray(f.anchors) ? f.anchors : [];\n        for (const a of anchors) {\n          targets.push({\n            targetId: `${path}::${a.id}`,\n            path,\n            kind: \"ANCHOR\",\n            offset: a.at,\n            anchorId: a.id,\n            supportedModes: [\"INSERT\", \"REPLACE\", \"DELETE\"],\n            defaultRisk: (String(a.id || \"\").includes(\"BODY\") || String(a.id || \"\").includes(\"JS_EOF\")) ? \"medium\" : \"low\",\n            note: a.note\n          });\n        }\n      }\n    }\n\n    const seen = new Set();\n    const uniq = [];\n    for (const t of targets) {\n      if (!t || !t.targetId) continue;\n      if (seen.has(t.targetId)) continue;\n      seen.add(t.targetId);\n      uniq.push(t);\n      if (uniq.length >= 800) break;\n    }\n\n    // ‚úÖ PATCH fallback: tenta /index.html primeiro\n    if (uniq.length < 2) {\n      const fallbackPaths = [\"/index.html\", \"/app/index.html\"];\n      for (const fp of fallbackPaths) {\n        uniq.push({\n          targetId: `${fp}::HEAD_END`,\n          path: fp,\n          kind: \"ANCHOR\",\n          offset: 0,\n          anchorId: \"HEAD_END\",\n          supportedModes: [\"INSERT\",\"REPLACE\",\"DELETE\"],\n          defaultRisk: \"low\",\n          note: \"FORCED_FALLBACK_HEAD_END\"\n        });\n        uniq.push({\n          targetId: `${fp}::BODY_END`,\n          path: fp,\n          kind: \"ANCHOR\",\n          offset: 0,\n          anchorId: \"BODY_END\",\n          supportedModes: [\"INSERT\",\"REPLACE\",\"DELETE\"],\n          defaultRisk: \"medium\",\n          note: \"FORCED_FALLBACK_BODY_END\"\n        });\n        if (uniq.length >= 2) break;\n      }\n    }\n\n    const out = {\n      meta: { createdAt: nowISO(), count: uniq.length, source: (idx.meta && idx.meta.source) || \"\" },\n      targets: uniq\n    };\n\n    Storage.set(\"RCF_TARGET_MAP\", out);\n    Logger.write(\"targets:\", \"count=\" + out.meta.count, \"source=\" + out.meta.source);\n\n    try { populateTargetsDropdown(true); } catch {}\n    return { ok: true, map: out };\n  }\n\n  // ‚úÖ CP3 helper: preenche dropdown e auto-select\n  function populateTargetsDropdown(autoSelect = false) {\n    const sel = $(\"#injTarget\");\n    if (!sel) return;\n\n    const map = Storage.get(\"RCF_TARGET_MAP\", null);\n    const t = map && Array.isArray(map.targets) ? map.targets : [];\n\n    sel.innerHTML = \"\";\n\n    if (!t.length) {\n      const opt = document.createElement(\"option\");\n      opt.value = \"\";\n      opt.textContent = \"(sem targets ‚Äî gere o map)\";\n      sel.appendChild(opt);\n      return;\n    }\n\n    for (const item of t.slice(0, 500)) {\n      const opt = document.createElement(\"option\");\n      opt.value = item.targetId;\n      opt.textContent = `${item.targetId}  ‚Äî  ${item.path}  (${item.kind})`;\n      sel.appendChild(opt);\n    }\n\n    if (autoSelect) {\n      const first = Array.from(sel.options).find(o => (o.value || \"\").trim());\n      if (first) sel.value = first.value;\n    }\n  }\n\n  function tinyDiff(oldText, newText) {\n    const a = String(oldText ?? \"\").split(\"\\n\");\n    const b = String(newText ?? \"\").split(\"\\n\");\n    const max = Math.max(a.length, b.length);\n    const out = [];\n    for (let i = 0; i < max; i++) {\n      const A = a[i], B = b[i];\n      if (A === B) continue;\n      if (A !== undefined) out.push(`- ${A}`);\n      if (B !== undefined) out.push(`+ ${B}`);\n      if (out.length > 220) { out.push(\"... (diff truncado)\"); break; }\n    }\n    return out.join(\"\\n\") || \"(sem mudan√ßas)\";\n  }\n\n  async function readTextFromInventoryPath(path) {\n    const p = normalizePath(path);\n\n    const ov = await OverridesVFS.readFile(p);\n    if (ov != null) return String(ov);\n\n    const vfs = (window.RCF_VFS || window.RCF_FS || window.RCF_VFS_OVERRIDES || window.RCF_FILES || window.RCF_STORE) || null;\n    if (vfs) {\n      const txt = await vfsRead(vfs, p);\n      return (txt == null) ? \"\" : String(txt);\n    }\n\n    const bundleText = getLocalMotherBundleText() || (await tryFetchLocalBundleFromCfg()) || \"\";\n    if (bundleText) {\n      try {\n        const parsed = JSON.parse(bundleText);\n        const filesObj = (parsed && parsed.files && typeof parsed.files === \"object\") ? parsed.files : parsed;\n        const v = filesObj && filesObj[p];\n        if (v && typeof v === \"object\" && \"content\" in v) return String(v.content ?? \"\");\n        if (v != null) return String(v);\n      } catch {}\n    }\n\n    if (p === \"/runtime/document.html\") {\n      return document.documentElement ? document.documentElement.outerHTML : \"\";\n    }\n\n    // fallback: tenta fetch direto\n    if (p === \"/app/index.html\" || p === \"/app/styles.css\" || p === \"/app/app.js\" || p === \"/index.html\" || p === \"/styles.css\" || p === \"/app.js\") {\n      try {\n        const res = await fetch(p, { cache: \"no-store\" });\n        if (res.ok) return await res.text();\n      } catch {}\n    }\n\n    return \"\";\n  }\n\n  async function writeTextToInventoryPath(path, newText) {\n    const p = normalizePath(path);\n\n    const vfs = (window.RCF_VFS || window.RCF_FS || window.RCF_VFS_OVERRIDES || window.RCF_FILES || window.RCF_STORE) || null;\n    if (vfs) {\n      try {\n        if (typeof vfs.writeFile === \"function\") { await vfs.writeFile(p, String(newText ?? \"\")); return { ok: true, mode: \"vfs.writeFile\" }; }\n        if (typeof vfs.write === \"function\") { await vfs.write(p, String(newText ?? \"\")); return { ok: true, mode: \"vfs.write\" }; }\n        if (typeof vfs.put === \"function\") { await vfs.put(p, String(newText ?? \"\")); return { ok: true, mode: \"vfs.put\" }; }\n        if (typeof vfs.set === \"function\") { await vfs.set(p, String(newText ?? \"\")); return { ok: true, mode: \"vfs.set\" }; }\n      } catch (e) {\n        return { ok: false, err: e?.message || e };\n      }\n    }\n\n    try {\n      await OverridesVFS.writeFile(p, String(newText ?? \"\"));\n      return { ok: true, mode: \"override.writeFile\" };\n    } catch (e) {\n      return { ok: false, err: e?.message || e };\n    }\n  }\n\n  function applyAtTarget(oldText, target, mode, payload) {\n    const s = String(oldText ?? \"\");\n    const pl = String(payload ?? \"\");\n\n    const resolveOffset = () => {\n      if (!target || target.kind !== \"ANCHOR\") return Math.max(0, Math.min(s.length, target.offset || 0));\n      if ((target.offset || 0) > 0) return Math.max(0, Math.min(s.length, target.offset || 0));\n      const lower = s.toLowerCase();\n      if (target.anchorId === \"HEAD_END\") {\n        const i = lower.lastIndexOf(\"</head>\");\n        return i >= 0 ? i : 0;\n      }\n      if (target.anchorId === \"BODY_END\") {\n        const i = lower.lastIndexOf(\"</body>\");\n        return i >= 0 ? i : s.length;\n      }\n      return Math.max(0, Math.min(s.length, target.offset || 0));\n    };\n\n    if (target.kind === \"MARKER\") {\n      const at = Math.max(0, Math.min(s.length, target.offset || 0));\n      if (mode === \"INSERT\") return s.slice(0, at) + pl + \"\\n\" + s.slice(at);\n      if (mode === \"REPLACE\") return s.slice(0, at) + pl + \"\\n\" + s.slice(at);\n      if (mode === \"DELETE\") return s.replace(target.note || \"@RCF:INJECT\", \"\");\n    }\n\n    const at = resolveOffset();\n    if (mode === \"INSERT\") return s.slice(0, at) + \"\\n\" + pl + \"\\n\" + s.slice(at);\n    if (mode === \"REPLACE\") return s.slice(0, at) + \"\\n\" + pl + \"\\n\" + s.slice(at);\n    if (mode === \"DELETE\") {\n      if (!pl.trim()) return s;\n      return s.split(pl).join(\"\");\n    }\n    return s;\n  }\n\n  const InjectState = { lastSnapshot: null };\n\n  async function injectorPreview() {\n    const map = Storage.get(\"RCF_TARGET_MAP\", null);\n    const targets = map && Array.isArray(map.targets) ? map.targets : [];\n    const targetId = ($(\"#injTarget\")?.value || \"\").trim();\n    const mode = ($(\"#injMode\")?.value || \"INSERT\").trim();\n    const payload = ($(\"#injPayload\")?.value || \"\");\n\n    const t = targets.find(x => x.targetId === targetId);\n    if (!t) return { ok: false, err: \"Target inv√°lido (gere o map e selecione).\" };\n\n    const oldText = await readTextFromInventoryPath(t.path);\n    const newText = applyAtTarget(oldText, t, mode, payload);\n\n    uiMsg(\"#diffOut\", tinyDiff(oldText, newText));\n    return { ok: true, oldText, newText, t, mode };\n  }\n\n  async function injectorApplySafe() {\n    const map = Storage.get(\"RCF_TARGET_MAP\", null);\n    const targets = map && Array.isArray(map.targets) ? map.targets : [];\n    Logger.write(\"apply:\", \"targets count=\" + targets.length);\n\n    const pre = await injectorPreview();\n    if (!pre.ok) {\n      uiMsg(\"#diffOut\", \"‚ùå \" + (pre.err || \"preview falhou\"));\n      Logger.write(\"apply:\", \"FAIL target inv√°lido\");\n      return { ok: false };\n    }\n\n    if (!pre.t || !pre.t.targetId) {\n      uiMsg(\"#diffOut\", \"‚ùå target inv√°lido\");\n      Logger.write(\"apply:\", \"FAIL target inv√°lido\");\n      return { ok: false };\n    }\n\n    InjectState.lastSnapshot = {\n      path: pre.t.path,\n      oldText: pre.oldText,\n      newText: pre.newText,\n      targetId: pre.t.targetId,\n      ts: nowISO()\n    };\n\n    const before = runMicroTests();\n    if (!before.ok) {\n      uiMsg(\"#diffOut\", \"‚ùå Microtests BEFORE falharam. Abortando.\\n\" + JSON.stringify(before, null, 2));\n      Logger.write(\"apply:\", \"FAIL microtests before\");\n      return { ok: false };\n    }\n\n    const w = await writeTextToInventoryPath(pre.t.path, pre.newText);\n    if (!w.ok) {\n      uiMsg(\"#diffOut\", \"‚ùå N√£o consegui escrever.\\n\" + (w.err || \"\"));\n      Logger.write(\"apply:\", \"FAIL write\", pre.t.path, pre.t.targetId);\n      return { ok: false };\n    }\n\n    const after = runMicroTests();\n    if (!after.ok) {\n      await writeTextToInventoryPath(pre.t.path, pre.oldText);\n      uiMsg(\"#diffOut\", \"‚ùå Microtests AFTER falharam. Rollback aplicado.\\n\" + JSON.stringify(after, null, 2));\n      Logger.write(\"apply:\", \"AFTER FAIL -> rollback\", pre.t.path, pre.t.targetId);\n      return { ok: false, rolledBack: true };\n    }\n\n    Logger.write(\"apply:\", \"OK\", pre.t.path, pre.t.targetId, \"mode=\" + pre.mode, \"write=\" + w.mode);\n    uiMsg(\"#diffOut\", \"‚úÖ Aplicado com sucesso (SAFE).\");\n    return { ok: true };\n  }\n\n  async function injectorRollback() {\n    const s = InjectState.lastSnapshot;\n    if (!s) { uiMsg(\"#diffOut\", \"Nada para rollback.\"); return { ok: false }; }\n    const w = await writeTextToInventoryPath(s.path, s.oldText);\n    if (!w.ok) { uiMsg(\"#diffOut\", \"Rollback falhou: \" + (w.err || \"\")); return { ok: false }; }\n    uiMsg(\"#diffOut\", \"‚úÖ Rollback aplicado.\");\n    Logger.write(\"inject:\", \"rollback OK\", s.path, s.targetId);\n    return { ok: true };\n  }\n\n  // -----------------------------\n  // Bind UI\n  // -----------------------------\n  function bindUI() {\n    $$(\"[data-view]\").forEach(btn => bindTap(btn, () => setView(btn.getAttribute(\"data-view\"))));\n\n    bindTap($(\"#btnOpenTools\"), () => openTools(true));\n    bindTap($(\"#btnCloseTools\"), () => openTools(false));\n\n    bindTap($(\"#btnCreateNewApp\"), () => setView(\"newapp\"));\n    bindTap($(\"#btnOpenEditor\"), () => setView(\"editor\"));\n\n    bindTap($(\"#btnExportBackup\"), () => {\n      const payload = JSON.stringify({ apps: State.apps, cfg: State.cfg, active: State.active }, null, 2);\n      try { navigator.clipboard.writeText(payload); } catch {}\n      safeSetStatus(\"Backup copiado ‚úÖ\");\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 800);\n      Logger.write(\"backup copied\");\n    });\n\n    bindTap($(\"#btnAutoSlug\"), () => {\n      const n = ($(\"#newAppName\")?.value || \"\");\n      const s = slugify(n);\n      const inSlug = $(\"#newAppSlug\");\n      if (inSlug) inSlug.value = s;\n    });\n\n    bindTap($(\"#btnDoCreateApp\"), () => {\n      const name = ($(\"#newAppName\")?.value || \"\");\n      const slug = ($(\"#newAppSlug\")?.value || \"\");\n      const r = createApp(name, slug);\n      uiMsg(\"#newAppOut\", r.msg);\n      if (r.ok) { setView(\"editor\"); safeSetStatus(\"OK ‚úÖ\"); }\n      else safeSetStatus(\"ERRO ‚ùå\");\n    });\n\n    bindTap($(\"#btnSaveFile\"), () => saveFile());\n\n    bindTap($(\"#btnResetFile\"), () => {\n      const app = getActiveApp();\n      if (!app || !State.active.file) return uiMsg(\"#editorOut\", \"‚ö†Ô∏è Selecione app e arquivo.\");\n      ensureAppFiles(app);\n      app.files[State.active.file] = \"\";\n      saveAll();\n      openFile(State.active.file);\n      uiMsg(\"#editorOut\", \"‚ö†Ô∏è Arquivo resetado (limpo).\");\n    });\n\n    bindTap($(\"#btnGenZip\"), () => uiMsg(\"#genOut\", \"ZIP (stub).\"));\n    bindTap($(\"#btnGenPreview\"), () => uiMsg(\"#genOut\", \"Preview (stub).\"));\n\n    bindTap($(\"#btnAgentRun\"), () => Agent.route($(\"#agentCmd\")?.value || \"\"));\n    bindTap($(\"#btnAgentClear\"), () => uiMsg(\"#agentOut\", Agent.help()));\n\n    const doLogsRefresh = () => {\n      refreshLogsViews();\n      safeSetStatus(\"Logs ‚úÖ\");\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 600);\n    };\n    const doLogsClear = () => {\n      Logger.clear();\n      doLogsRefresh();\n      safeSetStatus(\"Logs limpos ‚úÖ\");\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 600);\n    };\n    const doLogsCopy = async () => {\n      const txt = Logger.getAll().join(\"\\n\");\n      try { await navigator.clipboard.writeText(txt); } catch {}\n      safeSetStatus(\"Logs copiados ‚úÖ\");\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 800);\n    };\n\n    bindTap($(\"#btnLogsRefresh\"), doLogsRefresh);\n    bindTap($(\"#btnLogsClear\"), doLogsClear);\n    bindTap($(\"#btnLogsCopy\"), doLogsCopy);\n\n    bindTap($(\"#btnLogsRefresh2\"), doLogsRefresh);\n    bindTap($(\"#btnClearLogs\"), doLogsClear);\n    bindTap($(\"#btnCopyLogs\"), doLogsCopy);\n\n    bindTap($(\"#btnDrawerLogsRefresh\"), doLogsRefresh);\n    bindTap($(\"#btnDrawerLogsClear\"), doLogsClear);\n    bindTap($(\"#btnDrawerLogsCopy\"), doLogsCopy);\n\n    // SW tools\n    bindTap($(\"#btnSwUnregister\"), async () => {\n      const r = await swUnregisterAll();\n      safeSetStatus(r.ok ? `SW unreg: ${r.count} ‚úÖ` : \"SW unreg ‚ùå\");\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 900);\n    });\n\n    bindTap($(\"#btnSwClearCache\"), async () => {\n      const r = await swClearCaches();\n      safeSetStatus(r.ok ? `Cache: ${r.count} ‚úÖ` : \"Cache ‚ùå\");\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 900);\n    });\n\n    bindTap($(\"#btnSwRegister\"), async () => {\n      const r = await swRegister();\n      safeSetStatus(r.ok ? \"SW ‚úÖ\" : \"SW ‚ùå\");\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 900);\n    });\n\n    // Diagnostics actions\n    bindTap($(\"#btnDiagRun\"), async () => {\n      safeSetStatus(\"Diag‚Ä¶\");\n      await runV7StabilityCheck();\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 700);\n    });\n\n    bindTap($(\"#btnDiagInstall\"), () => {\n      try {\n        installGuardsOnce();\n        ModuleFlags.diagnosticsInstalled = true;\n        uiMsg(\"#diagOut\", \"‚úÖ installAll OK\");\n        Logger.write(\"ok:\", \"Diagnostics: installAll ‚úÖ\");\n      } catch (e) {\n        uiMsg(\"#diagOut\", \"‚ùå \" + (e?.message || e));\n      }\n    });\n\n    bindTap($(\"#btnDiagScan\"), () => {\n      try {\n        const r = scanOverlays();\n        uiMsg(\"#diagOut\", JSON.stringify(r, null, 2));\n      } catch (e) {\n        uiMsg(\"#diagOut\", \"‚ùå \" + (e?.message || e));\n      }\n    });\n\n    bindTap($(\"#btnDiagTests\"), () => {\n      try {\n        const r = runMicroTests();\n        uiMsg(\"#diagOut\", JSON.stringify(r, null, 2));\n      } catch (e) {\n        uiMsg(\"#diagOut\", \"‚ùå \" + (e?.message || e));\n      }\n    });\n\n    bindTap($(\"#btnDiagClear\"), () => uiMsg(\"#diagOut\", \"Pronto.\"));\n\n    // PIN\n    bindTap($(\"#btnPinSave\"), () => {\n      const raw = String($(\"#pinInput\")?.value || \"\").trim();\n      if (!/^\\d{4,8}$/.test(raw)) return uiMsg(\"#pinOut\", \"‚ö†Ô∏è PIN inv√°lido. Use 4 a 8 d√≠gitos.\");\n      Pin.set(raw);\n      uiMsg(\"#pinOut\", \"‚úÖ PIN salvo.\");\n      Logger.write(\"pin saved\");\n    });\n\n    bindTap($(\"#btnPinRemove\"), () => {\n      Pin.clear();\n      uiMsg(\"#pinOut\", \"‚úÖ PIN removido.\");\n      Logger.write(\"pin removed\");\n    });\n\n    // Admin quick\n    bindTap($(\"#btnAdminDiag\"), () => uiMsg(\"#adminOut\", \"Admin OK.\"));\n    bindTap($(\"#btnAdminZero\"), () => {\n      Logger.clear();\n      safeSetStatus(\"Zerado ‚úÖ\");\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 800);\n      uiMsg(\"#adminOut\", \"‚úÖ Zerado (safe). Logs limpos.\");\n    });\n\n    // M√£e buttons\n    bindTap($(\"#btnMaeLoad\"), async () => {\n      const MAE = window.RCF_MOTHER || window.RCF_MAE;\n      if (!MAE) {\n        uiMsg(\"#maintOut\", \"‚ö†Ô∏è RCF_MOTHER/RCF_MAE n√£o est√° carregada no runtime.\");\n        Logger.write(\"mae:\", \"absent\");\n        return;\n      }\n      uiMsg(\"#maintOut\", \"‚úÖ M√£e detectada. Fun√ß√µes: \" + Object.keys(MAE).slice(0, 20).join(\", \"));\n      Logger.write(\"mae:\", \"loaded\");\n    });\n\n    bindTap($(\"#btnMaeCheck\"), () => {\n      const MAE = window.RCF_MOTHER || window.RCF_MAE;\n      const s = MAE && typeof MAE.status === \"function\" ? MAE.status() : { ok: false, msg: \"status() ausente\" };\n      try { alert(\"CHECK:\\n\\n\" + JSON.stringify(s, null, 2)); } catch {}\n      uiMsg(\"#maintOut\", \"Check rodado (alert).\");\n      Logger.write(\"mae check:\", safeJsonStringify(s));\n    });\n\n    // ‚úÖ FIX: trava reentrada + timeout\n    let maeUpdateLock = false;\n    bindTap($(\"#btnMaeUpdate\"), async () => {\n      const MAE = window.RCF_MOTHER || window.RCF_MAE;\n      if (!MAE || typeof MAE.updateFromGitHub !== \"function\") {\n        uiMsg(\"#maintOut\", \"‚ö†Ô∏è updateFromGitHub() ausente (ou m√£e n√£o carregou).\");\n        Logger.write(\"mae update:\", \"missing\");\n        return;\n      }\n      if (maeUpdateLock) {\n        uiMsg(\"#maintOut\", \"‚è≥ Update j√° est√° rodando‚Ä¶ (aguarde)\");\n        Logger.write(\"mae update:\", \"blocked (lock)\");\n        return;\n      }\n\n      maeUpdateLock = true;\n      uiMsg(\"#maintOut\", \"Atualizando‚Ä¶\");\n\n      try {\n        const res = await Promise.race([\n          Promise.resolve(MAE.updateFromGitHub()),\n          new Promise((_, rej) => setTimeout(() => rej(new Error(\"TIMEOUT 15000ms (updateFromGitHub)\")), 15000))\n        ]);\n        uiMsg(\"#maintOut\", \"‚úÖ Update acionado.\");\n        Logger.write(\"mae update:\", \"ok\", res ? safeJsonStringify(res) : \"\");\n      } catch (e) {\n        uiMsg(\"#maintOut\", \"‚ùå Falhou: \" + (e?.message || e));\n        Logger.write(\"mae update err:\", e?.message || e);\n      } finally {\n        maeUpdateLock = false;\n      }\n    });\n\n    bindTap($(\"#btnMaeClear\"), async () => {\n      const MAE = window.RCF_MOTHER || window.RCF_MAE;\n      if (!MAE || typeof MAE.clearOverrides !== \"function\") {\n        uiMsg(\"#maintOut\", \"‚ö†Ô∏è clearOverrides() ausente (ou m√£e n√£o carregou).\");\n        Logger.write(\"mae clear:\", \"missing\");\n        return;\n      }\n      uiMsg(\"#maintOut\", \"Limpando...\");\n      try {\n        await MAE.clearOverrides();\n        uiMsg(\"#maintOut\", \"‚úÖ Clear acionado.\");\n        Logger.write(\"mae clear:\", \"ok\");\n      } catch (e) {\n        uiMsg(\"#maintOut\", \"‚ùå Falhou: \" + (e?.message || e));\n        Logger.write(\"mae clear err:\", e?.message || e);\n      }\n    });\n\n    // ‚úÖ FASE A\n    bindTap($(\"#btnScanIndex\"), async () => {\n      safeSetStatus(\"Scan‚Ä¶\");\n      try {\n        const idx = await scanFactoryFiles();\n        uiMsg(\"#scanOut\", `‚úÖ Scan OK\\nsource=${idx.meta.source}\\nfiles=${idx.meta.count}\\nscannedAt=${idx.meta.scannedAt}`);\n        Logger.write(\"CP1 scan:\", `source=${idx.meta.source}`, `files=${idx.meta.count}`);\n      } catch (e) {\n        uiMsg(\"#scanOut\", \"‚ùå Scan falhou: \" + (e?.message || e));\n        Logger.write(\"scan err:\", e?.message || e);\n      }\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 700);\n    });\n\n    bindTap($(\"#btnGenTargets\"), () => {\n      const idx = Storage.get(\"RCF_FILE_INDEX\", null);\n      const r = generateTargetMap(idx);\n      if (!r.ok) {\n        uiMsg(\"#scanOut\", \"‚ùå \" + (r.err || \"falhou gerar map\"));\n        return;\n      }\n      uiMsg(\"#scanOut\", `‚úÖ Target Map OK\\ncount=${r.map.meta.count}\\nsource=${r.map.meta.source}\\ncreatedAt=${r.map.meta.createdAt}`);\n      Logger.write(\"CP2 targets:\", \"count=\" + r.map.meta.count);\n\n      try {\n        populateTargetsDropdown(true);\n        Logger.write(\"CP3 ui:\", \"dropdown updated\", \"auto-selected=\" + String($(\"#injTarget\")?.value || \"\"));\n      } catch {}\n\n      const sel = $(\"#injTarget\");\n      if (sel && !String(sel.value || \"\").trim()) {\n        const first = Array.from(sel.options).find(o => (o.value || \"\").trim());\n        if (first) sel.value = first.value;\n      }\n    });\n\n    bindTap($(\"#btnRefreshTargets\"), () => {\n      populateTargetsDropdown(true);\n      uiMsg(\"#scanOut\", \"Dropdown atualizado ‚úÖ\");\n      Logger.write(\"CP3 ui:\", \"dropdown refresh\", \"selected=\" + String($(\"#injTarget\")?.value || \"\"));\n    });\n\n    bindTap($(\"#btnPreviewDiff\"), async () => {\n      const r = await injectorPreview();\n      if (!r.ok) uiMsg(\"#diffOut\", \"‚ùå \" + (r.err || \"preview falhou\"));\n    });\n\n    bindTap($(\"#btnApplyInject\"), async () => {\n      safeSetStatus(\"Apply‚Ä¶\");\n      const ok = await injectorApplySafe();\n      Logger.write(\"CP3 apply:\", ok && ok.ok ? \"OK\" : \"FAIL\", \"target=\" + String($(\"#injTarget\")?.value || \"\"));\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 900);\n    });\n\n    bindTap($(\"#btnRollbackInject\"), async () => {\n      safeSetStatus(\"Rollback‚Ä¶\");\n      await injectorRollback();\n      setTimeout(() => safeSetStatus(\"OK ‚úÖ\"), 900);\n    });\n  }\n\n  // -----------------------------\n  // Boot hydrate\n  // -----------------------------\n  function hydrateUIFromState() {\n    refreshLogsViews();\n    renderAppsList();\n\n    const app = getActiveApp();\n    if (app) {\n      setActiveApp(app.slug);\n      if (State.active.file) openFile(State.active.file);\n    } else {\n      const text = $(\"#activeAppText\");\n      if (text) textContentSafe(text, \"Sem app ativo ‚úÖ\");\n    }\n\n    setView(State.active.view || \"dashboard\");\n\n    const pin = Pin.get();\n    if (pin) uiMsg(\"#pinOut\", \"PIN definido ‚úÖ\");\n\n    populateTargetsDropdown(true);\n  }\n\n  async function safeInit() {\n    try {\n      Stability.install();\n      renderShell();\n      bindUI();\n      hydrateUIFromState();\n\n      installGuardsOnce();\n\n      const r = await swRegister();\n      if (!r.ok) Logger.write(\"warn:\", r.msg);\n\n      Logger.write(\"RCF app.js init ok ‚Äî mode:\", State.cfg.mode);\n      safeSetStatus(\"OK ‚úÖ\");\n    } catch (e) {\n      const msg = (e?.message || e);\n      Logger.write(\"FATAL init:\", msg);\n      Stability.showErrorScreen(\"Falha ao iniciar (safeInit)\", String(msg));\n    }\n  }\n\n  if (document.readyState === \"loading\") {\n    document.addEventListener(\"DOMContentLoaded\", () => { safeInit(); }, { passive: true });\n  } else {\n    safeInit();\n  }\n\n})();\n",
      "contentType": "application/javascript; charset=utf-8"
    },
    "/manifest.json": {
      "content": "{\n  \"name\": \"RControl Factory\",\n  \"short_name\": \"RCF\",\n  \"start_url\": \".\",\n  \"display\": \"standalone\",\n  \"background_color\": \"#0b1220\",\n  \"theme_color\": \"#0b1220\",\n  \"icons\": []\n}\n",
      "contentType": "application/json; charset=utf-8"
    },
    "/sw.js": {
      "content": "/* RCF ‚Äî sw.js (SAFE MINIMAL / iOS friendly)\n   - n√£o trava instala√ß√£o se cache falhar\n   - navega√ß√£o: network-first (n√£o prende build velho)\n   - assets: cache-first com fallback network\n*/\n\n\"use strict\";\n\nconst SW_VERSION = \"rcf-sw-v2\"; // <-- MUDE a cada deploy importante\n\nconst CORE_ASSETS = [\n  \"/index.html\",\n  \"/styles.css\",\n  \"/app.js\",\n  \"/manifest.json\",\n  \"/privacy.html\",\n  \"/terms.html\",\n  \"/recovery.html\",\n];\n\n// -------- install\nself.addEventListener(\"install\", (event) => {\n  event.waitUntil((async () => {\n    try {\n      const cache = await caches.open(SW_VERSION);\n      await cache.addAll(CORE_ASSETS);\n    } catch (e) {\n      // n√£o trava instala√ß√£o\n    } finally {\n      self.skipWaiting();\n    }\n  })());\n});\n\n// -------- activate\nself.addEventListener(\"activate\", (event) => {\n  event.waitUntil((async () => {\n    try {\n      const keys = await caches.keys();\n      await Promise.all(keys.map((k) => (k !== SW_VERSION ? caches.delete(k) : null)));\n    } catch {}\n    self.clients.claim();\n  })());\n});\n\nfunction isNavigation(req) {\n  return req.mode === \"navigate\" || req.destination === \"document\";\n}\n\n// -------- fetch\nself.addEventListener(\"fetch\", (event) => {\n  const req = event.request;\n  const url = new URL(req.url);\n\n  // s√≥ mesmo origin\n  if (url.origin !== self.location.origin) return;\n\n  // NAV: network-first\n  if (isNavigation(req)) {\n    event.respondWith((async () => {\n      try {\n        const fresh = await fetch(req);\n        // (opcional) atualiza o index no cache para fallback offline\n        const cache = await caches.open(SW_VERSION);\n        cache.put(\"/index.html\", fresh.clone()).catch(() => {});\n        return fresh;\n      } catch {\n        const cachedNav = await caches.match(req, { ignoreSearch: true });\n        return cachedNav || (await caches.match(\"/index.html\")) || new Response(\"Offline\", { status: 503 });\n      }\n    })());\n    return;\n  }\n\n  // ASSETS: cache-first -> network\n  event.respondWith((async () => {\n    const cached = await caches.match(req, { ignoreSearch: true });\n    if (cached) return cached;\n\n    try {\n      const fresh = await fetch(req);\n      const cache = await caches.open(SW_VERSION);\n      cache.put(req, fresh.clone()).catch(() => {});\n      return fresh;\n    } catch {\n      return new Response(\"\", { status: 504 });\n    }\n  })());\n});\n",
      "contentType": "application/javascript; charset=utf-8"
    },
    "/js/core/vfs_overrides.js": {
      "content": "/* RControl Factory ‚Äî /app/js/core/vfs_overrides.js (PADR√ÉO) ‚Äî v1.2\n   - Corrige sele√ß√£o do Service Worker (scope) mesmo quando document.baseURI engana (iOS / Pages)\n   - Descobre o root real (/app/) pela URL do script carregado (vfs_overrides.js)\n   - Usa getRegistration() do contexto + fallback por getRegistrations()\n   - postMessage com timeout + retry curto (iOS)\n   - API: put(path, content, contentType) + clear()\n*/\n(() => {\n  \"use strict\";\n\n  const SW_TIMEOUT_MS = 6500;\n  const SW_TRIES = 2;\n\n  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }\n\n  function log(lvl, msg){\n    try { window.RCF_LOGGER?.push?.(lvl, msg); } catch {}\n    try { console.log(\"[VFS_OVR]\", lvl, msg); } catch {}\n  }\n\n  function findThisScriptSrc(){\n    // 1) melhor: currentScript\n    try {\n      const s = document.currentScript;\n      if (s && s.src) return s.src;\n    } catch {}\n\n    // 2) fallback: procura pelo script que cont√©m \"vfs_overrides.js\"\n    try {\n      const els = Array.from(document.querySelectorAll('script[src]'));\n      const hit = els.find(x => String(x.src || \"\").includes(\"vfs_overrides.js\"));\n      if (hit && hit.src) return hit.src;\n    } catch {}\n\n    return \"\";\n  }\n\n  function deriveAppRootFromScript(){\n    // Se o script veio de \".../app/js/core/vfs_overrides.js\" ‚Üí root √© \"/app/\"\n    const src = String(findThisScriptSrc() || \"\");\n    try {\n      const u = new URL(src, location.href);\n      const p = u.pathname || \"\";\n      const idx = p.indexOf(\"/app/\");\n      if (idx >= 0) return \"/app/\";\n    } catch {}\n\n    // fallback: tenta por pathname atual\n    if (location.pathname.startsWith(\"/app/\") || location.pathname === \"/app\") return \"/app/\";\n\n    // √∫ltimo fallback\n    return \"/\";\n  }\n\n  const APP_ROOT = deriveAppRootFromScript(); // \"/app/\" ou \"/\"\n  log(\"ok\", `vfs_overrides ready ‚úÖ scope=${APP_ROOT}`);\n\n  async function getActiveSW(){\n    if (!(\"serviceWorker\" in navigator)) return null;\n\n    // 1) se j√° existe controller, usa (mais confi√°vel quando j√° controlando)\n    const ctrl = navigator.serviceWorker.controller;\n    if (ctrl) return ctrl;\n\n    // 2) registration do contexto atual (sem argumento) ‚Äî pega a registration ‚Äúdo cliente‚Äù\n    try {\n      const reg = await navigator.serviceWorker.getRegistration();\n      const sw = reg?.active || reg?.waiting || reg?.installing;\n      if (sw) return sw;\n    } catch {}\n\n    // 3) tenta registration especificamente do root detectado (/app/)\n    try {\n      const reg = await navigator.serviceWorker.getRegistration(APP_ROOT);\n      const sw = reg?.active || reg?.waiting || reg?.installing;\n      if (sw) return sw;\n    } catch {}\n\n    // 4) fallback: procura a melhor registration por prefixo de scope\n    try {\n      const regs = await navigator.serviceWorker.getRegistrations();\n      if (regs && regs.length) {\n        const wantedPrefix = location.origin + APP_ROOT;\n        let best = null;\n\n        for (const r of regs) {\n          const s = String(r?.scope || \"\");\n          if (!s) continue;\n          if (wantedPrefix && s.startsWith(wantedPrefix)) best = r;\n        }\n\n        const pick = best || regs[0];\n        const sw = pick?.active || pick?.waiting || pick?.installing;\n        if (sw) return sw;\n      }\n    } catch {}\n\n    return null;\n  }\n\n  function withTimeout(promise, ms, label){\n    let t;\n    const timeout = new Promise((_, rej) => {\n      t = setTimeout(() => rej(new Error(`TIMEOUT ${ms}ms em ${label}`)), ms);\n    });\n    return Promise.race([promise, timeout]).finally(() => clearTimeout(t));\n  }\n\n  async function postOnce(msg){\n    const sw = await getActiveSW();\n    if (!sw) throw new Error(\"SW n√£o controlando a p√°gina ainda.\");\n\n    return await withTimeout(new Promise((resolve, reject) => {\n      const ch = new MessageChannel();\n      ch.port1.onmessage = (ev) => {\n        const d = ev.data || {};\n        if (d.type?.endsWith(\"_ERR\")) reject(new Error(d.error || \"ERR\"));\n        else resolve(d);\n      };\n      try {\n        sw.postMessage(msg, [ch.port2]);\n      } catch (e) {\n        reject(e);\n      }\n    }), SW_TIMEOUT_MS, msg?.type || \"postMessage\");\n  }\n\n  async function post(msg){\n    let lastErr = null;\n    for (let i = 1; i <= SW_TRIES; i++){\n      try {\n        return await postOnce(msg);\n      } catch (e) {\n        lastErr = e;\n        await sleep(250 * i);\n      }\n    }\n    throw lastErr || new Error(\"post failed\");\n  }\n\n  const api = {\n    async put(path, content, contentType) {\n      await post({ type: \"RCF_OVERRIDE_PUT\", path, content, contentType });\n      return true;\n    },\n\n    async clear() {\n      await post({ type: \"RCF_OVERRIDE_CLEAR\" });\n      return true;\n    }\n  };\n\n  window.RCF_VFS_OVERRIDES = api;\n})();\n",
      "contentType": "application/javascript; charset=utf-8"
    },
    "/js/core/github_sync.js": {
      "content": "/* RControl Factory ‚Äî /app/js/core/github_sync.js (PADR√ÉO) ‚Äî v2.3\n   - GitHub Contents API: GET/PUT file\n   - Storage: rcf:ghcfg\n   - pull(cfg): retorna STRING do bundle JSON v√°lido (ou lan√ßa erro)\n   - push(cfg, content?): se content n√£o vier, gera bundle ‚Äúm√£e‚Äù via fetch local\n   - ‚úÖ Path default CORRETO: \"app/import/mother_bundle.json\"\n   - ‚úÖ Local bundle fetch: new URL('import/mother_bundle.json', document.baseURI)\n   - ‚úÖ Logs claros + valida√ß√£o forte do bundle\n   - ‚úÖ Nunca salva token no bundle\n*/\n(() => {\n  \"use strict\";\n\n  const LS_KEY = \"rcf:ghcfg\";\n\n  const sleep = (ms) => new Promise((r) => setTimeout(r, ms));\n  const nowISO = () => new Date().toISOString();\n\n  function log(msg)  { try { window.RCF_LOGGER?.push?.(\"info\", msg); } catch {} }\n  function warn(msg) { try { window.RCF_LOGGER?.push?.(\"warn\", msg); } catch {} }\n  function err(msg)  { try { window.RCF_LOGGER?.push?.(\"err\", msg); } catch {} }\n\n  function safeParse(raw, fallback) {\n    try { return raw ? JSON.parse(raw) : fallback; } catch { return fallback; }\n  }\n\n  function loadConfig() {\n    return safeParse(localStorage.getItem(LS_KEY), {}) || {};\n  }\n\n  function saveConfig(cfg) {\n    const safe = {\n      owner: String(cfg.owner || \"\").trim(),\n      repo: String(cfg.repo || \"\").trim(),\n      branch: String(cfg.branch || \"main\").trim(),\n      // ‚úÖ default correto dentro de /app\n      path: String(cfg.path || \"app/import/mother_bundle.json\").trim(),\n      token: String(cfg.token || \"\").trim(),\n    };\n    localStorage.setItem(LS_KEY, JSON.stringify(safe));\n    return safe;\n  }\n\n  function requireCfg(cfg, { requireToken = true } = {}) {\n    const c = (cfg && Object.keys(cfg).length) ? cfg : loadConfig();\n\n    if (!c.owner) throw new Error(\"Falta owner\");\n    if (!c.repo) throw new Error(\"Falta repo\");\n    if (!c.branch) throw new Error(\"Falta branch\");\n    if (!c.path) throw new Error(\"Falta path\");\n\n    if (requireToken && !c.token) throw new Error(\"Falta token (PAT)\");\n\n    return {\n      owner: String(c.owner).trim(),\n      repo: String(c.repo).trim(),\n      branch: String(c.branch || \"main\").trim(),\n      path: String(c.path || \"app/import/mother_bundle.json\").trim(),\n      token: String(c.token || \"\").trim(),\n    };\n  }\n\n  function apiUrl(c) {\n    // GitHub Contents API usa path sem / inicial\n    const path = String(c.path || \"\").replace(/^\\/+/, \"\");\n    return `https://api.github.com/repos/${encodeURIComponent(c.owner)}/${encodeURIComponent(c.repo)}/contents/${path}?ref=${encodeURIComponent(c.branch)}`;\n  }\n\n  function headers(c) {\n    return {\n      \"Accept\": \"application/vnd.github+json\",\n      \"Authorization\": `Bearer ${c.token}`,\n      \"X-GitHub-Api-Version\": \"2022-11-28\",\n    };\n  }\n\n  function b64encode(str) {\n    return btoa(unescape(encodeURIComponent(String(str ?? \"\"))));\n  }\n  function b64decode(b64) {\n    return decodeURIComponent(escape(atob(String(b64 || \"\"))));\n  }\n\n  function head80(t) {\n    return String(t || \"\").slice(0, 80).replace(/\\s+/g, \" \").trim();\n  }\n\n  function looksLikeJson(text) {\n    const t = String(text || \"\").trim();\n    if (!t) return false;\n    if (t.startsWith(\"<!DOCTYPE\") || t.startsWith(\"<html\")) return false;\n    return t[0] === \"{\";\n  }\n\n  function assertBundleJson(text) {\n    if (!looksLikeJson(text)) {\n      throw new Error(`bundle n√£o √© JSON (head=\"${head80(text)}\")`);\n    }\n    let j;\n    try { j = JSON.parse(text); }\n    catch (e) {\n      throw new Error(`JSON inv√°lido (${e?.message || e}) head=\"${head80(text)}\"`);\n    }\n    const files = j?.files || null;\n    if (!files || typeof files !== \"object\" || Object.keys(files).length === 0) {\n      throw new Error(`JSON sem \"files\" (ou vazio) head=\"${head80(text)}\"`);\n    }\n    return true;\n  }\n\n  async function getFile(c) {\n    const url = apiUrl(c);\n    const res = await fetch(url, { headers: headers(c) });\n\n    if (res.status === 404) return { exists: false, url };\n\n    if (!res.ok) {\n      const t = await res.text().catch(() => \"\");\n      throw new Error(`GitHub GET falhou: ${res.status} ${head80(t)} url=${url}`);\n    }\n\n    const j = await res.json();\n    if (!j || j.type !== \"file\") throw new Error(\"Resposta inesperada do GitHub (n√£o √© file)\");\n\n    const decoded = b64decode(String(j.content || \"\").replace(/\\n/g, \"\"));\n    return { exists: true, sha: j.sha, content: decoded, url };\n  }\n\n  async function putFile(c, content, sha) {\n    const url = apiUrl(c);\n    const body = {\n      message: `RControl Factory sync ${nowISO()}`,\n      content: b64encode(content),\n      branch: c.branch,\n    };\n    if (sha) body.sha = sha;\n\n    const res = await fetch(url, {\n      method: \"PUT\",\n      headers: { ...headers(c), \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(body),\n    });\n\n    if (!res.ok) {\n      const t = await res.text().catch(() => \"\");\n      throw new Error(`GitHub PUT falhou: ${res.status} ${head80(t)} url=${url}`);\n    }\n    return res.json();\n  }\n\n  async function test(cfg) {\n    const c = requireCfg(cfg, { requireToken: true });\n    await sleep(100);\n    const res = await fetch(`https://api.github.com/user`, { headers: headers(c) });\n    if (!res.ok) throw new Error(\"Token inv√°lido ou sem permiss√£o\");\n    return \"OK: token v√°lido.\";\n  }\n\n  // -----------------------------\n  // Bundle Builder (M√£e)\n  // -----------------------------\n  function guessType(path) {\n    const p = String(path || \"\");\n    if (p.endsWith(\".js\")) return \"application/javascript; charset=utf-8\";\n    if (p.endsWith(\".css\")) return \"text/css; charset=utf-8\";\n    if (p.endsWith(\".html\")) return \"text/html; charset=utf-8\";\n    if (p.endsWith(\".json\")) return \"application/json; charset=utf-8\";\n    return \"text/plain; charset=utf-8\";\n  }\n\n  async function fetchText(pathOrUrl) {\n    const res = await fetch(pathOrUrl, { cache: \"no-store\" });\n    if (!res.ok) throw new Error(`Falhou fetch ${pathOrUrl}: ${res.status}`);\n    return await res.text();\n  }\n\n  // ‚úÖ lista ‚Äúm√£e‚Äù (paths relativos ao ROOT do site, mas a M√£e normaliza pra /app)\n  const DEFAULT_MOTHER_FILES = [\n    \"/index.html\",\n    \"/styles.css\",\n    \"/app.js\",\n    \"/manifest.json\",\n    \"/sw.js\",\n    \"/js/core/vfs_overrides.js\",\n    \"/js/core/github_sync.js\",\n    \"/js/core/mother_selfupdate.js\",\n  ];\n\n  async function buildMotherBundle(fileList = DEFAULT_MOTHER_FILES) {\n    const files = {};\n    for (const path of fileList) {\n      const content = await fetchText(path);\n      files[path] = { content, contentType: guessType(path) };\n    }\n    return JSON.stringify({ files }, null, 2);\n  }\n\n  async function pushMotherBundle(cfg, fileList) {\n    const bundleText = await buildMotherBundle(fileList);\n    return await push(cfg, bundleText);\n  }\n\n  // -----------------------------\n  // ‚úÖ Local bundle fetch (SEM GitHub)\n  // -----------------------------\n  async function pullLocalBundleFromPath(localPath = \"import/mother_bundle.json\") {\n    // baseURI vem do <base href=\"./\"> e aponta pra /app/\n    const u = new URL(String(localPath || \"import/mother_bundle.json\"), document.baseURI);\n    log(`GitHubSync: pullLocal url=${u.toString()}`);\n    const txt = await fetchText(u.toString());\n    assertBundleJson(txt);\n    return txt;\n  }\n\n  // -----------------------------\n  // Public API (pull / push)\n  // -----------------------------\n  async function pull(cfg) {\n    const c = requireCfg(cfg, { requireToken: true });\n\n    log(`GitHub: pull iniciando... path=${c.path}`);\n    const f = await getFile(c);\n\n    if (!f.exists) {\n      throw new Error(`Bundle n√£o existe no repo (404): ${c.path}`);\n    }\n\n    assertBundleJson(f.content);\n\n    log(`GitHub: pull ok (bundle JSON v√°lido). url=${f.url}`);\n    return f.content;\n  }\n\n  async function push(cfg, content) {\n    const c = requireCfg(cfg, { requireToken: true });\n\n    let payload = content;\n    if (payload == null) {\n      warn(\"GitHub: push sem content ‚Üí gerando mother bundle automaticamente...\");\n      payload = await buildMotherBundle();\n    }\n\n    // valida antes de enviar\n    assertBundleJson(payload);\n\n    log(`GitHub: push iniciando... path=${c.path}`);\n    const f = await getFile(c);\n    const sha = f.exists ? f.sha : undefined;\n    await putFile(c, payload, sha);\n    log(\"GitHub: push ok.\");\n    return \"OK: enviado pro GitHub.\";\n  }\n\n  window.RCF_GH_SYNC = {\n    __v: \"v2.3\",\n    saveConfig,\n    loadConfig,\n    test,\n    pull,\n    push,\n    buildMotherBundle,\n    pushMotherBundle,\n    pullLocalBundleFromPath,\n  };\n\n  log(\"github_sync.js loaded (v2.3)\");\n})();\n",
      "contentType": "application/javascript; charset=utf-8"
    },
    "/js/core/mother_selfupdate.js": {
      "content": "/* RControl Factory ‚Äî /app/js/core/mother_selfupdate.js (PADR√ÉO) ‚Äî v1.2\n   - Define a \"M√£e\" corretamente: window.RCF_MAE / window.RCF_MOTHER\n   - MotherRoot = /app (source of truth)\n   - Puxa mother_bundle.json via GitHub Sync (RCF_GH_SYNC.pull)\n   - Salva bundle em localStorage (rcf:mother_bundle)\n   - Aplica arquivos no Overrides VFS (window.RCF_VFS_OVERRIDES) com retry/backoff (iOS)\n   - ‚úÖ Normaliza paths: NUNCA escreve /index.html (sempre /app/index.html)\n   - ‚úÖ clearOverrides: usa clear() se n√£o existir listFiles/deleteFile\n*/\n(() => {\n  \"use strict\";\n\n  if (window.RCF_MAE && window.RCF_MAE.__v12) return;\n\n  const log = (lvl, msg, extra) => {\n    try { window.RCF_LOGGER?.push?.(lvl, String(msg)); } catch {}\n    try { console.log(\"[MAE]\", lvl, msg, extra || \"\"); } catch {}\n  };\n\n  const MOTHER_ROOT = \"/app\";\n\n  const LS_BUNDLE_KEY = \"rcf:mother_bundle\"; // raw JSON text (string)\n  const LS_CFG_KEY    = \"rcf:ghcfg\";         // {owner,repo,branch,path,token}\n\n  const sleep = (ms) => new Promise(r => setTimeout(r, ms));\n\n  function safeParse(raw, fallback) {\n    try { return raw ? JSON.parse(raw) : fallback; } catch { return fallback; }\n  }\n\n  function getCfg() {\n    const cfg = safeParse(localStorage.getItem(LS_CFG_KEY), {}) || {};\n    // ‚úÖ default path agora √© relativo ao /app (com base href ./)\n    // mas se o usu√°rio salvar \"app/import/...\" tamb√©m funciona.\n    return {\n      owner: String(cfg.owner || \"\").trim(),\n      repo: String(cfg.repo || \"\").trim(),\n      branch: String(cfg.branch || \"main\").trim(),\n      path: String(cfg.path || \"import/mother_bundle.json\").trim(),\n      token: String(cfg.token || \"\").trim(),\n    };\n  }\n\n  // ‚úÖ PATCH M√çNIMO (PADR√ÉO): MotherRoot √© /app\n  function normalizeMotherPath(p) {\n    let x = String(p || \"\").trim();\n    if (!x) return \"\";\n    x = x.split(\"#\")[0].split(\"?\")[0].trim();\n\n    if (!x.startsWith(\"/\")) x = \"/\" + x;\n    x = x.replace(/\\/{2,}/g, \"/\");\n\n    // ‚úÖ regra: qualquer \"/index.html\" => \"/app/index.html\"\n    if (x === \"/index.html\") x = \"/app/index.html\";\n    if (x === \"/styles.css\") x = \"/app/styles.css\";\n    if (x === \"/app.js\")     x = \"/app/app.js\";\n    if (x === \"/sw.js\")      x = \"/app/sw.js\";\n    if (x === \"/manifest.json\") x = \"/app/manifest.json\";\n\n    // ‚úÖ se n√£o come√ßa com /app/, empurra pra dentro do MotherRoot\n    if (!x.startsWith(MOTHER_ROOT + \"/\")) {\n      x = (MOTHER_ROOT + (x.startsWith(\"/\") ? x : (\"/\" + x))).replace(/\\/{2,}/g, \"/\");\n    }\n    return x;\n  }\n\n  function getOverridesVFS() {\n    return window.RCF_VFS_OVERRIDES || window.RCF_OVERRIDES_VFS || null;\n  }\n\n  async function writeWithRetry(vfs, path, content, onProgress) {\n    const tries = 4;\n    let lastErr = null;\n\n    for (let i = 0; i < tries; i++) {\n      try {\n        onProgress && onProgress({ step: \"write_try\", i: i + 1, path });\n\n        if (typeof vfs.writeFile === \"function\") {\n          await vfs.writeFile(path, content);\n        } else if (typeof vfs.write === \"function\") {\n          await vfs.write(path, content);\n        } else if (typeof vfs.put === \"function\") {\n          await vfs.put(path, content);\n        } else {\n          throw new Error(\"Overrides VFS sem writeFile/write/put\");\n        }\n\n        onProgress && onProgress({ step: \"write_ok\", i: i + 1, path });\n        return true;\n      } catch (e) {\n        lastErr = e;\n        onProgress && onProgress({ step: \"write_fail\", i: i + 1, path, err: String(e?.message || e) });\n        await sleep(400 + i * 650); // backoff iOS safe\n      }\n    }\n\n    throw (lastErr || new Error(\"write failed\"));\n  }\n\n  function parseBundleToFiles(bundleText) {\n    const parsed = safeParse(bundleText, null);\n    if (!parsed || typeof parsed !== \"object\") return { files: {}, meta: { ok: false } };\n\n    // aceita {files:{...}} OU objeto direto\n    const filesObj = (parsed.files && typeof parsed.files === \"object\") ? parsed.files : parsed;\n\n    const out = {};\n    for (const [rawPath, rawVal] of Object.entries(filesObj || {})) {\n      const normalized = normalizeMotherPath(rawPath);\n      const txt = (rawVal && typeof rawVal === \"object\" && \"content\" in rawVal)\n        ? String(rawVal.content ?? \"\")\n        : String(rawVal ?? \"\");\n      if (normalized) out[normalized] = txt;\n    }\n\n    return { files: out, meta: { ok: true, count: Object.keys(out).length } };\n  }\n\n  async function pullBundleFromGitHub(cfg) {\n    if (!window.RCF_GH_SYNC || typeof window.RCF_GH_SYNC.pull !== \"function\") {\n      throw new Error(\"RCF_GH_SYNC.pull ausente (js/core/github_sync.js)\");\n    }\n    const txt = await window.RCF_GH_SYNC.pull(cfg);\n    if (!txt || String(txt).trim().length < 10) throw new Error(\"bundle vazio (pull retornou vazio)\");\n    return String(txt);\n  }\n\n  async function updateFromGitHub(opts = {}) {\n    const cfg = getCfg();\n    const onProgress = typeof opts.onProgress === \"function\" ? opts.onProgress : null;\n\n    if (!cfg.owner || !cfg.repo) throw new Error(\"ghcfg incompleto (owner/repo)\");\n\n    onProgress && onProgress({\n      step: \"start\",\n      cfg: { owner: cfg.owner, repo: cfg.repo, branch: cfg.branch, path: cfg.path }\n    });\n\n    log(\"ok\", \"update start\", `${cfg.owner}/${cfg.repo}@${cfg.branch} path=${cfg.path}`);\n\n    // 1) pull bundle\n    const bundleText = await pullBundleFromGitHub(cfg);\n    localStorage.setItem(LS_BUNDLE_KEY, bundleText);\n    onProgress && onProgress({ step: \"bundle_saved\", bytes: bundleText.length });\n\n    // 2) parse\n    const parsed = parseBundleToFiles(bundleText);\n    if (!parsed.meta.ok || parsed.meta.count < 1) throw new Error(\"bundle parse falhou ou sem arquivos\");\n\n    // 3) apply to overrides vfs\n    const vfs = getOverridesVFS();\n    if (!vfs) throw new Error(\"Overrides VFS ausente (js/core/vfs_overrides.js)\");\n\n    let paths = Object.keys(parsed.files);\n\n    // ordem: primeiro /app/index.html /app/app.js /app/styles.css (reduz chance de ‚Äútela branca‚Äù)\n    const prio = (p) => (\n      p === \"/app/index.html\" ? 0 :\n      p === \"/app/app.js\"     ? 1 :\n      p === \"/app/styles.css\" ? 2 : 9\n    );\n    paths.sort((a, b) => prio(a) - prio(b));\n\n    onProgress && onProgress({ step: \"apply_begin\", count: paths.length });\n\n    let wrote = 0;\n    for (const originalPath of paths) {\n      const content = parsed.files[originalPath];\n\n      // ‚úÖ normaliza SEMPRE e loga o de->para\n      const safePath = normalizeMotherPath(originalPath);\n      if (safePath !== originalPath) {\n        log(\"info\", `path normalized: ${originalPath} -> ${safePath}`);\n      }\n\n      // ‚úÖ prote√ß√£o final: nunca escrever fora de /app/\n      if (!safePath.startsWith(\"/app/\")) {\n        log(\"warn\", \"skip (outside /app): \" + safePath);\n        continue;\n      }\n\n      await writeWithRetry(vfs, safePath, content, onProgress);\n      wrote++;\n      if (wrote % 10 === 0 || wrote === paths.length) {\n        onProgress && onProgress({ step: \"apply_progress\", done: wrote, total: paths.length });\n      }\n    }\n\n    onProgress && onProgress({ step: \"apply_done\", done: wrote, total: paths.length });\n    log(\"ok\", \"update done\", `wrote=${wrote}`);\n\n    return { ok: true, wrote, failed: 0 };\n  }\n\n  // ‚úÖ Clear robusto: se vfs s√≥ tem clear(), usa clear()\n  async function clearOverrides() {\n    const vfs = getOverridesVFS();\n    if (!vfs) throw new Error(\"Overrides VFS ausente\");\n\n    if (typeof vfs.clear === \"function\") {\n      await vfs.clear();\n      log(\"ok\", \"clearOverrides ok\", \"via clear()\");\n      return { ok: true, mode: \"clear()\", count: null };\n    }\n\n    // fallback caso algum VFS mais completo exista\n    if (typeof vfs.listFiles === \"function\" && typeof vfs.deleteFile === \"function\") {\n      const list = await vfs.listFiles();\n      let n = 0;\n      for (const p of list || []) { try { await vfs.deleteFile(p); n++; } catch {} }\n      log(\"ok\", \"clearOverrides ok\", `count=${n}`);\n      return { ok: true, mode: \"listFiles+deleteFile\", count: n };\n    }\n\n    throw new Error(\"Overrides VFS sem clear() e sem listFiles/deleteFile\");\n  }\n\n  function status() {\n    const cfg = getCfg();\n    const hasSync = !!(window.RCF_GH_SYNC && typeof window.RCF_GH_SYNC.pull === \"function\");\n    const vfs = getOverridesVFS();\n    const hasVfs = !!vfs;\n\n    const bundleLen = (localStorage.getItem(LS_BUNDLE_KEY) || \"\").length;\n\n    return {\n      ok: true,\n      v: \"v1.2\",\n      motherRoot: MOTHER_ROOT,\n      hasSync,\n      hasOverridesVFS: hasVfs,\n      overridesKind: vfs ? (typeof vfs.put === \"function\" ? \"RCF_VFS_OVERRIDES.put\" : \"custom\") : \"absent\",\n      bundleSize: bundleLen,\n      cfg: {\n        owner: cfg.owner,\n        repo: cfg.repo,\n        branch: cfg.branch,\n        path: cfg.path,\n        token: cfg.token ? \"set\" : \"empty\"\n      }\n    };\n  }\n\n  window.RCF_MAE = {\n    __v12: true,\n    motherRoot: MOTHER_ROOT,\n    normalizeMotherPath,\n    updateFromGitHub,\n    clearOverrides,\n    status\n  };\n  window.RCF_MOTHER = window.RCF_MAE; // alias\n\n  log(\"ok\", \"mother_selfupdate.js ready ‚úÖ\", \"v1.2\");\n})();\n",
      "contentType": "application/javascript; charset=utf-8"
    }
  }
}